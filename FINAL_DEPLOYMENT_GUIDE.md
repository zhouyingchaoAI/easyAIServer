# EasyDarwin 最终部署指南

**日期**: 2025-11-04  
**最终版本**: v8.3.7  
**状态**: ✅ 所有功能完成

---

## 🎯 完整功能清单

### 1. 调用次数精确统计 ✅
- 只统计推理成功的调用
- 失败的调用不计入统计
- 支持千位分隔符显示

### 2. 服务状态管理 ✅
- 服务状态完全由心跳决定
- 推理失败不影响服务状态
- 心跳超时10秒自动注销

### 3. 智能加权负载均衡 ✅
- **保证公平性**：每个服务都能获得请求（最小权重=1）
- **性能优化**：根据响应时间动态调整权重
- **即时生效**：性能变化立即反映到分配策略
- **权重公式**：weight = max(1, min(100, 1000 / 响应时间(ms)))

### 4. 新服务即时参与 ✅
- 服务重新上线立即获得请求
- 新服务默认权重10，快速收集性能数据
- 根据性能自动调整权重

### 5. 性能指标显示 ✅
- 推理时间（最近一次）
- 总耗时（最近一次）
- 平均耗时（动态颜色）
- 累积调用次数

### 6. 心跳携带统计 ✅
- 支持算法服务上报性能统计
- total_requests: 累积推理次数
- avg_inference_time_ms: 平均推理时间
- last_inference_time_ms: 最近一次推理时间
- last_total_time_ms: 最近一次总耗时

### 7. 抽帧管理界面优化 ✅
- 手动刷新按钮
- 配置保存后自动刷新
- 配置状态回显
- 从MinIO加载配置并显示

### 8. 负载均衡监控 ✅
- 实时显示权重分配
- 分配比例可视化（进度条）
- 按任务类型分组
- 自动刷新（3秒间隔）

---

## 📊 负载均衡策略详解

### 加权轮询算法（WRR）

```
权重计算：
  weight = max(1, min(100, 1000 / 平均响应时间(ms)))

实例：
┌──────────┬────────┬────────┬──────────┬──────────┐
│ 服务     │ 响应   │ 权重   │ 分配比例 │ 请求次数 │
├──────────┼────────┼────────┼──────────┼──────────┤
│ 服务A    │ 50ms   │ 20     │ 54.1%    │ 541次    │
│ 服务B    │ 100ms  │ 10     │ 27.0%    │ 270次    │
│ 服务C    │ 200ms  │ 5      │ 13.5%    │ 135次    │
│ 服务D    │ 500ms  │ 2      │ 5.4%     │ 54次     │
├──────────┼────────┼────────┼──────────┼──────────┤
│ 总计     │ -      │ 37     │ 100%     │ 1000次   │
└──────────┴────────┴────────┴──────────┴──────────┘

✅ 每个服务都有请求
✅ 快速服务分配更多
✅ 慢速服务也能参与
```

---

## 🚀 部署步骤

### 方式1：使用部署脚本
```bash
cd /code/EasyDarwin
./deploy_new_version.sh
```

### 方式2：手动部署
```bash
cd /code/EasyDarwin

# 1. 停止服务
pkill easydarwin

# 2. 备份（可选）
cp easydarwin easydarwin.bak.$(date +%Y%m%d)

# 3. 替换新版本
cp easydarwin_fixed easydarwin
chmod +x easydarwin

# 4. 启动服务
./easydarwin

# 5. 验证
curl http://localhost:5066/api/v1/version
```

---

## ✅ 验证清单

### 基础功能
- [ ] 服务启动成功
- [ ] Web界面可访问
- [ ] API正常响应

### 抽帧管理（http://localhost:5066/frame-extractor）
- [ ] 任务列表有"刷新列表"按钮
- [ ] 点击刷新显示加载动画
- [ ] 配置状态正确显示
- [ ] 点击"算法配置"能回显已有配置

### 算法服务列表（http://localhost:5066/alerts/services）
- [ ] 显示性能指标列
- [ ] 推理时间、总耗时、平均耗时正确显示
- [ ] 平均耗时有动态颜色
- [ ] 自动刷新（30秒）

### 抽帧监控（http://localhost:5066/frame-extractor/monitor）
- [ ] 显示"负载均衡策略"卡片
- [ ] 标签显示"加权轮询（WRR）"
- [ ] 按任务类型分组显示
- [ ] 显示权重、分配比例、调用次数
- [ ] 分配比例进度条颜色正确
- [ ] 自动刷新（3秒）

### 负载均衡验证
- [ ] 日志显示加权轮询选择
- [ ] 快速服务获得更多请求
- [ ] 慢速服务仍有请求
- [ ] 调用次数符合分配比例

---

## 📁 完整文件清单

### 文档
1. ✅ `FINAL_DEPLOYMENT_GUIDE.md` - **最终部署指南**（本文档）
2. ✅ `LOAD_BALANCE_MONITOR_FEATURE.md` - 负载均衡监控功能
3. ✅ `DEPLOYMENT_SUMMARY_2025-11-04.md` - 完整部署总结
4. ✅ `ALGORITHM_SERVICE_PERFORMANCE_METRICS.md` - 性能指标功能

### 代码
5. ✅ `easydarwin_fixed` - 编译好的后端程序
6. ✅ `web/` - 编译好的前端文件
7. ✅ `deploy_new_version.sh` - 自动部署脚本
8. ✅ `algorithm_service_with_stats_example.py` - Python示例

### 修改的源码
9. `internal/plugin/aianalysis/registry.go` - 加权轮询算法
10. `internal/web/api/ai_analysis.go` - 负载均衡API
11. `internal/conf/model.go` - 性能统计字段
12. `web-src/src/views/frame-extractor/monitor.vue` - 监控界面
13. `web-src/src/views/frame-extractor/index.vue` - 抽帧管理界面
14. `web-src/src/views/alerts/services.vue` - 服务列表界面
15. `web-src/src/api/alert.js` - API封装

---

## 🎨 界面预览

### 负载均衡监控界面

```
┌──────────────────────────────────────────────────────────────┐
│ 📊 抽帧服务监控        [自动刷新] [3秒▼] [刷新] [清零统计] │
├──────────────────────────────────────────────────────────────┤
│ 🎯 负载均衡策略                      [加权轮询（WRR）]      │
├──────────────────────────────────────────────────────────────┤
│ 📌 人数统计 | 3个服务 | 总权重: 35                          │
├──────────────────────────────────────────────────────────────┤
│ 端点           │平均响应│权重│分配比例           │调用次数 │
│ 172.16.5.207:7901│✅50ms │ 20 │████████░ 57.1%    │  571  │
│ 172.16.5.207:7902│🔵100ms│ 10 │████░░░░░ 28.6%    │  286  │
│ 172.16.5.207:7903│🟠200ms│  5 │██░░░░░░░ 14.3%    │  143  │
├──────────────────────────────────────────────────────────────┤
│ ℹ️ 权重计算：weight = 1000 / 响应时间(ms)                  │
│    最小权重1（保证每个服务都有请求），最大权重100          │
└──────────────────────────────────────────────────────────────┘
```

---

## 💡 使用建议

### 日常监控

1. **访问监控页面**
   ```
   http://localhost:5066/frame-extractor/monitor
   ```

2. **观察指标**
   - 分配比例是否合理
   - 快速服务是否分配更多
   - 慢速服务是否仍有请求
   - 调用次数是否符合比例

3. **性能问题排查**
   ```
   发现某服务分配比例突然下降
     ↓
   查看平均响应时间
     ↓
   如果响应时间增加
     ↓
   检查该服务的负载或硬件
   ```

### 容量规划

```
根据监控数据：
  总权重 = 35
  平均响应 = (50*20 + 100*10 + 200*5) / 35 = 85.7ms
  
理论容量：
  单次推理 = 85.7ms
  每秒处理 = 1000 / 85.7 ≈ 11.7次
  总容量(3服务) = 11.7 * 3 = 35.1次/秒 = 2106次/分钟
  
实际需求：
  当前调用 = 1000次/分钟
  容量使用率 = 1000 / 2106 = 47.5%
  
结论：容量充足
```

---

## 📋 快速启动

```bash
# 1. 部署
cd /code/EasyDarwin
./deploy_new_version.sh

# 2. 访问页面
# http://localhost:5066

# 3. 查看监控
# http://localhost:5066/frame-extractor/monitor

# 4. 查看日志
tail -f ./build/*/logs/*.log | grep -E "load balance|weighted"
```

---

## 🎉 完成总结

### 本次会话完成的所有修复和功能

| # | 功能 | 状态 |
|---|------|------|
| 1 | 调用次数精确统计 | ✅ |
| 2 | 服务状态心跳管理 | ✅ |
| 3 | JSON类型兼容性 | ✅ |
| 4 | 加权负载均衡（保证公平性）| ✅ |
| 5 | 新服务即时参与 | ✅ |
| 6 | 任务列表刷新 | ✅ |
| 7 | 配置回显 | ✅ |
| 8 | 性能指标显示 | ✅ |
| 9 | 心跳携带统计 | ✅ |
| 10| 负载均衡监控界面 | ✅ |

### 核心特性

✅ **公平性保证**：最小权重=1，每个服务都有请求  
✅ **性能优化**：响应越快，权重越高，分配越多  
✅ **可视化监控**：实时查看权重、分配比例、调用次数  
✅ **自动适应**：性能变化自动调整分配策略  

### 编译状态
- ✅ 后端编译完成（easydarwin_fixed）
- ✅ 前端编译完成（web/）
- ✅ 文件已复制到运行目录
- ✅ 无linter错误

---

**现在可以部署了！运行 `./deploy_new_version.sh` 即可启动新版本。**

