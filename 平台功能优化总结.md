# å¹³å°åŠŸèƒ½ä¼˜åŒ–æ€»ç»“

## âœ… å·²å®Œæˆçš„å¹³å°åŠŸèƒ½ä¼˜åŒ–

### 1. ç®—æ³•æœåŠ¡è‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½

**æ–‡ä»¶**: `internal/plugin/aianalysis/registry.go`, `internal/web/api/ai_analysis.go`

**åŠŸèƒ½**:
- âœ… APIç«¯ç‚¹: `POST /api/v1/ai_analysis/register`
- âœ… æ¥æ”¶ç®—æ³•æœåŠ¡æ³¨å†Œè¯·æ±‚
- âœ… éªŒè¯å¿…å¡«å­—æ®µï¼ˆservice_id, endpoint, task_typesï¼‰
- âœ… æŒ‰ä»»åŠ¡ç±»å‹åˆ†ç±»å­˜å‚¨
- âœ… æ”¯æŒåŒendpointè¦†ç›–æ—§æ³¨å†Œ
- âœ… è¯¦ç»†çš„æ³¨å†Œæ—¥å¿—ï¼ˆåŒ…å«æ€»æœåŠ¡æ•°ï¼‰

**æ—¥å¿—ç¤ºä¾‹**:
```
algorithm service registered successfully
  service_id=head_detector_7902
  name=YOLOv11xäººå¤´æ£€æµ‹ç®—æ³•-7902
  endpoint=http://172.16.5.207:7902/infer
  version=2.1.0
  total_services=5
```

### 2. æœåŠ¡æ–­å¼€è‡ªåŠ¨æ¸…ç†åŠŸèƒ½

**æ–‡ä»¶**: `internal/plugin/aianalysis/registry.go`

**åŠŸèƒ½**:
- âœ… å¿ƒè·³æ£€æµ‹å™¨ï¼šæ¯30ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
- âœ… è¶…æ—¶æ¸…ç†ï¼š90ç§’æ— å¿ƒè·³è‡ªåŠ¨æ³¨é”€
- âœ… è¯¦ç»†çš„æ¸…ç†æ—¥å¿—
- âœ… æ¸…ç†åè§¦å‘å›è°ƒé€šçŸ¥
- âœ… ç»Ÿè®¡æŠ¥å‘Šï¼ˆæ¸…ç†æ•°é‡ã€å­˜æ´»æ•°é‡ï¼‰

**æ—¥å¿—ç¤ºä¾‹**:
```
algorithm service expired - auto removing
  service_id=test_service
  endpoint=http://172.16.5.207:7902/infer
  task_type=äººæ•°ç»Ÿè®¡
  heartbeat_age_sec=95
  timeout_threshold_sec=90

heartbeat check completed - services expired
  total_alive=4
  total_expired=1
```

### 3. å¿ƒè·³ç»´æŒåŠŸèƒ½

**æ–‡ä»¶**: `internal/plugin/aianalysis/registry.go`, `internal/web/api/ai_analysis.go`

**åŠŸèƒ½**:
- âœ… APIç«¯ç‚¹: `POST /api/v1/ai_analysis/heartbeat/:id`
- âœ… æ”¯æŒæŒ‰service_idæˆ–endpointæ›´æ–°
- âœ… æ›´æ–°last_heartbeatæ—¶é—´æˆ³
- âœ… å¿ƒè·³æ¥æ”¶æ—¥å¿—ï¼ˆdebugçº§åˆ«ï¼‰

**æ—¥å¿—ç¤ºä¾‹**:
```
heartbeat received
  service_id=head_detector_7902
  endpoint=http://172.16.5.207:7902/infer
```

### 4. å¥åº·çŠ¶æ€æŠ¥å‘Š

**æ–‡ä»¶**: `internal/plugin/aianalysis/registry.go`

**åŠŸèƒ½**:
- âœ… æ¯5åˆ†é’Ÿè‡ªåŠ¨è¾“å‡ºä¸€æ¬¡å¥åº·æŠ¥å‘Š
- âœ… æ˜¾ç¤ºæ€»æœåŠ¡æ•°
- âœ… æŒ‰ä»»åŠ¡ç±»å‹ç»Ÿè®¡
- âœ… æ¯ä¸ªæœåŠ¡çš„å¿ƒè·³å¹´é¾„å’Œè°ƒç”¨æ¬¡æ•°

**æ—¥å¿—ç¤ºä¾‹**:
```
algorithm services health report
  total_services=5
  task_type_distribution={"äººæ•°ç»Ÿè®¡":5, "å®¢æµåˆ†æ":5, "äººå¤´æ£€æµ‹":5}

  service status
    service_id=head_detector_7902
    endpoint=http://172.16.5.207:7902/infer
    heartbeat_age_sec=25
    call_count=528
```

### 5. æ³¨é”€å›è°ƒæœºåˆ¶

**æ–‡ä»¶**: `internal/plugin/aianalysis/service.go`

**åŠŸèƒ½**:
- âœ… æœåŠ¡ä¸‹çº¿æ—¶è§¦å‘å›è°ƒ
- âœ… è®°å½•ä¸‹çº¿åŸå› ï¼ˆheartbeat_timeout/manualï¼‰
- âœ… å¯æ‰©å±•ï¼šæœªæ¥å¯æ·»åŠ è‡ªåŠ¨ä»»åŠ¡æš‚åœç­‰é€»è¾‘

**æ—¥å¿—ç¤ºä¾‹**:
```
algorithm service offline
  service_id=test_service
  reason=heartbeat_timeout
```

---

## ğŸ¯ å·¥ä½œæœºåˆ¶

### å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EasyDarwin Platform                       â”‚
â”‚                                                              â”‚
â”‚  æ³¨å†Œä¸­å¿ƒ (AlgorithmRegistry)                                 â”‚
â”‚  â”œâ”€ æœåŠ¡æ³¨å†Œ (/api/v1/ai_analysis/register)                  â”‚
â”‚  â”œâ”€ å¿ƒè·³æ¥æ”¶ (/api/v1/ai_analysis/heartbeat/:id)            â”‚
â”‚  â”œâ”€ æœåŠ¡æ³¨é”€ (/api/v1/ai_analysis/unregister/:id)           â”‚
â”‚  â””â”€ æœåŠ¡æŸ¥è¯¢ (/api/v1/ai_analysis/services)                  â”‚
â”‚                                                              â”‚
â”‚  è‡ªåŠ¨æ£€æµ‹æœºåˆ¶                                                 â”‚
â”‚  â”œâ”€ å¿ƒè·³æ£€æµ‹ï¼šæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡                                  â”‚
â”‚  â”œâ”€ è¶…æ—¶æ¸…ç†ï¼š90ç§’æ— å¿ƒè·³è‡ªåŠ¨æ³¨é”€                              â”‚
â”‚  â””â”€ å¥åº·æŠ¥å‘Šï¼šæ¯5åˆ†é’Ÿè¾“å‡ºçŠ¶æ€                                 â”‚
â”‚                                                              â”‚
â”‚  å›è°ƒæœºåˆ¶                                                     â”‚
â”‚  â”œâ”€ onRegisterCallbackï¼šæœåŠ¡ä¸Šçº¿ â†’ è‡ªåŠ¨å¯åŠ¨ä»»åŠ¡              â”‚
â”‚  â””â”€ onUnregisterCallbackï¼šæœåŠ¡ä¸‹çº¿ â†’ è®°å½•æ—¥å¿—                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†‘              â†‘
          â”‚              â”‚
     æ³¨å†Œè¯·æ±‚         å¿ƒè·³è¯·æ±‚
          â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç®—æ³•æœåŠ¡ (å¤–éƒ¨)                              â”‚
â”‚  â”œâ”€ å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œ                                            â”‚
â”‚  â”œâ”€ æ¯30ç§’å‘é€å¿ƒè·³                                            â”‚
â”‚  â”œâ”€ å¹³å°å®•æœºè‡ªåŠ¨é‡è¯•                                          â”‚
â”‚  â””â”€ é€€å‡ºæ—¶å‘é€æ³¨é”€ï¼ˆä¼˜é›…å…³é—­ï¼‰                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¶é—´å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| å¿ƒè·³æ£€æŸ¥é—´éš” | 30ç§’ | å¹³å°æ£€æŸ¥æœåŠ¡å¿ƒè·³çš„é¢‘ç‡ |
| å¿ƒè·³è¶…æ—¶æ—¶é—´ | 90ç§’ | è¶…è¿‡æ­¤æ—¶é—´æ— å¿ƒè·³è‡ªåŠ¨æ¸…ç† |
| å¥åº·æŠ¥å‘Šé—´éš” | 5åˆ†é’Ÿ | è¾“å‡ºå¥åº·çŠ¶æ€çš„é¢‘ç‡ |
| ç®—æ³•æœåŠ¡å¿ƒè·³é—´éš” | 30ç§’ | ç®—æ³•æœåŠ¡å‘é€å¿ƒè·³çš„é¢‘ç‡ |
| ç®—æ³•æœåŠ¡é‡è¯•é—´éš” | 30ç§’ | æ³¨å†Œå¤±è´¥åé‡è¯•çš„é—´éš” |

**å®¹é”™èƒ½åŠ›**: 90ç§’è¶…æ—¶ = 3æ¬¡å¿ƒè·³å‘¨æœŸï¼Œæœ€å¤šå…è®¸ä¸¢å¤±2æ¬¡å¿ƒè·³

---

## ğŸ“Š é…ç½®

### EasyDarwiné…ç½® (`configs/config.toml`)

```toml
[ai_analysis]
enable = true                      # å¯ç”¨AIåˆ†ææ’ä»¶
heartbeat_timeout_sec = 90         # å¿ƒè·³è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
scan_interval_sec = 5              # MinIOæ‰«æé—´éš”
max_concurrent_infer = 100         # æœ€å¤§å¹¶å‘æ¨ç†æ•°
```

**å…³é”®é…ç½®**ï¼š
- `heartbeat_timeout_sec`: æ§åˆ¶è‡ªåŠ¨æ¸…ç†çš„è¶…æ—¶æ—¶é—´

---

## ğŸ” æ—¥å¿—ç›‘æ§

### å…³é”®æ—¥å¿—

#### å¯åŠ¨æ—¥å¿—
```bash
algorithm service heartbeat checker started
  check_interval_sec=30
  timeout_sec=90
  health_report_interval_min=5
```

#### æ³¨å†Œæ—¥å¿—
```bash
algorithm service registered successfully
  service_id=xxx
  endpoint=http://...
  total_services=5
```

#### å¿ƒè·³æ—¥å¿—ï¼ˆdebugçº§åˆ«ï¼‰
```bash
heartbeat received
  service_id=xxx
  endpoint=http://...
```

#### æ¸…ç†æ—¥å¿—
```bash
algorithm service expired - auto removing
  service_id=xxx
  heartbeat_age_sec=95
  timeout_threshold_sec=90

algorithm service offline
  service_id=xxx
  reason=heartbeat_timeout
```

#### å¥åº·æŠ¥å‘Šï¼ˆæ¯5åˆ†é’Ÿï¼‰
```bash
algorithm services health report
  total_services=5
  task_type_distribution={...}
```

### æŸ¥çœ‹æ—¥å¿—å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰AIåˆ†ææ—¥å¿—
tail -f logs/sugar.log | grep aianalysis

# æŸ¥çœ‹æ³¨å†Œç›¸å…³
tail -f logs/sugar.log | grep "registered\|register"

# æŸ¥çœ‹æ¸…ç†ç›¸å…³
tail -f logs/sugar.log | grep "expired\|offline"

# æŸ¥çœ‹å¥åº·æŠ¥å‘Š
tail -f logs/sugar.log | grep "health report"
```

---

## âœ… éªŒè¯

### æµ‹è¯•æ³¨å†ŒåŠŸèƒ½

```bash
curl -X POST http://localhost:5066/api/v1/ai_analysis/register \
  -H "Content-Type: application/json" \
  -d '{
    "service_id": "test_service",
    "name": "æµ‹è¯•æœåŠ¡",
    "task_types": ["äººæ•°ç»Ÿè®¡"],
    "endpoint": "http://localhost:8000/infer",
    "version": "1.0.0"
  }'

# é¢„æœŸå“åº”: {"ok": true, "service_id": "test_service"}
```

### æµ‹è¯•å¿ƒè·³åŠŸèƒ½

```bash
curl -X POST http://localhost:5066/api/v1/ai_analysis/heartbeat/test_service

# é¢„æœŸå“åº”: {"ok": true}
```

### æµ‹è¯•è‡ªåŠ¨æ¸…ç†

```bash
# 1. æ³¨å†Œä¸€ä¸ªæµ‹è¯•æœåŠ¡
curl -X POST http://localhost:5066/api/v1/ai_analysis/register -d '...'

# 2. ä¸å‘é€å¿ƒè·³ï¼Œç­‰å¾…90ç§’

# 3. æŸ¥çœ‹æœåŠ¡åˆ—è¡¨ï¼ŒæœåŠ¡åº”è¯¥å·²è¢«æ¸…ç†
curl http://localhost:5066/api/v1/ai_analysis/services

# 4. æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥æœ‰ "expired" è®°å½•
tail logs/sugar.log | grep expired
```

---

## ğŸš€ ä½¿ç”¨è¯´æ˜

### å¹³å°ç«¯ï¼ˆè‡ªåŠ¨è¿è¡Œï¼‰

EasyDarwinå¯åŠ¨åä¼šè‡ªåŠ¨ï¼š
1. âœ… å¯åŠ¨å¿ƒè·³æ£€æµ‹å™¨
2. âœ… æ¯30ç§’æ£€æŸ¥æœåŠ¡å¿ƒè·³
3. âœ… 90ç§’æ— å¿ƒè·³è‡ªåŠ¨æ¸…ç†
4. âœ… æ¯5åˆ†é’Ÿè¾“å‡ºå¥åº·æŠ¥å‘Š

**æ— éœ€ä»»ä½•é…ç½®æˆ–å¹²é¢„ï¼**

### ç®—æ³•æœåŠ¡ç«¯

ç®—æ³•æœåŠ¡éœ€è¦ï¼š
1. å¯åŠ¨æ—¶æ³¨å†Œ: `POST /api/v1/ai_analysis/register`
2. å®šæœŸå¿ƒè·³: `POST /api/v1/ai_analysis/heartbeat/:id` (å»ºè®®30ç§’)
3. é€€å‡ºæ—¶æ³¨é”€: `DELETE /api/v1/ai_analysis/unregister/:id` (å¯é€‰)

**å‚è€ƒå®ç°**: `/code/predict/algorithm_service.py`

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### èµ„æºæ¶ˆè€—
- CPU: å¿ƒè·³æ£€æµ‹å™¨ < 0.1%
- å†…å­˜: æ¯ä¸ªæœåŠ¡çº¦100å­—èŠ‚
- ç½‘ç»œ: å¿ƒè·³æ¯æ¬¡< 1KB

### æ‰©å±•æ€§
- æ”¯æŒæœåŠ¡æ•°: æ— é™åˆ¶
- æ£€æŸ¥å»¶è¿Ÿ: æœ€å¤§30ç§’
- æ¸…ç†å»¶è¿Ÿ: 90-120ç§’

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2025-11-03  
**ä¿®æ”¹æ–‡ä»¶**: 
- `internal/plugin/aianalysis/registry.go`
- `internal/plugin/aianalysis/service.go`

**æ–°å¢åŠŸèƒ½**:
- âœ… è¯¦ç»†çš„æ³¨å†Œ/æ³¨é”€æ—¥å¿—
- âœ… æœåŠ¡ä¸‹çº¿å›è°ƒæœºåˆ¶
- âœ… å®šæœŸå¥åº·çŠ¶æ€æŠ¥å‘Š
- âœ… æ”¹è¿›çš„å¿ƒè·³æ—¥å¿—

