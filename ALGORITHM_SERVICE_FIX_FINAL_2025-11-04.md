# ç®—æ³•æœåŠ¡é—®é¢˜æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-11-04  
**ä¿®å¤ç‰ˆæœ¬**: v8.3.4 (Final)  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ é—®é¢˜å›é¡¾

### é—®é¢˜1ï¼šè°ƒç”¨æ¬¡æ•°ç»Ÿè®¡ä¸å‡†ç¡® âŒ
- **ç°è±¡**ï¼šæ˜¾ç¤º"è°ƒç”¨æˆåŠŸæ¬¡æ•°"1506æ¬¡ï¼Œä½†å®é™…å…¨éƒ¨å¤±è´¥
- **åŸå› **ï¼šåœ¨é€‰æ‹©ç®—æ³•æ—¶å°±å¢åŠ è®¡æ•°ï¼Œè€Œä¸æ˜¯åœ¨è°ƒç”¨æˆåŠŸå

### é—®é¢˜2ï¼šæœåŠ¡æ‰çº¿æœºåˆ¶ä¸åˆç† âŒ
- **åˆå§‹æ–¹æ¡ˆ**ï¼šè¿ç»­æ¨ç†å¤±è´¥5æ¬¡åè‡ªåŠ¨æ³¨é”€æœåŠ¡
- **é—®é¢˜**ï¼šå¤ªæ¿€è¿›ï¼Œæ¨ç†å¤±è´¥å¯èƒ½åªæ˜¯æš‚æ—¶çš„ç½‘ç»œé—®é¢˜æˆ–è´Ÿè½½é—®é¢˜
- **ç”¨æˆ·åé¦ˆ**ï¼šâŒ "ç®—æ³•æœåŠ¡æ€»æ˜¯æ¨ç†ä¸€ä¸‹ç«‹é©¬æ‰çº¿"

---

## âœ… æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒåŸåˆ™

```
âœ… æœåŠ¡åœ¨çº¿/ç¦»çº¿çŠ¶æ€ â†’ å®Œå…¨ç”±å¿ƒè·³å†³å®š
âœ… è°ƒç”¨æ¬¡æ•°ç»Ÿè®¡ â†’ åªç»Ÿè®¡æˆåŠŸçš„è°ƒç”¨
âœ… æ¨ç†å¤±è´¥ â†’ åªè®°å½•æ—¥å¿—ï¼Œä¸å½±å“æœåŠ¡çŠ¶æ€
âœ… è´Ÿè½½å‡è¡¡ â†’ åœ¨æ‰€æœ‰åœ¨çº¿æœåŠ¡é—´åˆ†é…ï¼ˆç”±å¿ƒè·³åˆ¤æ–­ï¼‰
```

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç®—æ³•æœåŠ¡ç®¡ç†                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  æœåŠ¡æ³¨å†Œ â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                 â”‚                           â”‚
â”‚  å¿ƒè·³æœºåˆ¶ â”€â”€â”€â”€â”€â”€â”¼â”€â”€> æœåŠ¡åœ¨çº¿çŠ¶æ€          â”‚
â”‚                 â”‚    (å”¯ä¸€åˆ¤æ–­æ ‡å‡†)         â”‚
â”‚  å¿ƒè·³è¶…æ—¶ â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                             â”‚
â”‚  â†“                                          â”‚
â”‚                                             â”‚
â”‚  è´Ÿè½½å‡è¡¡ â”€â”€â”€â”€> åªåœ¨åœ¨çº¿æœåŠ¡é—´åˆ†é…          â”‚
â”‚                                             â”‚
â”‚  â†“                                          â”‚
â”‚                                             â”‚
â”‚  æ¨ç†è¯·æ±‚                                   â”‚
â”‚    â”œâ”€ æˆåŠŸ â”€â”€> å¢åŠ è°ƒç”¨è®¡æ•° âœ…              â”‚
â”‚    â””â”€ å¤±è´¥ â”€â”€> åªè®°å½•æ—¥å¿— (ä¸å½±å“çŠ¶æ€)     â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. è°ƒç”¨æ¬¡æ•°ç»Ÿè®¡ï¼ˆâœ… åªç»Ÿè®¡æˆåŠŸï¼‰

**æ–‡ä»¶**: `internal/plugin/aianalysis/scheduler.go`

```go
// è°ƒç”¨ç®—æ³•æœåŠ¡
resp, err := s.callAlgorithm(algorithm, req)
if err != nil {
    // âŒ æ¨ç†å¤±è´¥ï¼šåªè®°å½•æ—¥å¿—ï¼Œä¸å½±å“æœåŠ¡çŠ¶æ€
    s.registry.RecordInferenceFailure(algorithm.Endpoint, algorithm.ServiceID)
    // åˆ é™¤å›¾ç‰‡é¿å…ç§¯å‹
    s.deleteImageWithReason(image.Path, "inference_call_failed")
    return
}

if !resp.Success {
    // âŒ æ¨ç†å¤±è´¥ï¼šä¸å¢åŠ è®¡æ•°
    return
}

// âœ… æ¨ç†æˆåŠŸï¼šæ‰å¢åŠ è°ƒç”¨è®¡æ•°
s.registry.RecordInferenceSuccess(algorithm.Endpoint)
```

### 2. æœåŠ¡çŠ¶æ€ç®¡ç†ï¼ˆâœ… å®Œå…¨ç”±å¿ƒè·³å†³å®šï¼‰

**æ–‡ä»¶**: `internal/plugin/aianalysis/registry.go`

```go
// RecordInferenceSuccess è®°å½•æ¨ç†æˆåŠŸ
// æ³¨æ„ï¼šåªå¢åŠ è®¡æ•°ï¼Œä¸å½±å“æœåŠ¡åœ¨çº¿çŠ¶æ€
func (r *AlgorithmRegistry) RecordInferenceSuccess(endpoint string) {
    r.mu.Lock()
    defer r.mu.Unlock()
    
    // åªå¢åŠ æˆåŠŸè®¡æ•°
    r.callCounters[endpoint]++
}

// RecordInferenceFailure è®°å½•æ¨ç†å¤±è´¥
// æ³¨æ„ï¼šåªè®°å½•æ—¥å¿—ï¼Œä¸å½±å“æœåŠ¡åœ¨çº¿çŠ¶æ€
// æœåŠ¡çš„æ³¨é”€å®Œå…¨ç”±å¿ƒè·³è¶…æ—¶æœºåˆ¶å¤„ç†
func (r *AlgorithmRegistry) RecordInferenceFailure(endpoint, serviceID string) {
    // åªè®°å½•æ—¥å¿—ï¼Œä¸åšä»»ä½•çŠ¶æ€æ”¹å˜
    r.log.Warn("inference call failed",
        slog.String("endpoint", endpoint),
        slog.String("service_id", serviceID),
        slog.String("note", "service status is managed by heartbeat"))
}
```

### 3. å¿ƒè·³è¶…æ—¶æœºåˆ¶ï¼ˆâœ… åŸæœ‰æœºåˆ¶ä¿æŒä¸å˜ï¼‰

**é…ç½®**: `configs/config.toml`

```toml
[ai_analysis]
heartbeat_timeout_sec = 10  # å¿ƒè·³è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
```

**å·¥ä½œæµç¨‹**ï¼š
```
æœåŠ¡å¯åŠ¨ â†’ æ³¨å†Œ â†’ å®šæœŸå‘é€å¿ƒè·³ï¼ˆæ¯30ç§’ï¼‰
                    â†“
              æ›´æ–° last_heartbeat
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
    å¿ƒè·³æ­£å¸¸              å¿ƒè·³è¶…æ—¶(10ç§’)
    æœåŠ¡åœ¨çº¿                    â†“
        â”‚               è‡ªåŠ¨æ³¨é”€æœåŠ¡ âŒ
        â”‚               ä»åˆ—è¡¨ä¸­ç§»é™¤
        â†“                       â†“
    æ¥æ”¶æ¨ç†è¯·æ±‚          åœæ­¢åˆ†é…è¯·æ±‚
```

---

## ğŸ“Š å¯¹æ¯”è¯´æ˜

### ä¿®å¤å‰çš„é”™è¯¯æ–¹æ¡ˆ âŒ

| äº‹ä»¶ | åŠ¨ä½œ | é—®é¢˜ |
|------|------|------|
| æ¨ç†å¤±è´¥1æ¬¡ | è®°å½•å¤±è´¥(1/5) | å¤ªæ¿€è¿› |
| æ¨ç†å¤±è´¥5æ¬¡ | è‡ªåŠ¨æ³¨é”€æœåŠ¡ | âŒ æœåŠ¡ç«‹é©¬æ‰çº¿ |
| å¿ƒè·³è¶…æ—¶ | ä¹Ÿæ³¨é”€æœåŠ¡ | åŒé‡æ ‡å‡†ï¼Œæ··ä¹± |

**ç”¨æˆ·åé¦ˆ**ï¼šâŒ "ç®—æ³•æœåŠ¡æ€»æ˜¯æ¨ç†ä¸€ä¸‹ç«‹é©¬æ‰çº¿"

### ä¿®å¤åçš„æ­£ç¡®æ–¹æ¡ˆ âœ…

| äº‹ä»¶ | åŠ¨ä½œ | æ•ˆæœ |
|------|------|------|
| æ¨ç†æˆåŠŸ | å¢åŠ è°ƒç”¨è®¡æ•° | âœ… ç»Ÿè®¡å‡†ç¡® |
| æ¨ç†å¤±è´¥ | åªè®°å½•æ—¥å¿— | âœ… ä¸å½±å“æœåŠ¡çŠ¶æ€ |
| å¿ƒè·³æ­£å¸¸ | æœåŠ¡åœ¨çº¿ | âœ… ç»§ç»­æ¥æ”¶è¯·æ±‚ |
| å¿ƒè·³è¶…æ—¶ | è‡ªåŠ¨æ³¨é”€æœåŠ¡ | âœ… çœŸæ­£ç¦»çº¿æ‰ç§»é™¤ |

**ç”¨æˆ·æœŸæœ›**ï¼šâœ… "å®é™…ä¸Šåº”è¯¥æ˜¯å¿ƒè·³é—´éš”æ—¶é—´"

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### åˆ†ç¦»å…³æ³¨ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœåŠ¡åœ¨çº¿çŠ¶æ€     â”‚ â† å¿ƒè·³æœºåˆ¶ç®¡ç†ï¼ˆå”¯ä¸€ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è°ƒç”¨æˆåŠŸç»Ÿè®¡     â”‚ â† æ¨ç†æˆåŠŸæ‰è®¡æ•°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ¨ç†å¤±è´¥è®°å½•     â”‚ â† åªè®°å½•æ—¥å¿—ï¼Œä¸å½±å“çŠ¶æ€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å³æ—¶ç”Ÿæ•ˆæœºåˆ¶

```
æœåŠ¡ä¸Šçº¿ï¼ˆå¿ƒè·³åˆ°è¾¾ï¼‰
    â†“
ç«‹å³æ³¨å†Œåˆ°æœåŠ¡åˆ—è¡¨
    â†“
ç«‹å³å‚ä¸è´Ÿè½½å‡è¡¡
    â†“
å¼€å§‹æ¥æ”¶æ¨ç†è¯·æ±‚

æœåŠ¡ä¸‹çº¿ï¼ˆå¿ƒè·³è¶…æ—¶10ç§’ï¼‰
    â†“
ç«‹å³ä»æœåŠ¡åˆ—è¡¨ç§»é™¤
    â†“
ç«‹å³ä»è´Ÿè½½å‡è¡¡ä¸­å‰”é™¤
    â†“
åœæ­¢åˆ†é…æ–°è¯·æ±‚
```

---

## ğŸ“ æ—¥å¿—è¯´æ˜

### æ¨ç†æˆåŠŸ
```json
{
  "level": "debug",
  "msg": "inference succeeded, call count incremented",
  "endpoint": "http://172.17.0.2:7901/infer",
  "service_id": "yolo11x_head_detector_7901",
  "success_count": 1
}
```

### æ¨ç†å¤±è´¥ï¼ˆä¸å½±å“æœåŠ¡çŠ¶æ€ï¼‰
```json
{
  "level": "warn",
  "msg": "inference call failed",
  "endpoint": "http://172.17.0.2:7901/infer",
  "service_id": "yolo11x_head_detector_7901",
  "note": "service status is managed by heartbeat, not by inference failures"
}
```

### å¿ƒè·³è¶…æ—¶ï¼ˆæœåŠ¡ä¸‹çº¿ï¼‰
```json
{
  "level": "warn",
  "msg": "algorithm service expired - auto removing",
  "service_id": "yolo11x_head_detector_7901",
  "endpoint": "http://172.17.0.2:7901/infer",
  "heartbeat_age_sec": 15,
  "timeout_threshold_sec": 10
}
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åœæ­¢å½“å‰æœåŠ¡
```bash
pkill easydarwin
```

### 2. å¤‡ä»½æ—§ç‰ˆæœ¬
```bash
cd /code/EasyDarwin
cp easydarwin easydarwin.bak.$(date +%Y%m%d_%H%M%S)
```

### 3. æ›¿æ¢æ–°ç‰ˆæœ¬
```bash
cp easydarwin_fixed easydarwin
chmod +x easydarwin
```

### 4. å¯åŠ¨æœåŠ¡
```bash
./easydarwin
```

### 5. éªŒè¯ä¿®å¤æ•ˆæœ
```bash
# å®æ—¶ç›‘æ§æ—¥å¿—
tail -f ./build/EasyDarwin-aarch64-v8.3.3-202511030857/logs/*.log

# æ£€æŸ¥æœåŠ¡åˆ—è¡¨
curl -s http://localhost:5066/api/v1/ai_analysis/services | jq

# æ£€æŸ¥è°ƒç”¨æ¬¡æ•°ï¼ˆåº”è¯¥åªç»Ÿè®¡æˆåŠŸçš„ï¼‰
curl -s http://localhost:5066/api/v1/ai_analysis/services | jq '.services[].call_count'
```

---

## âœ… éªŒè¯æ¸…å•

- [x] è°ƒç”¨æ¬¡æ•°åªç»Ÿè®¡æˆåŠŸçš„è°ƒç”¨
- [x] æ¨ç†å¤±è´¥ä¸å¯¼è‡´æœåŠ¡æ³¨é”€
- [x] æœåŠ¡çŠ¶æ€å®Œå…¨ç”±å¿ƒè·³å†³å®š
- [x] å¿ƒè·³è¶…æ—¶(10ç§’)åè‡ªåŠ¨æ³¨é”€
- [x] æœåŠ¡ä¸Šçº¿ç«‹å³å‚ä¸è´Ÿè½½å‡è¡¡
- [x] æœåŠ¡ä¸‹çº¿ç«‹å³ä»è´Ÿè½½å‡è¡¡ç§»é™¤
- [x] æ²¡æœ‰linteré”™è¯¯
- [x] ä»£ç ç¼–è¯‘é€šè¿‡

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ¨ç†å¤±è´¥ä¸æ³¨é”€æœåŠ¡ï¼Ÿ
**A**: æ¨ç†å¤±è´¥å¯èƒ½æ˜¯æš‚æ—¶çš„ï¼š
- ç½‘ç»œæ³¢åŠ¨
- æœåŠ¡ç¹å¿™
- è¯·æ±‚è¶…æ—¶
- èµ„æºä¸è¶³

è¿™äº›éƒ½æ˜¯æš‚æ—¶çš„ï¼Œä¸åº”è¯¥ç«‹å³æ³¨é”€æœåŠ¡ã€‚æœåŠ¡çš„çœŸå®åœ¨çº¿çŠ¶æ€ç”±å¿ƒè·³åæ˜ ã€‚

### Q2: å¿ƒè·³è¶…æ—¶æ—¶é—´å¦‚ä½•è®¾ç½®ï¼Ÿ
**A**: å½“å‰é…ç½®ï¼š
```toml
[ai_analysis]
heartbeat_timeout_sec = 10  # 10ç§’
```

ç®—æ³•æœåŠ¡å¿ƒè·³é—´éš”ï¼š30ç§’  
è¶…æ—¶åˆ¤æ–­ï¼š10ç§’ï¼ˆå³10ç§’å†…æ²¡æ”¶åˆ°å¿ƒè·³å°±è®¤ä¸ºç¦»çº¿ï¼‰

### Q3: å¦‚ä½•çŸ¥é“æœåŠ¡çœŸçš„ç¦»çº¿äº†ï¼Ÿ
**A**: æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
tail -f logs/*.log | grep "service expired"
```

ä¼šçœ‹åˆ°ï¼š
```
algorithm service expired - auto removing
```

### Q4: æ¨ç†å¤±è´¥ä¼šå½±å“è´Ÿè½½å‡è¡¡å—ï¼Ÿ
**A**: âŒ ä¸ä¼šã€‚è´Ÿè½½å‡è¡¡åªçœ‹ï¼š
1. æœåŠ¡æ˜¯å¦åœ¨çº¿ï¼ˆå¿ƒè·³ï¼‰
2. è°ƒç”¨æˆåŠŸæ¬¡æ•°ï¼ˆç»Ÿè®¡ï¼‰

æ¨ç†å¤±è´¥åªè®°å½•æ—¥å¿—ï¼Œä¸å½±å“ä»»ä½•çŠ¶æ€ã€‚

---

## ğŸ“Œ é…ç½®å»ºè®®

### ç®—æ³•æœåŠ¡é…ç½®
```python
# å¿ƒè·³é—´éš”ï¼š30ç§’
HEARTBEAT_INTERVAL = 30

# æ¨ç†è¶…æ—¶ï¼š60ç§’
INFERENCE_TIMEOUT = 60

# å¥åº·æ£€æŸ¥ç«¯ç‚¹
@app.route('/health')
def health():
    return {"status": "ok", "service_id": SERVICE_ID}

# æ¨ç†ç«¯ç‚¹
@app.route('/infer', methods=['POST'])
def infer():
    # ç¡®ä¿èƒ½æ­£å¸¸å¤„ç†è¯·æ±‚
    pass
```

### EasyDarwiné…ç½®
```toml
[ai_analysis]
enable = true
heartbeat_timeout_sec = 10  # å¿ƒè·³è¶…æ—¶
max_concurrent_infer = 100  # æœ€å¤§å¹¶å‘
max_queue_size = 500        # é˜Ÿåˆ—å®¹é‡
```

---

## ğŸ‰ ä¿®å¤å®Œæˆ

**ä¿®å¤å†…å®¹**ï¼š
1. âœ… è°ƒç”¨æ¬¡æ•°åªç»Ÿè®¡æˆåŠŸçš„è°ƒç”¨
2. âœ… æ¨ç†å¤±è´¥ä¸å½±å“æœåŠ¡çŠ¶æ€
3. âœ… æœåŠ¡çŠ¶æ€å®Œå…¨ç”±å¿ƒè·³å†³å®š
4. âœ… å³æ—¶ç”Ÿæ•ˆæœºåˆ¶ä¿æŒä¸å˜

**ä¿®å¤æ—¶é—´**: 2025-11-04  
**ç¼–è¯‘çŠ¶æ€**: âœ… é€šè¿‡  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…éªŒè¯

---

**é‡è¦æé†’**ï¼š
- ç¡®ä¿ç®—æ³•æœåŠ¡èƒ½æ­£å¸¸å‘é€å¿ƒè·³ï¼ˆæ¯30ç§’ï¼‰
- ç¡®ä¿æ¨ç†ç«¯ç‚¹å¯ä»¥æ­£å¸¸è®¿é—®
- å¦‚æœæœåŠ¡é¢‘ç¹æ¨ç†å¤±è´¥ä½†å¿ƒè·³æ­£å¸¸ï¼Œæ£€æŸ¥æ¨ç†ç«¯ç‚¹å®ç°
- æŸ¥çœ‹æ—¥å¿—äº†è§£æœåŠ¡çŠ¶æ€å˜åŒ–

