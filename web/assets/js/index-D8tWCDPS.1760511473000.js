import{u as re}from"./vue-router-Duq7i_u2.1760511473000.js";import"./request-BDQifrB0.1760511473000.js";import{f as g}from"./frameextractor-C0GATHCS.1760511473000.js";import{_ as de}from"./_plugin-vue_export-helper-DlAUqK2U.1760511473000.js";import{m as pe,k as _,a2 as _e,F as me,V as ce,X as fe,v as ve,S as ye,h as ge,g as ke,f as be,I as xe,z as we,c as he,w as Oe,B as Ce,a1 as ze,T as Te,$ as Ie,t as Se,K as Ue}from"./ant-design-vue-Cj9mvhaX.1760511473000.js";import{y as P,aa as Pe,x as Be,ab as K,ac as Me,I as Ae,ad as De,ae as Le,X as Ve,af as Fe,N as $e,ag as Ee,ah as Ne,P as Re,a4 as j,ai as Ke,a3 as je,aj as q,A as qe,ak as Xe}from"./@ant-design-D_IhUzkf.1760511473000.js";import{r as k,j as Ge,Z as F,c as e,X as t,W as f,V as v,a1 as T,J as d,u as i,F as He,$ as h,a3 as b}from"./vue-DcFgi5qX.1760511473000.js";import"./axios-ngrFHoWO.1760511473000.js";import"./qs-BF-lf3J5.1760511473000.js";import"./clipboard-DnI0MzOy.1760511473000.js";import"./side-channel-Bd9WoLds.1760511473000.js";import"./crypto-js-B8-feqXo.1760511473000.js";import"./index-CgW2loGF.1760511473000.js";import"./vue-i18n-DH6klY8k.1760511473000.js";import"./@intlify-C7-MzqOv.1760511473000.js";import"./nprogress-B6e-UgSL.1760511473000.js";/* empty css                                  */import"./dayjs-CRURpGSg.1760511473000.js";import"./pinia-BPNkUVLG.1760511473000.js";import"./pinia-plugin-persistedstate-n2tMOXAx.1760511473000.js";import"./lodash-es-C9rdhAyu.1760511473000.js";import"./@iconify-DKUBVEsd.1760511473000.js";import"./@babel-Bq4_u9L9.1760511473000.js";import"./@ctrl-DOFZgDuz.1760511473000.js";import"./resize-observer-polyfill-B1PUzC5B.1760511473000.js";import"./dom-align-CRCehRfe.1760511473000.js";import"./async-validator-9PlIezaS.1760511473000.js";import"./scroll-into-view-if-needed-B3z4cY-J.1760511473000.js";import"./throttle-debounce-CUWDS_la.1760511473000.js";import"./vue-types-CF28atMM.1760511473000.js";import"./@emotion-BtrR-yrm.1760511473000.js";import"./stylis-D5iaQeiq.1760511473000.js";const Je={class:"p-4 frame-extractor-container"},We={class:"card-title"},Ze={class:"card-title"},Qe={class:"rtsp-url"},Ye={style:{width:"200px"}},et={key:4},tt={style:{"max-width":"250px"}},at={__name:"index",setup(lt){const $=re(),o=k({enable:!0,interval_ms:1e3,output_dir:"./snapshots",store:"local",minio:{endpoint:"",bucket:"",access_key:"",secret_key:"",use_ssl:!1,base_path:""}}),m=k({id:"",rtsp_url:"",interval_ms:1e3,output_path:""}),B=k(!1),M=k(!1),I=k(!1),A=k([]),O=k({}),S=k({}),X=[{title:"任务ID",key:"id",width:120},{title:"状态",key:"status",width:100},{title:"RTSP地址",key:"rtsp_url",ellipsis:!0},{title:"间隔",key:"interval_ms",width:150},{title:"输出路径",key:"output_path",width:150},{title:"操作",key:"action",width:280,fixed:"right"}],D=async()=>{try{const{data:l}=await g.getConfig();console.log("fetched config from server:",l),l&&((!l.minio||typeof l.minio!="object")&&(l.minio={endpoint:"",bucket:"",access_key:"",secret_key:"",use_ssl:!1,base_path:""}),o.value={enable:l.enable!==void 0?l.enable:o.value.enable,interval_ms:l.interval_ms||o.value.interval_ms,output_dir:l.output_dir||o.value.output_dir,store:l.store||o.value.store,minio:{endpoint:l.minio.endpoint||"",bucket:l.minio.bucket||"",access_key:l.minio.access_key||"",secret_key:l.minio.secret_key||"",use_ssl:l.minio.use_ssl||!1,base_path:l.minio.base_path||""}},console.log("config after merge:",o.value),I.value=!0,setTimeout(()=>{I.value=!1},3e3))}catch(l){console.error("fetch config failed",l),_.error("加载配置失败")}},G=async()=>{var l,a;if(o.value.store==="minio"&&(!o.value.minio.endpoint||!o.value.minio.bucket)){_.error("请填写MinIO Endpoint和Bucket");return}M.value=!0;try{console.log("saving config:",o.value),await g.updateConfig(o.value),_.success("配置保存成功，已持久化到config.toml"),await D()}catch(n){console.error("save config error:",n),_.error(((a=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:a.error)||"配置保存失败")}finally{M.value=!1}},x=async()=>{const{data:l}=await g.listTasks();A.value=(l==null?void 0:l.items)||[]},H=async()=>{var l,a;if(!m.value.id||!m.value.rtsp_url){_.error("请填写任务ID与RTSP地址");return}B.value=!0;try{await g.addTask(m.value),_.success("任务添加成功"+(o.value.store==="minio"?"，MinIO路径已创建":"")),m.value={id:"",rtsp_url:"",interval_ms:1e3,output_path:""},await x()}catch(n){_.error(((a=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:a.error)||"添加失败")}finally{B.value=!1}},J=l=>{m.value={...l},window.scrollTo({top:0,behavior:"smooth"})},W=async l=>{var a,n;try{await g.delTask(l),_.success("任务删除成功"+(o.value.store==="minio"?"，MinIO路径已清理":"")),await x()}catch(r){_.error(((n=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:n.error)||"删除失败")}},Z=()=>{$.push("/frame-extractor/gallery")},Q=l=>{$.push({path:"/frame-extractor/gallery",query:{task:l}})},Y=async l=>{var a,n;O.value[l]=!0;try{await g.startTask(l),_.success("任务已启动"),await x()}catch(r){_.error(((n=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:n.error)||"启动失败")}finally{O.value[l]=!1}},ee=async l=>{var a,n;O.value[l]=!0;try{await g.stopTask(l),_.success("任务已停止"),await x()}catch(r){_.error(((n=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:n.error)||"停止失败")}finally{O.value[l]=!1}},te=async l=>{var n,r;const a=S.value[l.id]||l.interval_ms;if(a<200){_.error("间隔不能小于200ms");return}try{await g.updateInterval(l.id,a),_.success("间隔已更新"+(l.enabled?"，任务已重启":"")),await x(),delete S.value[l.id]}catch(w){_.error(((r=(n=w==null?void 0:w.response)==null?void 0:n.data)==null?void 0:r.error)||"更新失败")}};return Ge(()=>{D(),x()}),(l,a)=>{const n=Ce,r=_e,w=ge,ae=ye,p=ve,c=fe,L=ke,E=be,C=ce,y=xe,le=we,z=he,oe=Oe,N=me,V=pe,U=Te,R=Se,se=Ie,ne=Ue,ie=ze;return f(),F("div",Je,[e(V,{bordered:!1,class:"config-card mb-4"},{title:t(()=>[h("span",We,[e(i(K),{class:"title-icon"}),a[15]||(a[15]=d(" 存储配置 ",-1))])]),extra:t(()=>[e(n,{onClick:D,size:"small"},{icon:t(()=>[e(i($e))]),default:t(()=>[a[16]||(a[16]=d(" 重新加载 ",-1))]),_:1})]),default:t(()=>[I.value?(f(),v(r,{key:0,message:"配置已从服务器加载",type:"success","show-icon":"",closable:"",class:"mb-3",onClose:a[0]||(a[0]=s=>I.value=!1)})):T("",!0),e(N,{model:o.value,layout:"vertical"},{default:t(()=>[e(C,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12,md:8},{default:t(()=>[e(p,{label:"存储类型"},{default:t(()=>[e(ae,{value:o.value.store,"onUpdate:value":a[1]||(a[1]=s=>o.value.store=s),size:"large"},{default:t(()=>[e(w,{value:"local"},{default:t(()=>[e(i(P)),a[17]||(a[17]=d(" 本地文件系统 ",-1))]),_:1}),e(w,{value:"minio"},{default:t(()=>[e(i(Pe)),a[18]||(a[18]=d(" MinIO对象存储 ",-1))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:8},{default:t(()=>[e(p,{label:"默认抽帧间隔"},{default:t(()=>[e(L,{value:o.value.interval_ms,"onUpdate:value":a[2]||(a[2]=s=>o.value.interval_ms=s),min:200,step:100,size:"large",style:{width:"100%"}},{addonAfter:t(()=>[...a[19]||(a[19]=[d("毫秒",-1)])]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:8},{default:t(()=>[e(p,{label:"启用状态"},{default:t(()=>[e(E,{checked:o.value.enable,"onUpdate:checked":a[3]||(a[3]=s=>o.value.enable=s),size:"large","checked-children":"已启用","un-checked-children":"已禁用"},null,8,["checked"])]),_:1})]),_:1})]),_:1}),o.value.store==="local"?(f(),v(p,{key:0,label:"本地输出目录"},{default:t(()=>[e(y,{value:o.value.output_dir,"onUpdate:value":a[4]||(a[4]=s=>o.value.output_dir=s),size:"large",placeholder:"./snapshots"},{prefix:t(()=>[e(i(Be))]),_:1},8,["value"])]),_:1})):T("",!0),o.value.store==="minio"?(f(),F(He,{key:1},[e(le,{orientation:"left"},{default:t(()=>[e(i(K)),a[20]||(a[20]=d(" MinIO 配置 ",-1))]),_:1}),e(r,{message:"提示",description:"Bucket不存在时会自动创建，任务ID会作为子路径，删除任务时会同步删除MinIO对应路径下的所有文件",type:"info","show-icon":"",class:"mb-4"}),e(C,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12},{default:t(()=>[e(p,{label:"Endpoint"},{default:t(()=>[e(y,{value:o.value.minio.endpoint,"onUpdate:value":a[5]||(a[5]=s=>o.value.minio.endpoint=s),size:"large",placeholder:"minio.example.com:9000"},{prefix:t(()=>[e(i(Me))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12},{default:t(()=>[e(p,{label:"Bucket"},{default:t(()=>[e(y,{value:o.value.minio.bucket,"onUpdate:value":a[6]||(a[6]=s=>o.value.minio.bucket=s),size:"large",placeholder:"snapshots"},{prefix:t(()=>[e(i(De))]),suffix:t(()=>[e(z,{title:"不存在时会自动创建"},{default:t(()=>[e(i(Ae),{style:{color:"rgba(0,0,0,.45)"}})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(C,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12},{default:t(()=>[e(p,{label:"Access Key"},{default:t(()=>[e(y,{value:o.value.minio.access_key,"onUpdate:value":a[7]||(a[7]=s=>o.value.minio.access_key=s),size:"large",placeholder:"access key"},{prefix:t(()=>[e(i(Le))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12},{default:t(()=>[e(p,{label:"Secret Key"},{default:t(()=>[e(oe,{value:o.value.minio.secret_key,"onUpdate:value":a[8]||(a[8]=s=>o.value.minio.secret_key=s),size:"large",placeholder:"secret key"},{prefix:t(()=>[e(i(Ve))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(C,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12},{default:t(()=>[e(p,{label:"Base Path (可选)"},{default:t(()=>[e(y,{value:o.value.minio.base_path,"onUpdate:value":a[9]||(a[9]=s=>o.value.minio.base_path=s),size:"large",placeholder:"camera-frames"},{prefix:t(()=>[e(i(P))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12},{default:t(()=>[e(p,{label:"使用 SSL"},{default:t(()=>[e(E,{checked:o.value.minio.use_ssl,"onUpdate:checked":a[10]||(a[10]=s=>o.value.minio.use_ssl=s),size:"large","checked-children":"HTTPS","un-checked-children":"HTTP"},null,8,["checked"])]),_:1})]),_:1})]),_:1})],64)):T("",!0),e(p,null,{default:t(()=>[e(n,{type:"primary",size:"large",onClick:G,loading:M.value},{icon:t(()=>[e(i(Fe))]),default:t(()=>[a[21]||(a[21]=d(" 保存配置 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(V,{bordered:!1,class:"task-card"},{title:t(()=>[h("span",Ze,[e(i(Xe),{class:"title-icon"}),d(" 抽帧任务 ("+b(A.value.length)+") ",1)])]),extra:t(()=>[e(R,null,{default:t(()=>[e(U,{color:o.value.store==="minio"?"blue":"green"},{default:t(()=>[d(b(o.value.store==="minio"?"MinIO存储":"本地存储"),1)]),_:1},8,["color"]),e(n,{type:"primary",onClick:Z},{icon:t(()=>[e(i(q))]),default:t(()=>[a[22]||(a[22]=d(" 查看抽帧结果 ",-1))]),_:1})]),_:1})]),default:t(()=>[e(V,{class:"add-task-card mb-4",bordered:!1},{default:t(()=>[e(N,{model:m.value,layout:"vertical"},{default:t(()=>[e(C,{gutter:16},{default:t(()=>[e(c,{xs:24,sm:12,md:6},{default:t(()=>[e(p,{label:"任务ID",required:!0},{default:t(()=>[e(y,{value:m.value.id,"onUpdate:value":a[11]||(a[11]=s=>m.value.id=s),size:"large",placeholder:"如 cam1"},{prefix:t(()=>[e(i(Ee))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:10},{default:t(()=>[e(p,{label:"RTSP地址",required:!0},{default:t(()=>[e(y,{value:m.value.rtsp_url,"onUpdate:value":a[12]||(a[12]=s=>m.value.rtsp_url=s),size:"large",placeholder:"rtsp://user:pass@ip:554/..."},{prefix:t(()=>[e(i(Ne))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:4},{default:t(()=>[e(p,{label:"间隔(ms)"},{default:t(()=>[e(L,{value:m.value.interval_ms,"onUpdate:value":a[13]||(a[13]=s=>m.value.interval_ms=s),min:200,step:100,size:"large",style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:4},{default:t(()=>[e(p,{label:"输出路径"},{default:t(()=>[e(y,{value:m.value.output_path,"onUpdate:value":a[14]||(a[14]=s=>m.value.output_path=s),size:"large",placeholder:"cam1"},{prefix:t(()=>[e(i(P))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(n,{type:"primary",size:"large",onClick:H,loading:B.value},{icon:t(()=>[e(i(Re))]),default:t(()=>[a[23]||(a[23]=d(" 添加任务 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(ie,{"data-source":A.value,columns:X,"row-key":"id",pagination:{pageSize:10,showTotal:s=>`共 ${s} 条`},scroll:{x:1200}},{bodyCell:t(({column:s,record:u})=>[s.key==="id"?(f(),v(U,{key:0,color:"blue"},{default:t(()=>[d(b(u.id),1)]),_:2},1024)):s.key==="status"?(f(),v(U,{key:1,color:u.enabled?"green":"default"},{default:t(()=>[d(b(u.enabled?"运行中":"已停止"),1)]),_:2},1032,["color"])):s.key==="rtsp_url"?(f(),v(z,{key:2,title:u.rtsp_url},{default:t(()=>[h("span",Qe,b(u.rtsp_url),1)]),_:2},1032,["title"])):s.key==="interval_ms"?(f(),v(se,{key:3,trigger:"click",placement:"bottom"},{content:t(()=>[h("div",Ye,[e(L,{value:S.value[u.id],"onUpdate:value":ue=>S.value[u.id]=ue,min:200,step:100,style:{width:"100%","margin-bottom":"8px"},placeholder:"新间隔(ms)"},null,8,["value","onUpdate:value"]),e(n,{type:"primary",size:"small",block:"",onClick:()=>te(u)},{default:t(()=>[...a[24]||(a[24]=[d(" 确认修改 ",-1)])]),_:1},8,["onClick"])])]),default:t(()=>[e(U,{color:"green",style:{cursor:"pointer"}},{default:t(()=>[d(b(u.interval_ms)+"ms ",1),e(i(j),{style:{"font-size":"10px"}})]),_:2},1024)]),_:2},1024)):s.key==="output_path"?(f(),F("span",et,[e(i(P)),d(" "+b(u.output_path),1)])):s.key==="action"?(f(),v(R,{key:5},{default:t(()=>[e(z,{title:u.enabled?"停止抽帧":"启动抽帧"},{default:t(()=>[e(n,{type:u.enabled?"default":"primary",size:"small",onClick:()=>u.enabled?ee(u.id):Y(u.id),loading:O.value[u.id]},{icon:t(()=>[u.enabled?(f(),v(i(Ke),{key:0})):(f(),v(i(je),{key:1}))]),_:2},1032,["type","onClick","loading"])]),_:2},1032,["title"]),e(z,{title:"查看快照"},{default:t(()=>[e(n,{type:"default",size:"small",onClick:()=>Q(u.id)},{icon:t(()=>[e(i(q))]),_:1},8,["onClick"])]),_:2},1024),e(z,{title:"编辑"},{default:t(()=>[e(n,{type:"primary",size:"small",onClick:()=>J(u)},{icon:t(()=>[e(i(j))]),_:1},8,["onClick"])]),_:2},1024),e(ne,{title:"确认删除?","ok-text":"删除","cancel-text":"取消",onConfirm:()=>W(u.id)},{description:t(()=>[h("div",tt,[o.value.store==="minio"?(f(),v(r,{key:0,message:"将同时删除MinIO中的所有文件",type:"warning","show-icon":"",banner:!0,style:{"margin-bottom":"8px"}})):T("",!0),a[25]||(a[25]=d(" 此操作不可恢复，确认删除任务 ",-1)),h("strong",null,b(u.id),1),a[26]||(a[26]=d(" 吗？ ",-1))])]),default:t(()=>[e(n,{danger:"",size:"small"},{icon:t(()=>[e(i(qe))]),_:1})]),_:2},1032,["onConfirm"])]),_:2},1024)):T("",!0)]),_:1},8,["data-source","pagination"])]),_:1})])}}},Lt=de(at,[["__scopeId","data-v-3b32fceb"]]);export{Lt as default};
