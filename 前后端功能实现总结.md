# 前后端功能实现总结

## ✅ 已完成的功能

### 后端实现

1. **配置模型扩展** (`internal/conf/model.go`)
   - 在`FrameExtractTask`结构体中添加了`SaveAlertImage *bool`字段
   - 支持`nil`（使用全局配置）、`true`（保存）、`false`（不保存）

2. **AI分析服务逻辑** (`internal/plugin/aianalysis/scheduler.go`)
   - 修改了`shouldSaveAlertImage`函数，优先从任务配置读取
   - 支持任务级配置、算法配置、全局配置的优先级

3. **服务方法** (`internal/plugin/frameextractor/service.go`)
   - `GetTaskByID(id string)` - 获取任务配置
   - `UpdateTaskSaveAlertImage(id string, saveAlertImage *bool)` - 更新保存设置

4. **API接口** (`internal/web/api/api.go`)
   - `POST /api/v1/frame_extractor/tasks` - 创建任务时支持配置`save_alert_image`
   - `GET /api/v1/frame_extractor/tasks` - 任务列表返回`save_alert_image`状态
   - `PUT /api/v1/frame_extractor/tasks/:id/save_alert_image` - 更新保存设置

5. **配置持久化** (`internal/plugin/frameextractor/persist.go`)
   - 自动保存`save_alert_image`字段到`config.toml`

### 前端实现

1. **API接口** (`web-src/src/api/frameextractor.js`)
   - 添加了`updateSaveAlertImage(id, saveAlertImage)`方法

2. **任务列表** (`web-src/src/views/frame-extractor/index.vue`)
   - 在表格中添加了"保存告警图片"列
   - 使用Popover + RadioGroup实现三态选择（全局/保存/不保存）
   - 显示状态标签（绿色=保存，红色=不保存，灰色=全局）

3. **创建任务表单**
   - 添加了"保存告警图片"下拉选择框
   - 选项：使用全局配置、保存、不保存

4. **编辑任务**
   - 编辑时自动填充`save_alert_image`字段

5. **快速更新**
   - 在任务列表中点击状态标签，弹出选择框快速修改

## 🎨 前端UI设计

### 任务列表表格

新增"保存告警图片"列，显示方式：
- **绿色标签"保存"** - 任务级配置为保存
- **红色标签"不保存"** - 任务级配置为不保存  
- **灰色标签"全局"** - 使用全局配置

点击标签弹出选择框，可以快速切换：
- 使用全局配置
- 保存
- 不保存

### 创建任务表单

在表单中添加下拉选择框：
```
保存告警图片: [使用全局配置 ▼]
  - 使用全局配置
  - 保存
  - 不保存
```

## 📡 API使用示例

### 1. 创建任务时配置

```bash
curl -X POST http://localhost:5066/api/v1/frame_extractor/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "id": "测试1",
    "task_type": "人数统计",
    "rtsp_url": "rtsp://...",
    "interval_ms": 2000,
    "save_alert_image": true
  }'
```

### 2. 更新保存设置

```bash
# 设置为保存
curl -X PUT http://localhost:5066/api/v1/frame_extractor/tasks/测试1/save_alert_image \
  -H "Content-Type: application/json" \
  -d '{"save_alert_image": true}'

# 设置为不保存
curl -X PUT http://localhost:5066/api/v1/frame_extractor/tasks/测试1/save_alert_image \
  -H "Content-Type: application/json" \
  -d '{"save_alert_image": false}'

# 恢复使用全局配置
curl -X PUT http://localhost:5066/api/v1/frame_extractor/tasks/测试1/save_alert_image \
  -H "Content-Type: application/json" \
  -d '{"save_alert_image": null}'
```

### 3. 查看任务列表

```bash
curl http://localhost:5066/api/v1/frame_extractor/tasks | jq
```

响应中包含`save_alert_image`字段：
```json
{
  "items": [
    {
      "id": "测试1",
      "save_alert_image": true,
      ...
    }
  ]
}
```

## 🔄 工作流程

### 前端操作流程

1. **创建任务**
   - 用户填写任务信息
   - 选择"保存告警图片"选项（使用全局配置/保存/不保存）
   - 提交创建

2. **查看任务列表**
   - 表格显示每个任务的保存状态
   - 通过颜色标签快速识别状态

3. **修改保存设置**
   - 点击状态标签
   - 弹出选择框
   - 选择新设置
   - 自动保存并刷新列表

### 后端处理流程

1. **创建任务**
   - 接收`save_alert_image`字段
   - 保存到配置
   - 持久化到`config.toml`

2. **推理时判断**
   - 优先读取任务级配置
   - 如果为`nil`，使用全局配置
   - 根据配置决定是否保存告警图片

3. **更新设置**
   - 接收更新请求
   - 更新任务配置
   - 持久化到`config.toml`
   - 立即生效（下次推理时使用新配置）

## 📝 配置文件示例

```toml
[[frame_extractor.tasks]]
id = '测试1'
task_type = '人数统计'
rtsp_url = 'rtsp://admin:password@192.168.1.100:554/stream'
interval_ms = 2000
output_path = '测试1'
enabled = true
save_alert_image = true  # 任务级配置：保存告警图片

[[frame_extractor.tasks]]
id = '测试2'
task_type = '人员跌倒'
rtsp_url = 'rtsp://admin:password@192.168.1.101:554/stream'
interval_ms = 3000
output_path = '测试2'
enabled = true
# 不设置save_alert_image，使用全局配置
```

## ✅ 测试清单

### 后端测试

- [x] 创建任务时支持`save_alert_image`字段
- [x] 任务列表返回`save_alert_image`状态
- [x] 更新`save_alert_image`设置
- [x] 配置持久化到`config.toml`
- [x] AI分析服务正确读取任务配置
- [x] 配置优先级正确（任务级 > 算法配置 > 全局配置）

### 前端测试

- [x] 创建任务表单显示"保存告警图片"选项
- [x] 任务列表显示保存状态
- [x] 可以点击状态标签快速修改
- [x] 编辑任务时正确填充`save_alert_image`字段
- [x] 更新后自动刷新列表

## 🎯 功能特点

1. **灵活配置**：每个任务可以单独配置，也可以使用全局配置
2. **直观显示**：通过颜色标签快速识别状态
3. **快速修改**：在列表中直接点击修改，无需进入编辑页面
4. **自动持久化**：所有配置变更自动保存到配置文件
5. **向后兼容**：不设置`save_alert_image`的任务使用全局配置

---

**实现时间**：2025年11月19日  
**功能状态**：✅ 前后端已完成

