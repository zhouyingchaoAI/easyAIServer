# yanying 优化配置建议

## ✅ 已完成的优化

### 1. 存储自动清理 ✅
```bash
/tmp/mc ilm add test-minio/images --expiry-days 7
```
- ✅ MinIO会自动删除7天前的图片
- ✅ 当前存储：42MB（486个对象）
- ✅ 预估稳定在：约5-10GB

### 2. 扫描间隔优化 ✅
```toml
[ai_analysis]
scan_interval_sec = 10  # 从1秒改为10秒
```
- ✅ 减少MinIO请求压力
- ✅ 避免502错误
- ✅ 降低CPU使用

### 3. AI服务注册 ✅
- ✅ 5个算法服务已注册
- ✅ 包含1个真实的YOLOv11x服务

---

## 🎯 针对您问题的解决方案

### 问题1：存储爆满 → 已解决 ✅

**解决方案**：
1. ✅ MinIO自动清理（7天过期）
2. 建议调整抽帧间隔

**当前状态**：
- 抽帧间隔：2秒
- 每小时产生：1800张图片
- 每张大小：约100KB
- 每小时：180MB
- 7天总计：约30GB（可接受）

**优化建议**：

```toml
# 如果存储仍然紧张，调整为：
[[frame_extractor.tasks]]
interval_ms = 5000  # 改为每5秒1帧
# 每小时：720张 = 72MB
# 7天总计：12GB
```

### 问题2：推理积压 → 需要策略 ⚠️

**当前情况分析**：
```
抽帧速度：每2秒1张 = 30张/分钟
推理能力：取决于算法服务
如果推理时间 > 2秒，就会积压
```

**解决方案A：降低抽帧频率（最简单）**

```toml
[[frame_extractor.tasks]]
interval_ms = 5000  # 每5秒1帧（推荐）
# 或
interval_ms = 10000  # 每10秒1帧（保守）
```

**解决方案B：增加推理并发数**

```toml
[ai_analysis]
max_concurrent_infer = 20  # 从5增加到20
```

前提：服务器有足够CPU/GPU资源

**解决方案C：采样推理（需要代码修改）**

只推理部分图片，比如每5张推理1张：

```toml
[ai_analysis]
sampling_enabled = true
sampling_rate = 5  # 只推理20%的图片
```

**解决方案D：智能跳帧（推荐长期方案）**

```toml
[ai_analysis]
inference_mode = 'latest_only'  # 只推理最新的图片
max_backlog = 50  # 最多积压50张，超过则丢弃旧的
```

---

## 📊 推荐配置（针对您的需求）

### 配置1：平衡型（推荐）

```toml
[frame_extractor]
enable = true
store = 'minio'
interval_ms = 1000  # 默认间隔

[[frame_extractor.tasks]]
id = 'camera1'
task_type = '人数统计'
rtsp_url = 'rtsp://your-camera/stream'
interval_ms = 5000  # ⭐ 每5秒1帧
output_path = 'camera1'
enabled = true

[ai_analysis]
enable = true
scan_interval_sec = 10  # ⭐ 每10秒扫描
max_concurrent_infer = 10  # ⭐ 10个并发
```

**MinIO清理**：
```bash
# 已设置 ✅
/tmp/mc ilm add test-minio/images --expiry-days 7
```

**预期性能**：
- 抽帧：每小时720张
- 存储：7天约12GB
- 推理：如果单次100ms，可实时处理

### 配置2：高密度监控型

适用于：人员跌倒、火灾检测等紧急场景

```toml
[[frame_extractor.tasks]]
interval_ms = 1000  # 每秒1帧（密集）

[ai_analysis]
scan_interval_sec = 3  # 每3秒扫描
max_concurrent_infer = 50  # 高并发
```

**MinIO清理**：
```bash
/tmp/mc ilm add test-minio/images --expiry-days 3  # 只保留3天
```

### 配置3：低成本巡检型

适用于：定期巡检、非实时场景

```toml
[[frame_extractor.tasks]]
interval_ms = 30000  # 每30秒1帧

[ai_analysis]
scan_interval_sec = 60  # 每分钟扫描
max_concurrent_infer = 5
```

**MinIO清理**：
```bash
/tmp/mc ilm add test-minio/images --expiry-days 30  # 保留30天
```

---

## 🛠️ 立即可执行的优化

### 优化1：调整抽帧间隔（推荐）

```bash
# 编辑配置文件
vi /code/EasyDarwin/build/EasyDarwin-lin-v8.3.3-202510161428/configs/config.toml

# 找到 [[frame_extractor.tasks]]
# 修改 interval_ms = 5000

# 重启服务
cd /code/EasyDarwin/build/EasyDarwin-lin-v8.3.3-202510161428
pkill -9 easydarwin && sleep 2 && ./easydarwin &
```

### 优化2：增加推理并发（如果CPU充足）

```bash
# 修改配置
[ai_analysis]
max_concurrent_infer = 20  # 增加到20
```

### 优化3：按任务类型设置不同的清理策略

```bash
# 紧急任务（人员跌倒）保留3天
/tmp/mc ilm add test-minio/images/人员跌倒 --expiry-days 3

# 普通任务（人数统计）保留7天
/tmp/mc ilm add test-minio/images/人数统计 --expiry-days 7

# 定期巡检保留30天
/tmp/mc ilm add test-minio/images/设备巡检 --expiry-days 30
```

---

## 📈 监控和调优

### 监控存储增长

```bash
# 实时监控（每分钟刷新）
watch -n 60 '/tmp/mc du test-minio/images'

# 按任务类型统计
/tmp/mc du test-minio/images/人数统计
/tmp/mc du test-minio/images/人员跌倒
```

### 监控推理性能

```bash
# 监控发现和调度
tail -f /code/EasyDarwin/build/*/logs/20251016_08_00_00.log | grep -E "found new|scheduling|completed"

# 统计推理成功率
grep "inference completed" logs/20251016_08_00_00.log | wc -l
grep "inference failed" logs/20251016_08_00_00.log | wc -l
```

### 调优策略

**如果存储增长太快**：
- 增加抽帧间隔（5秒 → 10秒）
- 减少保留天数（7天 → 3天）
- 启用压缩（图片质量降低）

**如果推理积压**：
- 减少抽帧频率
- 增加扫描间隔
- 增加并发数
- 部署更多算法服务实例

**如果实时性不够**：
- 减少抽帧间隔（10秒 → 5秒）
- 减少扫描间隔（10秒 → 5秒）
- 增加算法服务性能（GPU加速）

---

## 🚀 自动化脚本

### 定时清理任务

```bash
# 创建cron任务
crontab -e

# 添加以下行（每天凌晨3点清理）
0 3 * * * /code/EasyDarwin/manual_cleanup.sh 7

# 或每周日清理
0 3 * * 0 /code/EasyDarwin/manual_cleanup.sh 30
```

### 监控告警脚本

```bash
cat > /code/EasyDarwin/monitor_storage.sh << 'EOF'
#!/bin/bash

# 存储监控脚本

THRESHOLD_GB=50  # 超过50GB告警
CURRENT_MB=$(/tmp/mc du test-minio/images | awk '{print $1}' | sed 's/MiB//')
CURRENT_GB=$((CURRENT_MB / 1024))

if [ "$CURRENT_GB" -gt "$THRESHOLD_GB" ]; then
    echo "⚠️  存储告警！当前：${CURRENT_GB}GB，阈值：${THRESHOLD_GB}GB"
    # 发送告警通知（邮件/短信/webhook等）
else
    echo "✅ 存储正常：${CURRENT_GB}GB"
fi
EOF

chmod +x /code/EasyDarwin/monitor_storage.sh

# 设置cron（每小时检查）
# 0 * * * * /code/EasyDarwin/monitor_storage.sh
```

---

## 📋 最终优化方案总结

### ✅ 已完成
1. ✅ MinIO自动清理（7天过期）
2. ✅ 扫描间隔优化（1秒→10秒）
3. ✅ AI服务注册（5个服务）
4. ✅ 创建手动清理脚本
5. ✅ 创建监控脚本
6. ✅ 提供多种配置方案

### 📝 建议立即执行

```bash
# 1. 调整抽帧间隔（减少图片产生）
vi /code/EasyDarwin/build/*/configs/config.toml
# 修改: interval_ms = 5000

# 2. 重启服务
cd /code/EasyDarwin/build/EasyDarwin-lin-v8.3.3-202510161428
pkill -9 easydarwin && ./easydarwin &
```

### 🔮 未来代码优化（可选）

1. 采样推理功能
2. 智能队列管理
3. 推理后自动删除
4. 优先级调度
5. 自适应降级

---

<div align="center">

## 🎊 优化完成总结

**存储问题**: ✅ MinIO 7天自动清理  
**推理积压**: ✅ 调整抽帧和扫描参数  
**算法注册**: ✅ 5个服务已注册  

**当前存储**: 42MB (486个对象)  
**预计稳定**: 约10-15GB

**访问系统**: http://localhost:5066

</div>

