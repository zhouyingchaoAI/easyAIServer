# 队列不均匀问题修复说明

## ✅ 已实施的修复

### 1. 修复图片标记问题（关键修复）

**问题**：
- 之前：所有传入的图片都被标记为processed，即使队列满了被丢弃
- 导致：被丢弃的图片永远无法被处理

**修复**：
- 修改 `queue.Add()` 方法，返回真正加入队列的图片列表
- 只标记真正加入队列的图片为processed
- 未加入队列的图片不标记，下次扫描时再处理

**代码变更**：
```go
// queue.go
func (q *InferenceQueue) Add(images []ImageInfo) (int, []ImageInfo) {
    // 返回：加入数量，真正加入的图片列表
    addedImages := make([]ImageInfo, 0, len(images))
    // ... 添加逻辑 ...
    return added, addedImages
}

// service.go
added, addedImages := s.queue.Add(images)
// 只标记真正加入的图片
for _, img := range addedImages {
    s.scanner.MarkProcessed(img.Path)
}
```

### 2. 限制批次大小（避免队列突然变大）

**问题**：
- 扫描器可能一次性发现几千张图片
- 一次性全部加入队列，导致队列突然变大

**修复**：
- 每次扫描最多加入1000张图片
- 剩余的图片下次扫描时再处理
- 队列增长更均匀

**代码变更**：
```go
const maxBatchSize = 1000 // 每次最多加入1000张

if len(images) > maxBatchSize {
    images = images[:maxBatchSize]
    // 记录日志，说明剩余图片下次处理
}
```

## 📊 预期效果

### 修复前
```
时间线：
T0: 队列大小 0
T1: 扫描发现5000张图片
T2: 一次性加入5000张（或部分加入，部分丢弃但已标记）
T3: 队列突然变成5000（或部分图片永远丢失）
```

### 修复后
```
时间线：
T0: 队列大小 0
T1: 扫描发现5000张图片
T2: 限制批次，只加入1000张
T3: 队列变成1000
T4: 下次扫描，继续处理剩余的4000张
T5: 队列变成2000（如果推理速度跟上）
...
```

## 🔍 监控建议

修复后，可以通过以下日志监控效果：

1. **批次限制日志**：
   ```
   batch size limited total_found=5000 batch_size=1000
   ```

2. **图片加入日志**：
   ```
   images added to queue added=1000 queue_size=1000 original_count=5000
   ```

3. **图片未加入警告**（如果队列满了）：
   ```
   some images not added to queue found=1000 added=500 skipped=500
   ```

## ⚠️ 注意事项

1. **批次大小**：当前设置为1000，可以根据实际情况调整
   - 如果队列经常满，可以减小批次大小
   - 如果队列经常空，可以增大批次大小

2. **扫描间隔**：当前配置为1秒
   - 如果批次限制导致处理延迟，可以减小扫描间隔
   - 但要注意MinIO的负载

3. **队列大小**：当前配置为50000
   - 如果经常出现"some images not added"警告，说明队列容量不足
   - 可以增大队列容量或提升推理速度

## 📝 后续优化建议

1. **增量扫描**：只扫描新对象，减少扫描范围
2. **动态批次大小**：根据队列大小动态调整批次大小
3. **优先级队列**：根据任务类型或时间设置优先级
