import{u as ge}from"./vue-router-C_vhVX4Q.1760515936000.js";import"./request-1oue-1ff.1760515936000.js";import{l as G}from"./live-BEqMf9dW.1760515936000.js";import{f as b}from"./frameextractor-DJ9Ya8hj.1760515936000.js";import{_ as ke}from"./_plugin-vue_export-helper-DlAUqK2U.1760515936000.js";import{m as be,k as m,a2 as xe,F as we,V as he,X as Ce,v as Oe,S as Se,h as Te,g as ze,f as Ie,I as Ue,z as Pe,c as Le,w as Re,B as Be,a3 as $e,a1 as Me,T as Ne,$ as Ae,t as De,K as Ve}from"./ant-design-vue-D61mTJ-3.1760515936000.js";import{y as B,aa as Fe,x as Ee,ab as H,ac as Ke,I as W,ad as je,ae as Xe,X as qe,af as Ge,N as J,ag as He,ah as We,P as Je,a4 as Z,ai as Ze,a3 as Qe,aj as Q,A as Ye,ak as et}from"./@ant-design-BCwjm2bf.1760515936000.js";import{r as y,j as tt,Z as F,c as e,X as t,W as f,V as g,a1 as I,J as _,u as i,F as at,$ as h,a3 as x}from"./vue-DcFgi5qX.1760515936000.js";import"./axios-ngrFHoWO.1760515936000.js";import"./qs-DM9Y_1ZV.1760515936000.js";import"./clipboard-DnI0MzOy.1760515936000.js";import"./side-channel-BspPkdEn.1760515936000.js";import"./crypto-js-_XeL5YDx.1760515936000.js";import"./index-BT6FO7dT.1760515936000.js";import"./vue-i18n-DzpLahp0.1760515936000.js";import"./@intlify-C7-MzqOv.1760515936000.js";import"./nprogress-D9117Xc1.1760515936000.js";/* empty css                                  */import"./dayjs-CWYnH3wZ.1760515936000.js";import"./pinia-IwaS4ccq.1760515936000.js";import"./pinia-plugin-persistedstate-n2tMOXAx.1760515936000.js";import"./lodash-es-C9rdhAyu.1760515936000.js";import"./@iconify-D8nWepQE.1760515936000.js";import"./@babel-Bq4_u9L9.1760515936000.js";import"./@ctrl-DOFZgDuz.1760515936000.js";import"./resize-observer-polyfill-B1PUzC5B.1760515936000.js";import"./dom-align-CRCehRfe.1760515936000.js";import"./async-validator-9PlIezaS.1760515936000.js";import"./scroll-into-view-if-needed-B3z4cY-J.1760515936000.js";import"./throttle-debounce-CUWDS_la.1760515936000.js";import"./vue-types-CF28atMM.1760515936000.js";import"./@emotion-BtrR-yrm.1760515936000.js";import"./stylis-D5iaQeiq.1760515936000.js";const lt={class:"p-4 frame-extractor-container"},ot={class:"card-title"},st={class:"card-title"},nt={class:"rtsp-url"},it={style:{width:"200px"}},ut={key:4},rt={style:{"max-width":"250px"}},pt={__name:"index",setup(dt){const E=ge(),o=y({enable:!0,interval_ms:1e3,output_dir:"./snapshots",store:"local",minio:{endpoint:"",bucket:"",access_key:"",secret_key:"",use_ssl:!1,base_path:""}}),d=y({id:"",rtsp_url:"",interval_ms:1e3,output_path:""}),$=y(!1),M=y(!1),U=y(!1),N=y([]),T=y({}),P=y({}),K=y([]),A=y([]),Y=[{title:"任务ID",key:"id",width:120},{title:"状态",key:"status",width:100},{title:"RTSP地址",key:"rtsp_url",ellipsis:!0},{title:"间隔",key:"interval_ms",width:150},{title:"输出路径",key:"output_path",width:150},{title:"操作",key:"action",width:280,fixed:"right"}],D=async()=>{try{const{data:l}=await b.getConfig();console.log("fetched config from server:",l),l&&((!l.minio||typeof l.minio!="object")&&(l.minio={endpoint:"",bucket:"",access_key:"",secret_key:"",use_ssl:!1,base_path:""}),o.value={enable:l.enable!==void 0?l.enable:o.value.enable,interval_ms:l.interval_ms||o.value.interval_ms,output_dir:l.output_dir||o.value.output_dir,store:l.store||o.value.store,minio:{endpoint:l.minio.endpoint||"",bucket:l.minio.bucket||"",access_key:l.minio.access_key||"",secret_key:l.minio.secret_key||"",use_ssl:l.minio.use_ssl||!1,base_path:l.minio.base_path||""}},console.log("config after merge:",o.value),U.value=!0,setTimeout(()=>{U.value=!1},3e3))}catch(l){console.error("fetch config failed",l),m.error("加载配置失败")}},ee=async()=>{var l,a;if(o.value.store==="minio"&&(!o.value.minio.endpoint||!o.value.minio.bucket)){m.error("请填写MinIO Endpoint和Bucket");return}M.value=!0;try{console.log("saving config:",o.value),await b.updateConfig(o.value),m.success("配置保存成功，已持久化到config.toml"),await D()}catch(s){console.error("save config error:",s),m.error(((a=(l=s==null?void 0:s.response)==null?void 0:l.data)==null?void 0:a.error)||"配置保存失败")}finally{M.value=!1}},j=async()=>{try{const{data:l}=await G.getLiveList({});K.value=(l==null?void 0:l.items)||[],A.value=K.value.map(a=>{const s=a.name||`Stream ${a.id}`;return{value:String(a.id),label:`${s} (ID: ${a.id})`,streamId:a.id,streamName:s}}),console.log("loaded live streams:",A.value.length)}catch(l){console.error("fetch live streams failed",l)}},te=(l,a)=>a.label.toLowerCase().includes(l.toLowerCase()),ae=async(l,a)=>{var s,r,k,L;if(!(l&&l.startsWith("rtsp://")))try{const u=parseInt(l);if(!u){d.value.rtsp_url="";return}const c=d.value.rtsp_url;d.value.rtsp_url="获取播放地址中...";const{data:v}=await G.getPlayUrl(u);console.log("API response:",v);const O=((s=v==null?void 0:v.info)==null?void 0:s.rtsp)||((r=v==null?void 0:v.info)==null?void 0:r.RTSP);O?(d.value.rtsp_url=O,console.log("selected stream RTSP URL:",O),m.success(`已选择: ${a.streamName}`)):(d.value.rtsp_url=c,m.error("未获取到RTSP播放地址"),console.warn("No RTSP URL found in response:",v))}catch(u){console.error("get play url failed",u),d.value.rtsp_url="",m.error("获取播放地址失败: "+(((L=(k=u==null?void 0:u.response)==null?void 0:k.data)==null?void 0:L.error)||u.message))}},C=async()=>{const{data:l}=await b.listTasks();N.value=(l==null?void 0:l.items)||[]},le=async()=>{var l,a;if(!d.value.id||!d.value.rtsp_url){m.error("请填写任务ID与RTSP地址");return}$.value=!0;try{await b.addTask(d.value),m.success("任务添加成功"+(o.value.store==="minio"?"，MinIO路径已创建":"")),d.value={id:"",rtsp_url:"",interval_ms:1e3,output_path:""},await C()}catch(s){m.error(((a=(l=s==null?void 0:s.response)==null?void 0:l.data)==null?void 0:a.error)||"添加失败")}finally{$.value=!1}},oe=l=>{d.value={...l},window.scrollTo({top:0,behavior:"smooth"})},se=async l=>{var a,s;try{await b.delTask(l),m.success("任务删除成功"+(o.value.store==="minio"?"，MinIO路径已清理":"")),await C()}catch(r){m.error(((s=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:s.error)||"删除失败")}},ne=()=>{E.push("/frame-extractor/gallery")},ie=l=>{E.push({path:"/frame-extractor/gallery",query:{task:l}})},ue=async l=>{var a,s;T.value[l]=!0;try{await b.startTask(l),m.success("任务已启动"),await C()}catch(r){m.error(((s=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:s.error)||"启动失败")}finally{T.value[l]=!1}},re=async l=>{var a,s;T.value[l]=!0;try{await b.stopTask(l),m.success("任务已停止"),await C()}catch(r){m.error(((s=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:s.error)||"停止失败")}finally{T.value[l]=!1}},pe=async l=>{var s,r;const a=P.value[l.id]||l.interval_ms;if(a<200){m.error("间隔不能小于200ms");return}try{await b.updateInterval(l.id,a),m.success("间隔已更新"+(l.enabled?"，任务已重启":"")),await C(),delete P.value[l.id]}catch(k){m.error(((r=(s=k==null?void 0:k.response)==null?void 0:s.data)==null?void 0:r.error)||"更新失败")}};return tt(()=>{D(),C(),j()}),(l,a)=>{const s=Be,r=xe,k=Te,L=Se,u=Oe,c=Ce,v=ze,O=Ie,z=he,w=Ue,de=Pe,S=Le,_e=Re,X=we,V=be,R=Ne,q=De,me=$e,ce=Ae,fe=Ve,ve=Me;return f(),F("div",lt,[e(V,{bordered:!1,class:"config-card mb-4"},{title:t(()=>[h("span",ot,[e(i(H),{class:"title-icon"}),a[15]||(a[15]=_(" 存储配置 ",-1))])]),extra:t(()=>[e(s,{onClick:D,size:"small"},{icon:t(()=>[e(i(J))]),default:t(()=>[a[16]||(a[16]=_(" 重新加载 ",-1))]),_:1})]),default:t(()=>[U.value?(f(),g(r,{key:0,message:"配置已从服务器加载",type:"success","show-icon":"",closable:"",class:"mb-3",onClose:a[0]||(a[0]=n=>U.value=!1)})):I("",!0),e(X,{model:o.value,layout:"vertical"},{default:t(()=>[e(z,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12,md:8},{default:t(()=>[e(u,{label:"存储类型"},{default:t(()=>[e(L,{value:o.value.store,"onUpdate:value":a[1]||(a[1]=n=>o.value.store=n),size:"large"},{default:t(()=>[e(k,{value:"local"},{default:t(()=>[e(i(B)),a[17]||(a[17]=_(" 本地文件系统 ",-1))]),_:1}),e(k,{value:"minio"},{default:t(()=>[e(i(Fe)),a[18]||(a[18]=_(" MinIO对象存储 ",-1))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:8},{default:t(()=>[e(u,{label:"默认抽帧间隔"},{default:t(()=>[e(v,{value:o.value.interval_ms,"onUpdate:value":a[2]||(a[2]=n=>o.value.interval_ms=n),min:200,step:100,size:"large",style:{width:"100%"}},{addonAfter:t(()=>[...a[19]||(a[19]=[_("毫秒",-1)])]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:8},{default:t(()=>[e(u,{label:"启用状态"},{default:t(()=>[e(O,{checked:o.value.enable,"onUpdate:checked":a[3]||(a[3]=n=>o.value.enable=n),size:"large","checked-children":"已启用","un-checked-children":"已禁用"},null,8,["checked"])]),_:1})]),_:1})]),_:1}),o.value.store==="local"?(f(),g(u,{key:0,label:"本地输出目录"},{default:t(()=>[e(w,{value:o.value.output_dir,"onUpdate:value":a[4]||(a[4]=n=>o.value.output_dir=n),size:"large",placeholder:"./snapshots"},{prefix:t(()=>[e(i(Ee))]),_:1},8,["value"])]),_:1})):I("",!0),o.value.store==="minio"?(f(),F(at,{key:1},[e(de,{orientation:"left"},{default:t(()=>[e(i(H)),a[20]||(a[20]=_(" MinIO 配置 ",-1))]),_:1}),e(r,{message:"提示",description:"Bucket不存在时会自动创建，任务ID会作为子路径，删除任务时会同步删除MinIO对应路径下的所有文件",type:"info","show-icon":"",class:"mb-4"}),e(z,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12},{default:t(()=>[e(u,{label:"Endpoint"},{default:t(()=>[e(w,{value:o.value.minio.endpoint,"onUpdate:value":a[5]||(a[5]=n=>o.value.minio.endpoint=n),size:"large",placeholder:"minio.example.com:9000"},{prefix:t(()=>[e(i(Ke))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12},{default:t(()=>[e(u,{label:"Bucket"},{default:t(()=>[e(w,{value:o.value.minio.bucket,"onUpdate:value":a[6]||(a[6]=n=>o.value.minio.bucket=n),size:"large",placeholder:"snapshots"},{prefix:t(()=>[e(i(je))]),suffix:t(()=>[e(S,{title:"不存在时会自动创建"},{default:t(()=>[e(i(W),{style:{color:"rgba(0,0,0,.45)"}})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(z,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12},{default:t(()=>[e(u,{label:"Access Key"},{default:t(()=>[e(w,{value:o.value.minio.access_key,"onUpdate:value":a[7]||(a[7]=n=>o.value.minio.access_key=n),size:"large",placeholder:"access key"},{prefix:t(()=>[e(i(Xe))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12},{default:t(()=>[e(u,{label:"Secret Key"},{default:t(()=>[e(_e,{value:o.value.minio.secret_key,"onUpdate:value":a[8]||(a[8]=n=>o.value.minio.secret_key=n),size:"large",placeholder:"secret key"},{prefix:t(()=>[e(i(qe))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(z,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12},{default:t(()=>[e(u,{label:"Base Path (可选)"},{default:t(()=>[e(w,{value:o.value.minio.base_path,"onUpdate:value":a[9]||(a[9]=n=>o.value.minio.base_path=n),size:"large",placeholder:"camera-frames"},{prefix:t(()=>[e(i(B))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12},{default:t(()=>[e(u,{label:"使用 SSL"},{default:t(()=>[e(O,{checked:o.value.minio.use_ssl,"onUpdate:checked":a[10]||(a[10]=n=>o.value.minio.use_ssl=n),size:"large","checked-children":"HTTPS","un-checked-children":"HTTP"},null,8,["checked"])]),_:1})]),_:1})]),_:1})],64)):I("",!0),e(u,null,{default:t(()=>[e(s,{type:"primary",size:"large",onClick:ee,loading:M.value},{icon:t(()=>[e(i(Ge))]),default:t(()=>[a[21]||(a[21]=_(" 保存配置 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(V,{bordered:!1,class:"task-card"},{title:t(()=>[h("span",st,[e(i(et),{class:"title-icon"}),_(" 抽帧任务 ("+x(N.value.length)+") ",1)])]),extra:t(()=>[e(q,null,{default:t(()=>[e(R,{color:o.value.store==="minio"?"blue":"green"},{default:t(()=>[_(x(o.value.store==="minio"?"MinIO存储":"本地存储"),1)]),_:1},8,["color"]),e(s,{type:"primary",onClick:ne},{icon:t(()=>[e(i(Q))]),default:t(()=>[a[22]||(a[22]=_(" 查看抽帧结果 ",-1))]),_:1})]),_:1})]),default:t(()=>[e(V,{class:"add-task-card mb-4",bordered:!1},{default:t(()=>[e(X,{model:d.value,layout:"vertical"},{default:t(()=>[e(z,{gutter:16},{default:t(()=>[e(c,{xs:24,sm:12,md:6},{default:t(()=>[e(u,{label:"任务ID",required:!0},{default:t(()=>[e(w,{value:d.value.id,"onUpdate:value":a[11]||(a[11]=n=>d.value.id=n),size:"large",placeholder:"如 cam1"},{prefix:t(()=>[e(i(He))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:10},{default:t(()=>[e(u,null,{label:t(()=>[h("span",null,[a[24]||(a[24]=_(" RTSP地址 ",-1)),e(S,{title:"从直播列表选择或手动输入"},{default:t(()=>[e(i(W),{style:{"margin-left":"4px",color:"#8c8c8c"}})]),_:1}),e(s,{type:"link",size:"small",onClick:j,style:{"margin-left":"8px"}},{icon:t(()=>[e(i(J))]),default:t(()=>[a[23]||(a[23]=_(" 刷新列表 ",-1))]),_:1})])]),default:t(()=>[e(me,{value:d.value.rtsp_url,"onUpdate:value":a[12]||(a[12]=n=>d.value.rtsp_url=n),options:A.value,size:"large",placeholder:"选择直播流或输入RTSP地址","filter-option":te,onSelect:ae},{prefix:t(()=>[e(i(We))]),_:1},8,["value","options"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:4},{default:t(()=>[e(u,{label:"间隔(ms)"},{default:t(()=>[e(v,{value:d.value.interval_ms,"onUpdate:value":a[13]||(a[13]=n=>d.value.interval_ms=n),min:200,step:100,size:"large",style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:4},{default:t(()=>[e(u,{label:"输出路径"},{default:t(()=>[e(w,{value:d.value.output_path,"onUpdate:value":a[14]||(a[14]=n=>d.value.output_path=n),size:"large",placeholder:"cam1"},{prefix:t(()=>[e(i(B))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(u,null,{default:t(()=>[e(s,{type:"primary",size:"large",onClick:le,loading:$.value},{icon:t(()=>[e(i(Je))]),default:t(()=>[a[25]||(a[25]=_(" 添加任务 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(ve,{"data-source":N.value,columns:Y,"row-key":"id",pagination:{pageSize:10,showTotal:n=>`共 ${n} 条`},scroll:{x:1200}},{bodyCell:t(({column:n,record:p})=>[n.key==="id"?(f(),g(R,{key:0,color:"blue"},{default:t(()=>[_(x(p.id),1)]),_:2},1024)):n.key==="status"?(f(),g(R,{key:1,color:p.enabled?"green":"default"},{default:t(()=>[_(x(p.enabled?"运行中":"已停止"),1)]),_:2},1032,["color"])):n.key==="rtsp_url"?(f(),g(S,{key:2,title:p.rtsp_url},{default:t(()=>[h("span",nt,x(p.rtsp_url),1)]),_:2},1032,["title"])):n.key==="interval_ms"?(f(),g(ce,{key:3,trigger:"click",placement:"bottom"},{content:t(()=>[h("div",it,[e(v,{value:P.value[p.id],"onUpdate:value":ye=>P.value[p.id]=ye,min:200,step:100,style:{width:"100%","margin-bottom":"8px"},placeholder:"新间隔(ms)"},null,8,["value","onUpdate:value"]),e(s,{type:"primary",size:"small",block:"",onClick:()=>pe(p)},{default:t(()=>[...a[26]||(a[26]=[_(" 确认修改 ",-1)])]),_:1},8,["onClick"])])]),default:t(()=>[e(R,{color:"green",style:{cursor:"pointer"}},{default:t(()=>[_(x(p.interval_ms)+"ms ",1),e(i(Z),{style:{"font-size":"10px"}})]),_:2},1024)]),_:2},1024)):n.key==="output_path"?(f(),F("span",ut,[e(i(B)),_(" "+x(p.output_path),1)])):n.key==="action"?(f(),g(q,{key:5},{default:t(()=>[e(S,{title:p.enabled?"停止抽帧":"启动抽帧"},{default:t(()=>[e(s,{type:p.enabled?"default":"primary",size:"small",onClick:()=>p.enabled?re(p.id):ue(p.id),loading:T.value[p.id]},{icon:t(()=>[p.enabled?(f(),g(i(Ze),{key:0})):(f(),g(i(Qe),{key:1}))]),_:2},1032,["type","onClick","loading"])]),_:2},1032,["title"]),e(S,{title:"查看快照"},{default:t(()=>[e(s,{type:"default",size:"small",onClick:()=>ie(p.id)},{icon:t(()=>[e(i(Q))]),_:1},8,["onClick"])]),_:2},1024),e(S,{title:"编辑"},{default:t(()=>[e(s,{type:"primary",size:"small",onClick:()=>oe(p)},{icon:t(()=>[e(i(Z))]),_:1},8,["onClick"])]),_:2},1024),e(fe,{title:"确认删除?","ok-text":"删除","cancel-text":"取消",onConfirm:()=>se(p.id)},{description:t(()=>[h("div",rt,[o.value.store==="minio"?(f(),g(r,{key:0,message:"将同时删除MinIO中的所有文件",type:"warning","show-icon":"",banner:!0,style:{"margin-bottom":"8px"}})):I("",!0),a[27]||(a[27]=_(" 此操作不可恢复，确认删除任务 ",-1)),h("strong",null,x(p.id),1),a[28]||(a[28]=_(" 吗？ ",-1))])]),default:t(()=>[e(s,{danger:"",size:"small"},{icon:t(()=>[e(i(Ye))]),_:1})]),_:2},1032,["onConfirm"])]),_:2},1024)):I("",!0)]),_:1},8,["data-source","pagination"])]),_:1})])}}},Xt=ke(pt,[["__scopeId","data-v-db8e3659"]]);export{Xt as default};
