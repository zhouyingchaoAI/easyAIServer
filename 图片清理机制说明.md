# 图片清理机制说明

## ✅ 功能确认

**好消息**：代码已经实现了**按每个任务分别限制**的功能！

## 📋 工作原理

### 1. 按任务分别限制

代码逻辑：
- `cleanupOldFrames(task, maxCount)` 函数接收**单个任务**作为参数
- 通过 `prefix = 任务类型/任务ID/` 来限制清理范围
- 每个任务上传图片后，都会调用 `getMaxFrameCount(task, s.cfg)` 获取**该任务**的最大数量限制

**示例**：
```
任务"测试1"：最多保留1000张图片
任务"测试2"：最多保留1000张图片
任务"门口1"：最多保留1000张图片
...
```

**不是**所有任务加起来1000张，而是**每个任务分别1000张**！

### 2. 配置优先级

```go
func getMaxFrameCount(task conf.FrameExtractTask, cfg *conf.FrameExtractorConfig) int {
	// 如果任务级配置大于0，使用任务级配置
	if task.MaxFrameCount > 0 {
		return task.MaxFrameCount
	}
	// 否则使用全局配置
	return cfg.MaxFrameCount
}
```

**优先级**：
1. 任务级配置（如果设置了 `max_frame_count > 0`）
2. 全局配置（`[frame_extractor]` 中的 `max_frame_count`）

### 3. 清理触发机制

每个任务独立触发清理：
- **触发条件1**：该任务累计上传50张图片
- **触发条件2**：距离该任务上次清理超过5分钟
- **强制触发**：如果该任务的图片数量已超过限制，立即触发清理

### 4. 清理范围

```go
// 构建任务目录前缀
prefix := filepath.ToSlash(filepath.Join(s.minio.base, taskType, task.ID)) + "/"
```

清理只针对该任务的目录：
- `人数统计/测试1/` - 只清理这个目录下的图片
- `人数统计/测试2/` - 只清理这个目录下的图片
- 不会跨任务清理

## 📝 配置示例

### 全局配置（所有任务默认1000张）

```toml
[frame_extractor]
max_frame_count = 1000  # 每个任务最多保留1000张
```

### 任务级配置（可选）

如果需要为特定任务设置不同的限制：

```toml
[[frame_extractor.tasks]]
id = '测试1'
task_type = '人数统计'
rtsp_url = 'rtsp://...'
interval_ms = 200
output_path = '测试1'
enabled = true
max_frame_count = 500  # 此任务最多保留500张（覆盖全局配置）

[[frame_extractor.tasks]]
id = '测试2'
task_type = '人数统计'
rtsp_url = 'rtsp://...'
interval_ms = 200
output_path = '测试2'
enabled = true
# 不设置max_frame_count，使用全局配置1000张
```

## 🔍 验证方法

### 1. 查看日志

清理操作会在日志中记录：
```
deleted old frame, task=测试1, deleted_count=50, remaining_count=1000
```

### 2. 检查MinIO

每个任务的图片数量应该稳定在配置的上限附近：
- `人数统计/测试1/` - 约1000张
- `人数统计/测试2/` - 约1000张
- `人数统计/门口1/` - 约1000张

### 3. 监控指标

可以通过API或监控接口查看每个任务的图片数量。

## ✅ 总结

**当前配置是正确的**：
- ✅ 每个任务分别限制1000张
- ✅ 当某个任务超过1000张时，自动删除该任务最旧的图片
- ✅ 不同任务之间互不影响
- ✅ 支持任务级配置覆盖全局配置

**配置已更新**：添加了更清晰的注释说明这是按任务分别限制的。

---

**更新时间**：2025年11月19日

