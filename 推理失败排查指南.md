# ç®—æ³•æ¨ç†å¤±è´¥æ’æŸ¥æŒ‡å—

## ğŸ” æ¨ç†æµç¨‹

```
å›¾ç‰‡æŠ½å¸§ â†’ MinIOå­˜å‚¨ â†’ æ‰«æå‘ç° â†’ è°ƒåº¦æ¨ç† â†’ ç®—æ³•æœåŠ¡ â†’ ä¿å­˜ç»“æœ
```

æ¨ç†å¯èƒ½åœ¨ä»»ä½•ä¸€ä¸ªç¯èŠ‚å¤±è´¥ã€‚

---

## ğŸ“‹ å¸¸è§å¤±è´¥åŸå› 

### 1. **æ²¡æœ‰ç®—æ³•æœåŠ¡æ³¨å†Œ**

**ç—‡çŠ¶**ï¼š
```
no algorithm for task type, deleting image
  task_type=äººæ•°ç»Ÿè®¡
```

**åŸå› **ï¼š
- æ²¡æœ‰æ³¨å†Œæ”¯æŒè¯¥ä»»åŠ¡ç±»å‹çš„ç®—æ³•æœåŠ¡
- æˆ–æ‰€æœ‰æœåŠ¡éƒ½è¢«æ¸…ç†äº†

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥æ³¨å†Œçš„æœåŠ¡
curl http://localhost:5066/api/v1/ai_analysis/services

# ç¡®ä¿ç®—æ³•æœåŠ¡ï¼š
# 1. æ­£åœ¨è¿è¡Œ
# 2. è°ƒç”¨äº†æ³¨å†ŒAPI
# 3. åœ¨å‘é€å¿ƒè·³
```

### 2. **MinIOé¢„ç­¾åURLç”Ÿæˆå¤±è´¥**

**ç—‡çŠ¶**ï¼š
```
failed to generate presigned URL after retries
  path=äººæ•°ç»Ÿè®¡/task1/frame_001.jpg
  err=...
```

**åŸå› **ï¼š
- MinIOè¿æ¥é—®é¢˜
- Bucketä¸å­˜åœ¨
- æƒé™é—®é¢˜

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥MinIOé…ç½®
grep -A 5 "\[frame_extractor.minio\]" configs/config.toml

# æµ‹è¯•MinIOè¿æ¥
curl http://MinIOåœ°å€:9000/minio/health/live
```

### 3. **ç®—æ³•æœåŠ¡è°ƒç”¨å¤±è´¥**

**ç—‡çŠ¶**ï¼š
```
algorithm inference failed
  algorithm=head_detector_7902
  err=Post "http://...": dial tcp: connection refused
```

**åŸå› **ï¼š
- ç®—æ³•æœåŠ¡å®•æœº
- endpointé…ç½®é”™è¯¯
- ç½‘ç»œä¸é€š

**è§£å†³**ï¼š
```bash
# æµ‹è¯•ç®—æ³•æœåŠ¡
curl http://172.16.5.207:7902/health

# æµ‹è¯•æ¨ç†æ¥å£
curl -X POST http://172.16.5.207:7902/infer \
  -H "Content-Type: application/json" \
  -d '{"task_id":"test","task_type":"äººæ•°ç»Ÿè®¡","image_url":"http://..."}'
```

### 4. **æ¨ç†è¿”å›å¤±è´¥**

**ç—‡çŠ¶**ï¼š
```
inference not successful
  error=ç¼ºå°‘image_urlå‚æ•°
```

**åŸå› **ï¼š
- ç®—æ³•æœåŠ¡è¿”å› `{"success": false}`
- å‚æ•°é”™è¯¯æˆ–ç®—æ³•å†…éƒ¨é”™è¯¯

**è§£å†³**ï¼š
- æŸ¥çœ‹ç®—æ³•æœåŠ¡æ—¥å¿—
- æ£€æŸ¥è¯·æ±‚å‚æ•°æ ¼å¼

### 5. **æ— æ£€æµ‹ç»“æœï¼ˆæ­£å¸¸æƒ…å†µï¼‰**

**ç—‡çŠ¶**ï¼š
```
no detection result, deleting image
  detection_count=0
```

**åŸå› **ï¼š
- å›¾ç‰‡ä¸­ç¡®å®æ²¡æœ‰æ£€æµ‹ç›®æ ‡
- è¿™æ˜¯æ­£å¸¸ç°è±¡

**é…ç½®**ï¼š
```toml
[ai_analysis]
save_only_with_detection = true  # æ— æ£€æµ‹ç»“æœæ—¶åˆ é™¤å›¾ç‰‡
```

---

## ğŸ“Š æ¨ç†æˆåŠŸçš„æ—¥å¿—

**å®Œæ•´çš„æˆåŠŸæ—¥å¿—åº”è¯¥åŒ…å«**ï¼š

```
1. è°ƒåº¦å¼€å§‹:
scheduling inference
  image=äººæ•°ç»Ÿè®¡/task1/frame_001.jpg
  task_type=äººæ•°ç»Ÿè®¡
  algorithm=service_7902
  endpoint=http://...:7902/infer

2. æ¨ç†è¯·æ±‚:
æ”¶åˆ°æ¨ç†è¯·æ±‚
  ä»»åŠ¡ID=task1
  ä»»åŠ¡ç±»å‹=äººæ•°ç»Ÿè®¡
  å›¾ç‰‡URL=http://minio/...?X-Amz-Signature=...

3. æ¨ç†ç»“æœ:
inference result received
  detection_count=5
  confidence=0.95
  inference_time_ms=234

4. å‘Šè­¦ä¿å­˜:
alert saved to database
  alert_id=123
  task_id=task1
  detection_count=5
```

---

## ğŸ”§ è°ƒè¯•æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥æœåŠ¡æ³¨å†Œ

```bash
curl http://localhost:5066/api/v1/ai_analysis/services
```

**é¢„æœŸ**ï¼šåº”è¯¥çœ‹åˆ°è‡³å°‘1ä¸ªæœåŠ¡

### æ­¥éª¤2ï¼šæ£€æŸ¥æ¨ç†ç»Ÿè®¡

```bash
curl http://localhost:5066/api/v1/ai_analysis/inference_stats
```

**å…³é”®å­—æ®µ**ï¼š
- `total_inferences`: æ€»æ¨ç†æ¬¡æ•°
- `failed_inferences`: å¤±è´¥æ¬¡æ•°  
- `avg_inference_time_ms`: å¹³å‡è€—æ—¶

### æ­¥éª¤3ï¼šæŸ¥çœ‹è¯¦ç»†æ—¥å¿—

**åœ¨å®¿ä¸»æœºæˆ–èƒ½è®¿é—®æ—¥å¿—çš„åœ°æ–¹**ï¼š

```bash
# æŸ¥æ‰¾æ—¥å¿—æ–‡ä»¶
find /code/EasyDarwin -name "sugar.log" -o -name "20*.log"

# æŸ¥çœ‹æ¨ç†ç›¸å…³æ—¥å¿—
tail -100 {æ—¥å¿—æ–‡ä»¶} | grep -E "inference|algorithm|è°ƒåº¦|æ¨ç†"
```

**å…³é”®æ—¥å¿—æ ‡è¯†**ï¼š
- âœ… `scheduling inference` - å¼€å§‹è°ƒåº¦
- âœ… `inference result received` - æ”¶åˆ°ç»“æœ
- âŒ `algorithm inference failed` - è°ƒç”¨å¤±è´¥
- âŒ `inference not successful` - è¿”å›å¤±è´¥
- âš ï¸  `no algorithm for task type` - æ— åŒ¹é…ç®—æ³•

### æ­¥éª¤4ï¼šæ£€æŸ¥MinIOè¿æ¥

```bash
# ä»å®¹å™¨å†…æµ‹è¯•
timeout 3 bash -c 'cat < /dev/null > /dev/tcp/MinIOåœ°å€/9000'

# é¢„æœŸï¼šåº”è¯¥æˆåŠŸè¿æ¥
```

### æ­¥éª¤5ï¼šæµ‹è¯•ç®—æ³•æœåŠ¡

```bash
# æ£€æŸ¥æœåŠ¡å¥åº·
curl http://172.16.5.207:7902/health

# æ‰‹åŠ¨è°ƒç”¨æ¨ç†
curl -X POST http://172.16.5.207:7902/infer \
  -H "Content-Type: application/json" \
  -d '{
    "task_id": "test",
    "task_type": "äººæ•°ç»Ÿè®¡",
    "image_url": "http://example.com/test.jpg"
  }'
```

---

## ğŸ¯ å¿«é€Ÿè¯Šæ–­

åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶æŸ¥çœ‹å®Œæ•´çš„æ¨ç†è¿‡ç¨‹ï¼š

```bash
# åœ¨å®¿ä¸»æœºè¿è¡Œ
cat > /tmp/test_inference.sh << 'EOF'
#!/bin/bash
EASYDARWIN="http://172.16.5.207:5066"

echo "1. æ£€æŸ¥æœåŠ¡æ³¨å†Œ"
curl -s "$EASYDARWIN/api/v1/ai_analysis/services" | python3 -m json.tool

echo -e "\n2. æ£€æŸ¥æ¨ç†ç»Ÿè®¡"
curl -s "$EASYDARWIN/api/v1/ai_analysis/inference_stats" | python3 -m json.tool

echo -e "\n3. æ£€æŸ¥å‘Šè­¦æ•°é‡"
curl -s "$EASYDARWIN/api/v1/alerts?page=1&page_size=1" | python3 -m json.tool

echo -e "\n4. æ£€æŸ¥MinIOæ‰«æ"
# æŸ¥çœ‹æœ€è¿‘çš„æ‰«ææ—¥å¿—
tail -50 /code/EasyDarwin/build/*/logs/*.log 2>/dev/null | grep -E "scan|å‘ç°å›¾ç‰‡|images found"
EOF

chmod +x /tmp/test_inference.sh
bash /tmp/test_inference.sh
```

---

## ğŸ’¡ å¸¸è§é—®é¢˜å’Œè§£å†³

| é—®é¢˜ | æ—¥å¿—ç‰¹å¾ | è§£å†³æ–¹æ³• |
|------|---------|---------|
| MinIOè¿æ¥å¤±è´¥ | `failed to generate presigned URL` | æ£€æŸ¥MinIOé…ç½®å’Œç½‘ç»œ |
| æ— ç®—æ³•æœåŠ¡ | `no algorithm for task type` | ç¡®ä¿æœåŠ¡æ³¨å†Œä¸”å¿ƒè·³æ­£å¸¸ |
| ç®—æ³•æœåŠ¡å®•æœº | `connection refused` | é‡å¯ç®—æ³•æœåŠ¡ |
| å‚æ•°é”™è¯¯ | `ç¼ºå°‘xxxå‚æ•°` | æ£€æŸ¥ç®—æ³•æœåŠ¡å®ç° |
| è¶…æ—¶ | `context deadline exceeded` | å¢åŠ è¶…æ—¶æ—¶é—´æˆ–ä¼˜åŒ–ç®—æ³• |

---

## ğŸš€ æ¨èé…ç½®

```toml
[ai_analysis]
enable = true
scan_interval_sec = 5              # MinIOæ‰«æé—´éš”
heartbeat_timeout_sec = 90         # æœåŠ¡å¿ƒè·³è¶…æ—¶
max_concurrent_infer = 100         # æœ€å¤§å¹¶å‘æ•°
max_queue_size = 500               # é˜Ÿåˆ—å®¹é‡
save_only_with_detection = true    # åªä¿å­˜æœ‰æ£€æµ‹ç»“æœçš„
```

---

**è¯·æä¾›**ï¼š
1. æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆsugar.logæˆ–å…¶ä»–.logï¼‰
2. æˆ–è¿è¡Œï¼š`bash /code/EasyDarwin/å½»åº•è°ƒè¯•.sh`ï¼ˆåœ¨å®¿ä¸»æœºï¼‰

è¿™æ ·æˆ‘æ‰èƒ½å‡†ç¡®å®šä½æ¨ç†å¤±è´¥çš„åŸå› ï¼

