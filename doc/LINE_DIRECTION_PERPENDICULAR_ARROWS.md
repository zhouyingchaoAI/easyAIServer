# 线条方向检测 - 垂直箭头设计

## 🎯 设计理念

箭头**垂直于检测线**，清晰表示目标穿越线条的方向。这种设计更符合跨线检测的实际应用场景。

## 📐 垂直箭头原理

### 传统设计 vs 垂直箭头设计

```
❌ 传统设计（箭头沿着线条）：
    ════════════→
    不够直观

✅ 垂直箭头设计（箭头垂直线条）：
         ↓
    ═════════════
    清晰表示穿越方向
```

### 三种检测方向

#### 1️⃣ 进入（in）
```
目标从上方穿过线条进入下方

         ↓  箭头垂直向下
    ─────────────────
    
检测：上方区域 → 穿过线条 → 下方区域
```

#### 2️⃣ 离开（out）
```
目标从下方穿过线条离开到上方

    ─────────────────
         ↑  箭头垂直向上
    
检测：下方区域 → 穿过线条 → 上方区域
```

#### 3️⃣ 进出（in_out）
```
双向检测

    ↓         ↑
    ─────────────────
    
检测：任意方向穿过线条
```

## 🎨 视觉效果

### 水平线条

```
进入:
      ↓
━━━━━━━━━━━━━

离开:
━━━━━━━━━━━━━
      ↑

进出:
   ↓     ↑
━━━━━━━━━━━━━
```

### 垂直线条

```
进入:        离开:        进出:
             ┃            ┃
  ┃  →       ┃  ←      ← ┃ →
  ┃          ┃            ┃
```

### 斜线

```
进入:         离开:         进出:
   ╲            ╲             ╲
    ↙            ↗          ↙  ↗
     ╲            ╲             ╲
```

## 💻 技术实现

### 核心算法

```javascript
// 1. 计算线条角度
const lineAngle = Math.atan2(p2[1] - p1[1], p2[0] - p1[0])

// 2. 计算垂直方向（逆时针90度 = 向上）
const perpAngleUp = lineAngle - Math.PI / 2

// 3. 计算垂直方向（顺时针90度 = 向下）
const perpAngleDown = lineAngle + Math.PI / 2

// 4. 根据配置绘制箭头
if (direction === 'in') {
  createArrow(midX, midY, perpAngleDown, color)  // 向下
} else if (direction === 'out') {
  createArrow(midX, midY, perpAngleUp, color)    // 向上
}
```

### 数学原理

```
线条角度: θ
垂直向上: θ - 90° = θ - π/2
垂直向下: θ + 90° = θ + π/2

示例：
- 水平线（θ=0°）: 垂直向下=90°，垂直向上=-90°
- 垂直线（θ=90°）: 垂直向下=180°，垂直向上=0°
- 斜线45°（θ=45°）: 垂直向下=135°，垂直向上=-45°
```

## 📋 使用指南

### 1. 绘制检测线

```
步骤1: 点击"绘制线"
步骤2: 在画布上点击起点
步骤3: 点击终点完成
步骤4: 自动显示默认箭头（进入方向）
```

### 2. 配置检测方向

```
右侧配置面板 → 检测方向下拉框：

⬇ 进入（上→下穿过）
⬆ 离开（下→上穿过）
⬍ 进出（双向穿过）
```

### 3. 理解方向含义

```
关键概念：
- "上" = 线条法线正方向一侧
- "下" = 线条法线负方向一侧
- 箭头指向 = 目标移动方向
```

## 🎯 应用场景

### 场景1: 门禁进出检测

```
┌─────────────┐
│   室内区域   │
│             │
│    ↓↓↓↓     │ ← 进入检测
├─────────────┤ ── 检测线
     室外
```

配置：
- 线条：横向绘制门口
- 方向：进入（向下）
- 含义：从外面进入室内

### 场景2: 双向客流统计

```
     商场内部
─────────────── ← 检测线
  ↑↑↑  ↓↓↓
  出   进
     入口处
```

配置：
- 线条：入口中央横向绘制
- 方向：进出（双向）
- 含义：统计进出人数

### 场景3: 禁行区域监控

```
  合法区域
─────────────── ← 检测线
      ↓
  禁行区域
```

配置：
- 线条：禁行区边界
- 方向：进入（向下）
- 含义：只检测非法进入

### 场景4: 传送带方向监控

```
    传送带移动方向 ↓
         ┃
    ─────┼───── ← 检测线（横向）
         ┃        箭头垂直向下
         ↓
```

配置：
- 线条：横向穿过传送带
- 方向：进入（向下）
- 含义：物品通过检测

## 🔧 高级配置

### 1. 斜线检测

```
对于斜线，箭头依然垂直于线条：

     ╲
      ↙ 箭头垂直于斜线
       ╲

适用场景：
- 楼梯监控
- 斜坡检测
- 对角通道
```

### 2. 多线组合

```
场景：双门禁系统

入口门:          出口门:
  ↓                ↑
─────            ─────
进入检测         离开检测
```

### 3. 环形检测

```
    ─────
   ↓     ↑
  │       │
   ─────

四条线组成环形
分别配置方向
实现区域进出统计
```

## ⚙️ 配置选项

### 方向选项对比

| 配置值 | 显示文本 | 箭头方向 | 检测方式 | 适用场景 |
|--------|---------|---------|---------|---------|
| `in` | ⬇ 进入 | 垂直向下 | 单向上→下 | 入口、进入区 |
| `out` | ⬆ 离开 | 垂直向上 | 单向下→上 | 出口、离开区 |
| `in_out` | ⬍ 进出 | 双向箭头 | 双向检测 | 通道、统计 |

### 数据结构

```json
{
  "id": "region_123",
  "type": "line",
  "properties": {
    "direction": "in",  // "in" | "out" | "in_out"
    "color": "#FF0000",
    "thickness": 3
  },
  "points": [[100, 200], [400, 300]]
}
```

## 🎓 理解技巧

### 技巧1: 想象目标移动

```
问：如何判断配置哪个方向？

答：想象目标的移动轨迹
   从哪里来 → 穿过线条 → 到哪里去
   
示例：
   人从门外(上) → 穿过门框线 → 进入室内(下)
   配置：进入(in)
```

### 技巧2: 箭头指向即目标方向

```
箭头↓ = 目标向下移动穿过线条
箭头↑ = 目标向上移动穿过线条
```

### 技巧3: 线条的"上下"定义

```
线条有两侧：
- 法线正方向一侧 = "上"
- 法线负方向一侧 = "下"

实际使用时：
- 根据画面方位理解即可
- 箭头已经清晰指示方向
```

## 📊 配置示例

### 示例1: 商场入口

```json
{
  "name": "商场入口",
  "type": "line",
  "points": [[50, 300], [450, 300]],  // 横线
  "properties": {
    "direction": "in",     // 进入
    "color": "#00FF00"
  }
}

效果：
  室外(上方)
      ↓
─────────────  绿色线条
  商场内(下方)
```

### 示例2: 消防通道

```json
{
  "name": "消防通道出口",
  "type": "line",
  "points": [[200, 100], [200, 500]],  // 竖线
  "properties": {
    "direction": "out",    // 离开
    "color": "#FF0000"
  }
}

效果：
通道内 ┃→ 红色线条
       ┃  箭头向右
  室外  ┃
```

### 示例3: 双向通道

```json
{
  "name": "公共走廊",
  "type": "line",
  "points": [[100, 250], [500, 250]],
  "properties": {
    "direction": "in_out",  // 双向
    "color": "#0000FF"
  }
}

效果：
  区域A
 ↓     ↑
───────── 蓝色线条
  区域B
```

## 🔄 版本兼容

### 旧配置自动转换

```javascript
旧值 → 新值：
left_to_right  → in      (左到右 → 进入)
right_to_left  → out     (右到左 → 离开)
bidirectional  → in_out  (双向 → 进出)
```

### 兼容性说明

- ✅ 自动识别旧配置
- ✅ 无需手动迁移
- ✅ 保存时使用新格式
- ✅ 向后兼容

## ⚠️ 注意事项

### 1. 方向理解

```
⚠️ "进入"和"离开"是相对于线条两侧的
   不是相对于画面的绝对方向

💡 建议：
   - 根据箭头方向理解
   - 结合实际场景命名
   - 测试验证配置正确
```

### 2. 斜线情况

```
斜线的"上下"概念：
   ╲
    ↙ 垂直于斜线的方向
     ╲

理解方式：
- 以线条为基准
- 箭头垂直于线条
- 指示穿越方向
```

### 3. 多线配合

```
复杂场景建议：
1. 每条线单独配置
2. 使用描述性名称
3. 不同方向用不同颜色
4. 测试验证逻辑正确
```

## 🎯 最佳实践

### 命名规范

```
✅ 好的命名：
- "入口_进入检测"
- "出口_离开检测"
- "通道_双向统计"

❌ 不好的命名：
- "线_1"
- "line"
- "test"
```

### 颜色方案

```
建议：
🟢 绿色 - 进入检测
🔴 红色 - 离开检测
🔵 蓝色 - 双向统计
🟡 黄色 - 警戒区域
```

### 测试验证

```
配置完成后：
1. 观察箭头方向是否符合预期
2. 想象目标移动轨迹
3. 确认检测逻辑正确
4. 实际测试验证
```

## 📈 技术优势

### 对比传统方案

| 特性 | 传统方案 | 垂直箭头方案 |
|------|---------|------------|
| 直观性 | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| 易理解 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 配置难度 | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| 适用场景 | 受限 | 广泛 |

### 实际优势

1. **更直观** - 箭头直接指示穿越方向
2. **易理解** - 符合物理直觉
3. **少歧义** - 方向明确清晰
4. **好调试** - 可视化效果好

## 🆘 常见问题

### Q1: 箭头方向看起来不对？

```
A: 检查以下几点：
1. 线条绘制方向是否正确
2. 配置的方向选项是否正确
3. 理解"上下"是相对线条的，不是画面的
4. 可以切换方向选项观察效果
```

### Q2: 双向箭头位置重叠？

```
A: 已优化：
- 双向箭头会自动分开
- 沿线条方向间隔20像素
- 一个向上，一个向下
```

### Q3: 斜线的箭头方向奇怪？

```
A: 正常现象：
- 箭头永远垂直于线条
- 斜线的垂直方向也是斜的
- 这正是垂直检测的准确体现
```

## 📚 参考资料

- [LINE_DIRECTION_FEATURE.md](./LINE_DIRECTION_FEATURE.md) - 原功能文档
- [LINE_DIRECTION_QUICK_GUIDE.md](./LINE_DIRECTION_QUICK_GUIDE.md) - 快速指南

---

**版本**: v2.0 - 垂直箭头设计  
**更新时间**: 2025-10-20  
**改进**: 箭头垂直于线条，更直观表示穿越方向

