# 快照数量累积问题分析报告

## 一、问题现象

快照抽帧数量一直累积，无法控制在`max_frame_count`限制内。

## 二、可能的原因分析

### 2.1 清理速度 < 图片生成速度

**问题**：
- 图片生成速度: 67张/秒（15个任务）
- 清理速度: 取决于清理频率和每次清理的数量
- 如果清理速度跟不上，图片会持续累积

**分析**：
- 需要检查实际的清理速度
- 对比生成速度和清理速度
- 如果清理速度 < 生成速度，图片会持续累积

### 2.2 清理机制跳过太多图片

**问题**：
- 如果正在推理的图片太多，清理时会跳过这些图片
- 导致实际删除的图片很少
- 清理效果差，图片数量持续增长

**分析**：
- 检查清理时删除数量 vs 跳过数量
- 如果跳过数量 >> 删除数量，说明清理效果差
- 可能原因：正在推理的图片太多，或者保护机制过于激进

### 2.3 清理频率过低

**问题**：
- 当前清理触发条件：每50张图片或5分钟
- 如果图片生成速度快，可能触发不够频繁
- 导致图片数量超过限制后才清理

**分析**：
- 检查清理频率
- 如果清理间隔过长，可能需要增加清理频率
- 或者，减少清理触发阈值

### 2.4 max_frame_count配置问题

**问题**：
- 某些任务可能没有配置`max_frame_count`
- 或者配置为0（不限制）
- 导致图片无限累积

**分析**：
- 检查各任务的`max_frame_count`配置
- 确保所有任务都配置了限制
- 确保全局配置有默认值

### 2.5 清理机制和推理的时间竞争

**问题**：
- 图片在队列中等待时被清理
- 但清理后，扫描器可能重新发现这些图片
- 导致图片数量无法减少

**分析**：
- 检查扫描器是否重新发现已清理的图片
- 检查图片标记机制是否正常工作
- 确保已清理的图片不会被重新扫描

## 三、关键数据检查

### 3.1 需要检查的数据

1. **各任务的max_frame_count配置**
   - 是否有任务没有配置
   - 是否有任务配置为0

2. **图片生成速度 vs 清理速度**
   - 生成速度：从上传日志分析
   - 清理速度：从清理日志分析
   - 对比两者，找出差距

3. **清理时删除数量 vs 跳过数量**
   - 删除数量：实际删除的图片
   - 跳过数量：正在推理的图片
   - 如果跳过 >> 删除，说明清理效果差

4. **清理频率**
   - 清理间隔：多长时间清理一次
   - 清理触发条件：是否足够频繁

5. **剩余数量变化趋势**
   - 剩余数量是否在增长
   - 是否超过限制
   - 增长速度如何

### 3.2 关键指标

- **清理效果率** = 删除数量 / (删除数量 + 跳过数量)
- **清理速度** = 删除数量 / 时间
- **生成速度** = 上传数量 / 时间
- **速度差** = 生成速度 - 清理速度

## 四、问题诊断流程

### 4.1 第一步：检查配置

1. 检查各任务的`max_frame_count`配置
2. 检查全局`max_frame_count`配置
3. 确认是否有任务没有限制

### 4.2 第二步：分析速度

1. 分析图片生成速度
2. 分析清理速度
3. 对比两者，找出差距

### 4.3 第三步：分析清理效果

1. 分析删除数量 vs 跳过数量
2. 计算有效清理率
3. 如果有效清理率低，说明跳过太多

### 4.4 第四步：分析清理频率

1. 分析清理间隔
2. 检查清理触发条件
3. 如果间隔过长，可能需要增加频率

### 4.5 第五步：分析剩余数量趋势

1. 分析剩余数量变化
2. 检查是否超过限制
3. 分析增长速度

## 五、可能的问题场景

### 5.1 场景1：清理速度 < 生成速度

**现象**：
- 生成速度: 67张/秒
- 清理速度: 10张/秒
- 速度差: 57张/秒

**结果**：
- 图片持续累积
- 即使清理机制正常工作，也无法跟上生成速度

**解决方案**：
- 增加清理频率
- 或者，减少图片生成速度（降低抽帧频率）

### 5.2 场景2：清理时跳过太多

**现象**：
- 删除数量: 10张
- 跳过数量: 1000张
- 有效清理率: 1%

**结果**：
- 清理效果很差
- 实际删除的图片很少
- 图片数量持续增长

**解决方案**：
- 优化保护机制（只保护正在推理的图片，已优化）
- 或者，提高推理速度，减少正在推理的图片数量

### 5.3 场景3：清理频率过低

**现象**：
- 清理间隔: 5分钟
- 图片生成速度: 67张/秒
- 5分钟内生成: 20100张

**结果**：
- 图片数量快速超过限制
- 清理机制无法及时清理

**解决方案**：
- 增加清理频率（减少清理间隔）
- 或者，减少清理触发阈值

### 5.4 场景4：配置问题

**现象**：
- 某些任务没有配置`max_frame_count`
- 或者配置为0

**结果**：
- 这些任务的图片无限累积
- 无法控制数量

**解决方案**：
- 确保所有任务都配置了`max_frame_count`
- 确保全局配置有默认值

## 六、诊断建议

### 6.1 立即检查

1. ✅ 检查各任务的`max_frame_count`配置
2. ✅ 分析清理日志，查看删除数量 vs 跳过数量
3. ✅ 分析图片生成速度 vs 清理速度
4. ✅ 检查剩余数量变化趋势

### 6.2 关键指标

- **有效清理率** < 30%：说明跳过太多，清理效果差
- **清理速度** < 生成速度：说明清理跟不上生成
- **剩余数量** > 限制：说明清理机制失效
- **清理间隔** > 60秒：说明清理频率过低

### 6.3 问题优先级

1. 🔴 **最高优先级**：检查配置，确保所有任务都有`max_frame_count`限制
2. ⚠️ **高优先级**：分析清理速度 vs 生成速度
3. ⚠️ **中优先级**：分析清理效果（删除 vs 跳过）
4. ⚠️ **低优先级**：分析清理频率

## 七、总结

### 7.1 核心问题

快照数量累积，无法控制在`max_frame_count`限制内。

### 7.2 可能原因

1. 清理速度 < 生成速度
2. 清理时跳过太多图片
3. 清理频率过低
4. 配置问题（没有限制）
5. 清理机制和推理的时间竞争

### 7.3 诊断方向

1. 检查配置
2. 分析速度对比
3. 分析清理效果
4. 分析清理频率
5. 分析剩余数量趋势

