import{u as xe}from"./vue-router-wJF_rOwP.1760596094000.js";import"./request-CoWACYU5.1760596094000.js";import{l as H}from"./live-J1Sr8yos.1760596094000.js";import{f as x}from"./frameextractor-CeE7Hjry.1760596094000.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.1760596094000.js";import{m as he,k as c,a2 as Te,F as Ce,V as Oe,X as Se,v as ze,S as Ie,h as Ue,g as Pe,f as Le,I as Re,z as $e,c as Be,w as Me,B as Ne,a3 as Ae,a1 as De,T as Ve,$ as Fe,t as Ee,K as Ke}from"./ant-design-vue-D8I8zMbk.1760596094000.js";import{y as $,aa as je,x as qe,ab as W,ac as Xe,I as J,ad as Ge,ae as He,X as We,af as Je,N as Z,ag as Ze,ah as Qe,P as Ye,a4 as Q,ai as et,a3 as tt,aj as Y,A as at,ak as lt}from"./@ant-design-Xil9Y0Mc.1760596094000.js";import{r as k,j as st,Z as B,c as e,X as t,W as v,V as y,a1 as P,J as d,u as i,F as ee,$ as h,_ as ot,a3 as b}from"./vue-DcFgi5qX.1760596094000.js";import"./axios-ngrFHoWO.1760596094000.js";import"./qs-m7ADN_Ca.1760596094000.js";import"./clipboard-DnI0MzOy.1760596094000.js";import"./side-channel-7ObsPEGz.1760596094000.js";import"./crypto-js-BptWzl5V.1760596094000.js";import"./index-DKAquY-M.1760596094000.js";import"./vue-i18n-D34mLbx9.1760596094000.js";import"./@intlify-C7-MzqOv.1760596094000.js";import"./nprogress-CSkLUarA.1760596094000.js";/* empty css                                  */import"./dayjs-7sxDqJU0.1760596094000.js";import"./pinia-DDAUOP-W.1760596094000.js";import"./pinia-plugin-persistedstate-n2tMOXAx.1760596094000.js";import"./lodash-es-C9rdhAyu.1760596094000.js";import"./@iconify-CZ5U7IZZ.1760596094000.js";import"./@babel-Bq4_u9L9.1760596094000.js";import"./@ctrl-DOFZgDuz.1760596094000.js";import"./resize-observer-polyfill-B1PUzC5B.1760596094000.js";import"./dom-align-CRCehRfe.1760596094000.js";import"./async-validator-9PlIezaS.1760596094000.js";import"./scroll-into-view-if-needed-B3z4cY-J.1760596094000.js";import"./throttle-debounce-CUWDS_la.1760596094000.js";import"./vue-types-CF28atMM.1760596094000.js";import"./@emotion-BtrR-yrm.1760596094000.js";import"./stylis-D5iaQeiq.1760596094000.js";const nt={class:"p-4 frame-extractor-container"},it={class:"card-title"},ut={class:"card-title"},rt={class:"rtsp-url"},pt={style:{width:"200px"}},dt={key:5},_t={style:{"max-width":"250px"}},ct={__name:"index",setup(mt){const K=xe(),o=k({enable:!0,interval_ms:1e3,output_dir:"./snapshots",store:"local",minio:{endpoint:"",bucket:"",access_key:"",secret_key:"",use_ssl:!1,base_path:""}}),r=k({id:"",task_type:"",rtsp_url:"",interval_ms:1e3,output_path:""}),M=k(!1),N=k(!1),L=k(!1),A=k([]),S=k({}),R=k({}),j=k([]),D=k([]),V=k([]),te=[{title:"任务ID",key:"id",width:120},{title:"任务类型",key:"task_type",width:120},{title:"状态",key:"status",width:100},{title:"RTSP地址",key:"rtsp_url",ellipsis:!0},{title:"间隔",key:"interval_ms",width:100},{title:"操作",key:"action",width:280,fixed:"right"}],F=async()=>{try{const{data:l}=await x.getConfig();console.log("fetched config from server:",l),l&&((!l.minio||typeof l.minio!="object")&&(l.minio={endpoint:"",bucket:"",access_key:"",secret_key:"",use_ssl:!1,base_path:""}),o.value={enable:l.enable!==void 0?l.enable:o.value.enable,interval_ms:l.interval_ms||o.value.interval_ms,output_dir:l.output_dir||o.value.output_dir,store:l.store||o.value.store,minio:{endpoint:l.minio.endpoint||"",bucket:l.minio.bucket||"",access_key:l.minio.access_key||"",secret_key:l.minio.secret_key||"",use_ssl:l.minio.use_ssl||!1,base_path:l.minio.base_path||""}},console.log("config after merge:",o.value),L.value=!0,setTimeout(()=>{L.value=!1},3e3))}catch(l){console.error("fetch config failed",l),c.error("加载配置失败")}},ae=async()=>{var l,a;if(o.value.store==="minio"&&(!o.value.minio.endpoint||!o.value.minio.bucket)){c.error("请填写MinIO Endpoint和Bucket");return}N.value=!0;try{console.log("saving config:",o.value),await x.updateConfig(o.value),c.success("配置保存成功，已持久化到config.toml"),await F()}catch(n){console.error("save config error:",n),c.error(((a=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:a.error)||"配置保存失败")}finally{N.value=!1}},le=async()=>{try{const{data:l}=await x.getTaskTypes();V.value=(l==null?void 0:l.task_types)||[],console.log("loaded task types:",V.value)}catch(l){console.error("fetch task types failed",l)}},q=async()=>{try{const{data:l}=await H.getLiveList({});j.value=(l==null?void 0:l.items)||[],D.value=j.value.map(a=>{const n=a.name||`Stream ${a.id}`;return{value:String(a.id),label:`${n} (ID: ${a.id})`,streamId:a.id,streamName:n}}),console.log("loaded live streams:",D.value.length)}catch(l){console.error("fetch live streams failed",l)}},se=(l,a)=>a.label.toLowerCase().includes(l.toLowerCase()),oe=async(l,a)=>{var n,_,g,z;if(!(l&&l.startsWith("rtsp://")))try{const u=parseInt(l);if(!u){r.value.rtsp_url="";return}const m=r.value.rtsp_url;r.value.rtsp_url="获取播放地址中...";const{data:f}=await H.getPlayUrl(u);console.log("API response:",f);const C=((n=f==null?void 0:f.info)==null?void 0:n.rtsp)||((_=f==null?void 0:f.info)==null?void 0:_.RTSP);C?(r.value.rtsp_url=C,console.log("selected stream RTSP URL:",C),c.success(`已选择: ${a.streamName}`)):(r.value.rtsp_url=m,c.error("未获取到RTSP播放地址"),console.warn("No RTSP URL found in response:",f))}catch(u){console.error("get play url failed",u),r.value.rtsp_url="",c.error("获取播放地址失败: "+(((z=(g=u==null?void 0:u.response)==null?void 0:g.data)==null?void 0:z.error)||u.message))}},T=async()=>{const{data:l}=await x.listTasks();A.value=(l==null?void 0:l.items)||[]},ne=async()=>{var l,a;if(!r.value.id||!r.value.task_type||!r.value.rtsp_url){c.error("请填写任务ID、任务类型与RTSP地址");return}M.value=!0;try{await x.addTask(r.value),c.success("任务添加成功"+(o.value.store==="minio"?"，MinIO路径已创建":"")),r.value={id:"",task_type:"",rtsp_url:"",interval_ms:1e3,output_path:""},await T()}catch(n){c.error(((a=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:a.error)||"添加失败")}finally{M.value=!1}},ie=l=>{r.value={...l},window.scrollTo({top:0,behavior:"smooth"})},ue=async l=>{var a,n;try{await x.delTask(l),c.success("任务删除成功"+(o.value.store==="minio"?"，MinIO路径已清理":"")),await T()}catch(_){c.error(((n=(a=_==null?void 0:_.response)==null?void 0:a.data)==null?void 0:n.error)||"删除失败")}},re=()=>{K.push("/frame-extractor/gallery")},pe=l=>{K.push({path:"/frame-extractor/gallery",query:{task:l}})},de=async l=>{var a,n;S.value[l]=!0;try{await x.startTask(l),c.success("任务已启动"),await T()}catch(_){c.error(((n=(a=_==null?void 0:_.response)==null?void 0:a.data)==null?void 0:n.error)||"启动失败")}finally{S.value[l]=!1}},_e=async l=>{var a,n;S.value[l]=!0;try{await x.stopTask(l),c.success("任务已停止"),await T()}catch(_){c.error(((n=(a=_==null?void 0:_.response)==null?void 0:a.data)==null?void 0:n.error)||"停止失败")}finally{S.value[l]=!1}},ce=async l=>{var n,_;const a=R.value[l.id]||l.interval_ms;if(a<200){c.error("间隔不能小于200ms");return}try{await x.updateInterval(l.id,a),c.success("间隔已更新"+(l.enabled?"，任务已重启":"")),await T(),delete R.value[l.id]}catch(g){c.error(((_=(n=g==null?void 0:g.response)==null?void 0:n.data)==null?void 0:_.error)||"更新失败")}};return st(()=>{F(),T(),q(),le()}),(l,a)=>{const n=Ne,_=Te,g=Ue,z=Ie,u=ze,m=Se,f=Pe,C=Le,I=Oe,w=Re,me=$e,O=Be,ve=Me,X=Ce,E=he,U=Ve,G=Ee,fe=Ae,ye=Fe,ke=Ke,ge=De;return v(),B("div",nt,[e(E,{bordered:!1,class:"config-card mb-4"},{title:t(()=>[h("span",it,[e(i(W),{class:"title-icon"}),a[16]||(a[16]=d(" 存储配置 ",-1))])]),extra:t(()=>[e(n,{onClick:F,size:"small"},{icon:t(()=>[e(i(Z))]),default:t(()=>[a[17]||(a[17]=d(" 重新加载 ",-1))]),_:1})]),default:t(()=>[L.value?(v(),y(_,{key:0,message:"配置已从服务器加载",type:"success","show-icon":"",closable:"",class:"mb-3",onClose:a[0]||(a[0]=s=>L.value=!1)})):P("",!0),e(X,{model:o.value,layout:"vertical"},{default:t(()=>[e(I,{gutter:24},{default:t(()=>[e(m,{xs:24,sm:12,md:8},{default:t(()=>[e(u,{label:"存储类型"},{default:t(()=>[e(z,{value:o.value.store,"onUpdate:value":a[1]||(a[1]=s=>o.value.store=s),size:"large"},{default:t(()=>[e(g,{value:"local"},{default:t(()=>[e(i($)),a[18]||(a[18]=d(" 本地文件系统 ",-1))]),_:1}),e(g,{value:"minio"},{default:t(()=>[e(i(je)),a[19]||(a[19]=d(" MinIO对象存储 ",-1))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),e(m,{xs:24,sm:12,md:8},{default:t(()=>[e(u,{label:"默认抽帧间隔"},{default:t(()=>[e(f,{value:o.value.interval_ms,"onUpdate:value":a[2]||(a[2]=s=>o.value.interval_ms=s),min:200,step:100,size:"large",style:{width:"100%"}},{addonAfter:t(()=>[...a[20]||(a[20]=[d("毫秒",-1)])]),_:1},8,["value"])]),_:1})]),_:1}),e(m,{xs:24,sm:12,md:8},{default:t(()=>[e(u,{label:"启用状态"},{default:t(()=>[e(C,{checked:o.value.enable,"onUpdate:checked":a[3]||(a[3]=s=>o.value.enable=s),size:"large","checked-children":"已启用","un-checked-children":"已禁用"},null,8,["checked"])]),_:1})]),_:1})]),_:1}),o.value.store==="local"?(v(),y(u,{key:0,label:"本地输出目录"},{default:t(()=>[e(w,{value:o.value.output_dir,"onUpdate:value":a[4]||(a[4]=s=>o.value.output_dir=s),size:"large",placeholder:"./snapshots"},{prefix:t(()=>[e(i(qe))]),_:1},8,["value"])]),_:1})):P("",!0),o.value.store==="minio"?(v(),B(ee,{key:1},[e(me,{orientation:"left"},{default:t(()=>[e(i(W)),a[21]||(a[21]=d(" MinIO 配置 ",-1))]),_:1}),e(_,{message:"提示",description:"Bucket不存在时会自动创建，任务ID会作为子路径，删除任务时会同步删除MinIO对应路径下的所有文件",type:"info","show-icon":"",class:"mb-4"}),e(I,{gutter:24},{default:t(()=>[e(m,{xs:24,sm:12},{default:t(()=>[e(u,{label:"Endpoint"},{default:t(()=>[e(w,{value:o.value.minio.endpoint,"onUpdate:value":a[5]||(a[5]=s=>o.value.minio.endpoint=s),size:"large",placeholder:"minio.example.com:9000"},{prefix:t(()=>[e(i(Xe))]),_:1},8,["value"])]),_:1})]),_:1}),e(m,{xs:24,sm:12},{default:t(()=>[e(u,{label:"Bucket"},{default:t(()=>[e(w,{value:o.value.minio.bucket,"onUpdate:value":a[6]||(a[6]=s=>o.value.minio.bucket=s),size:"large",placeholder:"snapshots"},{prefix:t(()=>[e(i(Ge))]),suffix:t(()=>[e(O,{title:"不存在时会自动创建"},{default:t(()=>[e(i(J),{style:{color:"rgba(0,0,0,.45)"}})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(I,{gutter:24},{default:t(()=>[e(m,{xs:24,sm:12},{default:t(()=>[e(u,{label:"Access Key"},{default:t(()=>[e(w,{value:o.value.minio.access_key,"onUpdate:value":a[7]||(a[7]=s=>o.value.minio.access_key=s),size:"large",placeholder:"access key"},{prefix:t(()=>[e(i(He))]),_:1},8,["value"])]),_:1})]),_:1}),e(m,{xs:24,sm:12},{default:t(()=>[e(u,{label:"Secret Key"},{default:t(()=>[e(ve,{value:o.value.minio.secret_key,"onUpdate:value":a[8]||(a[8]=s=>o.value.minio.secret_key=s),size:"large",placeholder:"secret key"},{prefix:t(()=>[e(i(We))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(I,{gutter:24},{default:t(()=>[e(m,{xs:24,sm:12},{default:t(()=>[e(u,{label:"Base Path (可选)"},{default:t(()=>[e(w,{value:o.value.minio.base_path,"onUpdate:value":a[9]||(a[9]=s=>o.value.minio.base_path=s),size:"large",placeholder:"camera-frames"},{prefix:t(()=>[e(i($))]),_:1},8,["value"])]),_:1})]),_:1}),e(m,{xs:24,sm:12},{default:t(()=>[e(u,{label:"使用 SSL"},{default:t(()=>[e(C,{checked:o.value.minio.use_ssl,"onUpdate:checked":a[10]||(a[10]=s=>o.value.minio.use_ssl=s),size:"large","checked-children":"HTTPS","un-checked-children":"HTTP"},null,8,["checked"])]),_:1})]),_:1})]),_:1})],64)):P("",!0),e(u,null,{default:t(()=>[e(n,{type:"primary",size:"large",onClick:ae,loading:N.value},{icon:t(()=>[e(i(Je))]),default:t(()=>[a[22]||(a[22]=d(" 保存配置 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(E,{bordered:!1,class:"task-card"},{title:t(()=>[h("span",ut,[e(i(lt),{class:"title-icon"}),d(" 抽帧任务 ("+b(A.value.length)+") ",1)])]),extra:t(()=>[e(G,null,{default:t(()=>[e(U,{color:o.value.store==="minio"?"blue":"green"},{default:t(()=>[d(b(o.value.store==="minio"?"MinIO存储":"本地存储"),1)]),_:1},8,["color"]),e(n,{type:"primary",onClick:re},{icon:t(()=>[e(i(Y))]),default:t(()=>[a[23]||(a[23]=d(" 查看抽帧结果 ",-1))]),_:1})]),_:1})]),default:t(()=>[e(E,{class:"add-task-card mb-4",bordered:!1},{default:t(()=>[e(X,{model:r.value,layout:"vertical"},{default:t(()=>[e(I,{gutter:16},{default:t(()=>[e(m,{xs:24,sm:12,md:5},{default:t(()=>[e(u,{label:"任务ID",required:!0},{default:t(()=>[e(w,{value:r.value.id,"onUpdate:value":a[11]||(a[11]=s=>r.value.id=s),size:"large",placeholder:"如 cam1"},{prefix:t(()=>[e(i(Ze))]),_:1},8,["value"])]),_:1})]),_:1}),e(m,{xs:24,sm:12,md:5},{default:t(()=>[e(u,{label:"任务类型",required:!0},{default:t(()=>[e(z,{value:r.value.task_type,"onUpdate:value":a[12]||(a[12]=s=>r.value.task_type=s),size:"large",placeholder:"选择类型"},{default:t(()=>[(v(!0),B(ee,null,ot(V.value,s=>(v(),y(g,{key:s,value:s},{default:t(()=>[d(b(s),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1}),e(m,{xs:24,sm:12,md:8},{default:t(()=>[e(u,null,{label:t(()=>[h("span",null,[a[25]||(a[25]=d(" RTSP地址 ",-1)),e(O,{title:"从直播列表选择或手动输入"},{default:t(()=>[e(i(J),{style:{"margin-left":"4px",color:"#8c8c8c"}})]),_:1}),e(n,{type:"link",size:"small",onClick:q,style:{"margin-left":"8px"}},{icon:t(()=>[e(i(Z))]),default:t(()=>[a[24]||(a[24]=d(" 刷新列表 ",-1))]),_:1})])]),default:t(()=>[e(fe,{value:r.value.rtsp_url,"onUpdate:value":a[13]||(a[13]=s=>r.value.rtsp_url=s),options:D.value,size:"large",placeholder:"选择直播流或输入RTSP地址","filter-option":se,onSelect:oe},{prefix:t(()=>[e(i(Qe))]),_:1},8,["value","options"])]),_:1})]),_:1}),e(m,{xs:24,sm:12,md:3},{default:t(()=>[e(u,{label:"间隔(ms)"},{default:t(()=>[e(f,{value:r.value.interval_ms,"onUpdate:value":a[14]||(a[14]=s=>r.value.interval_ms=s),min:200,step:100,size:"large",style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),e(m,{xs:24,sm:12,md:3},{default:t(()=>[e(u,{label:"输出路径"},{default:t(()=>[e(w,{value:r.value.output_path,"onUpdate:value":a[15]||(a[15]=s=>r.value.output_path=s),size:"large",placeholder:"cam1"},{prefix:t(()=>[e(i($))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(u,null,{default:t(()=>[e(n,{type:"primary",size:"large",onClick:ne,loading:M.value},{icon:t(()=>[e(i(Ye))]),default:t(()=>[a[26]||(a[26]=d(" 添加任务 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(ge,{"data-source":A.value,columns:te,"row-key":"id",pagination:{pageSize:10,showTotal:s=>`共 ${s} 条`},scroll:{x:1200}},{bodyCell:t(({column:s,record:p})=>[s.key==="id"?(v(),y(U,{key:0,color:"blue"},{default:t(()=>[d(b(p.id),1)]),_:2},1024)):s.key==="task_type"?(v(),y(U,{key:1,color:"purple"},{default:t(()=>[d(b(p.task_type||"未分类"),1)]),_:2},1024)):s.key==="status"?(v(),y(U,{key:2,color:p.enabled?"green":"default"},{default:t(()=>[d(b(p.enabled?"运行中":"已停止"),1)]),_:2},1032,["color"])):s.key==="rtsp_url"?(v(),y(O,{key:3,title:p.rtsp_url},{default:t(()=>[h("span",rt,b(p.rtsp_url),1)]),_:2},1032,["title"])):s.key==="interval_ms"?(v(),y(ye,{key:4,trigger:"click",placement:"bottom"},{content:t(()=>[h("div",pt,[e(f,{value:R.value[p.id],"onUpdate:value":be=>R.value[p.id]=be,min:200,step:100,style:{width:"100%","margin-bottom":"8px"},placeholder:"新间隔(ms)"},null,8,["value","onUpdate:value"]),e(n,{type:"primary",size:"small",block:"",onClick:()=>ce(p)},{default:t(()=>[...a[27]||(a[27]=[d(" 确认修改 ",-1)])]),_:1},8,["onClick"])])]),default:t(()=>[e(U,{color:"green",style:{cursor:"pointer"}},{default:t(()=>[d(b(p.interval_ms)+"ms ",1),e(i(Q),{style:{"font-size":"10px"}})]),_:2},1024)]),_:2},1024)):s.key==="output_path"?(v(),B("span",dt,[e(i($)),d(" "+b(p.output_path),1)])):s.key==="action"?(v(),y(G,{key:6},{default:t(()=>[e(O,{title:p.enabled?"停止抽帧":"启动抽帧"},{default:t(()=>[e(n,{type:p.enabled?"default":"primary",size:"small",onClick:()=>p.enabled?_e(p.id):de(p.id),loading:S.value[p.id]},{icon:t(()=>[p.enabled?(v(),y(i(et),{key:0})):(v(),y(i(tt),{key:1}))]),_:2},1032,["type","onClick","loading"])]),_:2},1032,["title"]),e(O,{title:"查看快照"},{default:t(()=>[e(n,{type:"default",size:"small",onClick:()=>pe(p.id)},{icon:t(()=>[e(i(Y))]),_:1},8,["onClick"])]),_:2},1024),e(O,{title:"编辑"},{default:t(()=>[e(n,{type:"primary",size:"small",onClick:()=>ie(p)},{icon:t(()=>[e(i(Q))]),_:1},8,["onClick"])]),_:2},1024),e(ke,{title:"确认删除?","ok-text":"删除","cancel-text":"取消",onConfirm:()=>ue(p.id)},{description:t(()=>[h("div",_t,[o.value.store==="minio"?(v(),y(_,{key:0,message:"将同时删除MinIO中的所有文件",type:"warning","show-icon":"",banner:!0,style:{"margin-bottom":"8px"}})):P("",!0),a[28]||(a[28]=d(" 此操作不可恢复，确认删除任务 ",-1)),h("strong",null,b(p.id),1),a[29]||(a[29]=d(" 吗？ ",-1))])]),default:t(()=>[e(n,{danger:"",size:"small"},{icon:t(()=>[e(i(at))]),_:1})]),_:2},1032,["onConfirm"])]),_:2},1024)):P("",!0)]),_:1},8,["data-source","pagination"])]),_:1})])}}},Ht=we(ct,[["__scopeId","data-v-dc6ec0c2"]]);export{Ht as default};
