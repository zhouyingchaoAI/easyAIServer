# 抽帧服务实时监控功能

## 功能概述

抽帧服务监控功能提供了实时查看抽帧任务运行状态的能力，帮助用户及时发现和解决堆栈问题。

## 功能特性

### 1. 实时监控面板
- **总体统计**：总任务数、运行中、已停止、待配置任务数
- **系统资源**：Goroutines数量、内存使用(MB)、CPU核心数
- **任务详情**：每个任务的实时运行状态

### 2. 自动刷新
- 支持自动刷新（默认开启）
- 可配置刷新间隔：1秒、3秒、5秒、10秒
- 可随时切换到手动刷新模式

### 3. 任务监控信息
每个任务显示以下信息：
- 任务ID和类型
- 运行状态（运行中/已停止）
- 配置状态（已配置/待配置）
- 抽帧间隔
- 输出路径
- 运行时长

## 使用指南

### 访问监控页面

1. **前端路由**：访问 `/frame-extractor/monitor`
2. **菜单导航**：主菜单 -> 抽帧监控

### 监控指标说明

#### 总体统计
- **总任务数**：当前配置的所有抽帧任务数量
- **运行中**：正在执行抽帧的任务数量（绿色）
- **已停止**：已暂停或停止的任务数量（灰色）
- **待配置**：尚未完成算法配置的任务数量（橙色）

#### 系统资源
- **Goroutines**：Go协程数量，反映并发任务的开销
- **内存使用**：当前内存占用，单位MB
- **CPU核心**：系统可用的CPU核心数

#### 任务状态判断
- ✅ **运行中** - 任务正常工作，持续抽帧
- ⏸️ **已停止** - 任务已暂停，不产生新帧
- ⚠️ **待配置** - 任务创建但未配置算法参数

### 操作建议

#### 1. 发现堆栈问题
如果发现以下情况，可能存在堆栈问题：
- **Goroutines数量异常增长**：超过正常值（运行任务数 × 10）
- **内存持续增长**：内存使用不断上升不释放
- **任务卡死**：运行中但运行时长异常停滞

#### 2. 解决方案
- **重启卡死任务**：停止后重新启动
- **调整抽帧间隔**：增大间隔减少负载
- **检查RTSP源**：确认视频源稳定可用
- **查看日志**：检查后端日志排查详细错误

#### 3. 性能优化
- **合理配置间隔**：根据需求设置合适的抽帧间隔（推荐1-5秒）
- **控制任务数量**：避免同时运行过多任务
- **监控资源使用**：定期检查系统资源占用

## API接口

### 获取监控统计
```http
GET /frame_extractor/stats

Response:
{
  "total_tasks": 10,
  "running_tasks": 5,
  "stopped_tasks": 5,
  "configured_tasks": 8,
  "pending_tasks": 2,
  "task_details": [
    {
      "id": "task_001",
      "task_type": "人数统计",
      "status": "running",
      "config_status": "configured",
      "interval_ms": 3000,
      "output_path": "task_001",
      "last_frame_time": "2025-10-21T10:30:00Z",
      "frame_count": 1234,
      "error_count": 0,
      "uptime": 3600,
      "start_time": "2025-10-21T09:30:00Z"
    }
  ],
  "system_info": {
    "goroutines": 45,
    "memory_usage_mb": 256.5,
    "cpu_cores": 8
  },
  "updated_at": "2025-10-21T10:30:15Z"
}
```

## 技术实现

### 后端
- **文件**：`internal/plugin/frameextractor/service.go`
- **新增结构**：
  - `TaskStats` - 任务统计信息
  - `TaskMonitorInfo` - 单任务监控信息
  - `SystemMonitorInfo` - 系统监控信息
- **新增方法**：`GetStats()` - 获取实时统计数据

### API层
- **文件**：`internal/web/api/api.go`
- **新增接口**：`GET /frame_extractor/stats`

### 前端
- **监控页面**：`web-src/src/views/frame-extractor/monitor.vue`
- **API接口**：`web-src/src/api/frameextractor.js`
- **路由配置**：`web-src/src/router/rootRoute.js`

## 注意事项

1. **刷新频率**：不建议设置过短的刷新间隔（<1秒），避免对系统造成压力
2. **数据准确性**：运行时长等字段暂时使用默认值，后续可增强
3. **权限要求**：需要登录后才能访问监控页面
4. **浏览器兼容**：建议使用现代浏览器（Chrome、Firefox、Edge等）

## 后续优化方向

- [ ] 添加历史数据趋势图表
- [ ] 增加告警阈值设置
- [ ] 支持导出监控报告
- [ ] 实现任务性能分析
- [ ] 添加WebSocket实时推送

## 反馈与支持

如有问题或建议，请联系技术支持团队。

