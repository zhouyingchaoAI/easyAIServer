import{u as ge}from"./vue-router-CcU_KFui.1760514479000.js";import"./request-DmH5yXYu.1760514479000.js";import{l as G}from"./live-DnLXLACi.1760514479000.js";import{f as b}from"./frameextractor-Dqnecwpo.1760514479000.js";import{_ as ke}from"./_plugin-vue_export-helper-DlAUqK2U.1760514479000.js";import{m as be,k as m,a2 as xe,F as we,V as he,X as Ce,v as Oe,S as Se,h as Te,g as ze,f as Ie,I as Ue,z as Pe,c as Le,w as Re,B as Be,a3 as $e,a1 as Me,T as De,$ as Ne,t as Ve,K as Ae}from"./ant-design-vue-DXrdsOH-.1760514479000.js";import{y as L,aa as Fe,x as Ee,ab as H,ac as Ke,I as W,ad as je,ae as Xe,X as qe,af as Ge,N as J,ag as He,ah as We,P as Je,a4 as Z,ai as Ze,a3 as Qe,aj as Q,A as Ye,ak as et}from"./@ant-design-Dh51Cr1Q.1760514479000.js";import{r as y,j as tt,Z as A,c as e,X as t,W as f,V as g,a1 as z,J as d,u as i,F as at,$ as h,a3 as x}from"./vue-DcFgi5qX.1760514479000.js";import"./axios-ngrFHoWO.1760514479000.js";import"./qs-BJT4tN53.1760514479000.js";import"./clipboard-DnI0MzOy.1760514479000.js";import"./side-channel-C5KkJUEw.1760514479000.js";import"./crypto-js-DKo7m1Et.1760514479000.js";import"./index-BN6y7eKP.1760514479000.js";import"./vue-i18n-CsAgvh4R.1760514479000.js";import"./@intlify-C7-MzqOv.1760514479000.js";import"./nprogress-6kjUdLAL.1760514479000.js";/* empty css                                  */import"./dayjs-DqcMuthd.1760514479000.js";import"./pinia-DdH7JOom.1760514479000.js";import"./pinia-plugin-persistedstate-n2tMOXAx.1760514479000.js";import"./lodash-es-C9rdhAyu.1760514479000.js";import"./@iconify-QdkoHqV-.1760514479000.js";import"./@babel-Bq4_u9L9.1760514479000.js";import"./@ctrl-DOFZgDuz.1760514479000.js";import"./resize-observer-polyfill-B1PUzC5B.1760514479000.js";import"./dom-align-CRCehRfe.1760514479000.js";import"./async-validator-9PlIezaS.1760514479000.js";import"./scroll-into-view-if-needed-B3z4cY-J.1760514479000.js";import"./throttle-debounce-CUWDS_la.1760514479000.js";import"./vue-types-CF28atMM.1760514479000.js";import"./@emotion-BtrR-yrm.1760514479000.js";import"./stylis-D5iaQeiq.1760514479000.js";const lt={class:"p-4 frame-extractor-container"},ot={class:"card-title"},st={class:"card-title"},nt={class:"rtsp-url"},it={style:{width:"200px"}},ut={key:4},rt={style:{"max-width":"250px"}},pt={__name:"index",setup(dt){const F=ge(),o=y({enable:!0,interval_ms:1e3,output_dir:"./snapshots",store:"local",minio:{endpoint:"",bucket:"",access_key:"",secret_key:"",use_ssl:!1,base_path:""}}),p=y({id:"",rtsp_url:"",interval_ms:1e3,output_path:""}),R=y(!1),B=y(!1),I=y(!1),$=y([]),S=y({}),U=y({}),E=y([]),M=y([]),Y=[{title:"任务ID",key:"id",width:120},{title:"状态",key:"status",width:100},{title:"RTSP地址",key:"rtsp_url",ellipsis:!0},{title:"间隔",key:"interval_ms",width:150},{title:"输出路径",key:"output_path",width:150},{title:"操作",key:"action",width:280,fixed:"right"}],D=async()=>{try{const{data:l}=await b.getConfig();console.log("fetched config from server:",l),l&&((!l.minio||typeof l.minio!="object")&&(l.minio={endpoint:"",bucket:"",access_key:"",secret_key:"",use_ssl:!1,base_path:""}),o.value={enable:l.enable!==void 0?l.enable:o.value.enable,interval_ms:l.interval_ms||o.value.interval_ms,output_dir:l.output_dir||o.value.output_dir,store:l.store||o.value.store,minio:{endpoint:l.minio.endpoint||"",bucket:l.minio.bucket||"",access_key:l.minio.access_key||"",secret_key:l.minio.secret_key||"",use_ssl:l.minio.use_ssl||!1,base_path:l.minio.base_path||""}},console.log("config after merge:",o.value),I.value=!0,setTimeout(()=>{I.value=!1},3e3))}catch(l){console.error("fetch config failed",l),m.error("加载配置失败")}},ee=async()=>{var l,a;if(o.value.store==="minio"&&(!o.value.minio.endpoint||!o.value.minio.bucket)){m.error("请填写MinIO Endpoint和Bucket");return}B.value=!0;try{console.log("saving config:",o.value),await b.updateConfig(o.value),m.success("配置保存成功，已持久化到config.toml"),await D()}catch(s){console.error("save config error:",s),m.error(((a=(l=s==null?void 0:s.response)==null?void 0:l.data)==null?void 0:a.error)||"配置保存失败")}finally{B.value=!1}},K=async()=>{try{const{data:l}=await G.getLiveList({});E.value=(l==null?void 0:l.items)||[],M.value=E.value.map(a=>{const s=a.name||`Stream ${a.id}`;return{value:String(a.id),label:`${s} (ID: ${a.id})`,streamId:a.id,streamName:s}}),console.log("loaded live streams:",M.value.length)}catch(l){console.error("fetch live streams failed",l)}},te=(l,a)=>a.label.toLowerCase().includes(l.toLowerCase()),ae=async(l,a)=>{var s,u,k;if(!(l&&l.startsWith("rtsp://")))try{const v=parseInt(l);if(!v){p.value.rtsp_url="";return}const c=p.value.rtsp_url;p.value.rtsp_url="获取播放地址中...";const{data:_}=await G.getPlayUrl(v);(s=_==null?void 0:_.info)!=null&&s.RTSP?(p.value.rtsp_url=_.info.RTSP,console.log("selected stream RTSP URL:",_.info.RTSP),m.success(`已选择: ${a.streamName}`)):(p.value.rtsp_url=c,m.error("未获取到RTSP播放地址"))}catch(v){console.error("get play url failed",v),p.value.rtsp_url="",m.error("获取播放地址失败: "+(((k=(u=v==null?void 0:v.response)==null?void 0:u.data)==null?void 0:k.error)||v.message))}},C=async()=>{const{data:l}=await b.listTasks();$.value=(l==null?void 0:l.items)||[]},le=async()=>{var l,a;if(!p.value.id||!p.value.rtsp_url){m.error("请填写任务ID与RTSP地址");return}R.value=!0;try{await b.addTask(p.value),m.success("任务添加成功"+(o.value.store==="minio"?"，MinIO路径已创建":"")),p.value={id:"",rtsp_url:"",interval_ms:1e3,output_path:""},await C()}catch(s){m.error(((a=(l=s==null?void 0:s.response)==null?void 0:l.data)==null?void 0:a.error)||"添加失败")}finally{R.value=!1}},oe=l=>{p.value={...l},window.scrollTo({top:0,behavior:"smooth"})},se=async l=>{var a,s;try{await b.delTask(l),m.success("任务删除成功"+(o.value.store==="minio"?"，MinIO路径已清理":"")),await C()}catch(u){m.error(((s=(a=u==null?void 0:u.response)==null?void 0:a.data)==null?void 0:s.error)||"删除失败")}},ne=()=>{F.push("/frame-extractor/gallery")},ie=l=>{F.push({path:"/frame-extractor/gallery",query:{task:l}})},ue=async l=>{var a,s;S.value[l]=!0;try{await b.startTask(l),m.success("任务已启动"),await C()}catch(u){m.error(((s=(a=u==null?void 0:u.response)==null?void 0:a.data)==null?void 0:s.error)||"启动失败")}finally{S.value[l]=!1}},re=async l=>{var a,s;S.value[l]=!0;try{await b.stopTask(l),m.success("任务已停止"),await C()}catch(u){m.error(((s=(a=u==null?void 0:u.response)==null?void 0:a.data)==null?void 0:s.error)||"停止失败")}finally{S.value[l]=!1}},pe=async l=>{var s,u;const a=U.value[l.id]||l.interval_ms;if(a<200){m.error("间隔不能小于200ms");return}try{await b.updateInterval(l.id,a),m.success("间隔已更新"+(l.enabled?"，任务已重启":"")),await C(),delete U.value[l.id]}catch(k){m.error(((u=(s=k==null?void 0:k.response)==null?void 0:s.data)==null?void 0:u.error)||"更新失败")}};return tt(()=>{D(),C(),K()}),(l,a)=>{const s=Be,u=xe,k=Te,v=Se,c=Oe,_=Ce,N=ze,j=Ie,T=he,w=Ue,de=Pe,O=Le,_e=Re,X=we,V=be,P=De,q=Ve,me=$e,ce=Ne,fe=Ae,ve=Me;return f(),A("div",lt,[e(V,{bordered:!1,class:"config-card mb-4"},{title:t(()=>[h("span",ot,[e(i(H),{class:"title-icon"}),a[15]||(a[15]=d(" 存储配置 ",-1))])]),extra:t(()=>[e(s,{onClick:D,size:"small"},{icon:t(()=>[e(i(J))]),default:t(()=>[a[16]||(a[16]=d(" 重新加载 ",-1))]),_:1})]),default:t(()=>[I.value?(f(),g(u,{key:0,message:"配置已从服务器加载",type:"success","show-icon":"",closable:"",class:"mb-3",onClose:a[0]||(a[0]=n=>I.value=!1)})):z("",!0),e(X,{model:o.value,layout:"vertical"},{default:t(()=>[e(T,{gutter:24},{default:t(()=>[e(_,{xs:24,sm:12,md:8},{default:t(()=>[e(c,{label:"存储类型"},{default:t(()=>[e(v,{value:o.value.store,"onUpdate:value":a[1]||(a[1]=n=>o.value.store=n),size:"large"},{default:t(()=>[e(k,{value:"local"},{default:t(()=>[e(i(L)),a[17]||(a[17]=d(" 本地文件系统 ",-1))]),_:1}),e(k,{value:"minio"},{default:t(()=>[e(i(Fe)),a[18]||(a[18]=d(" MinIO对象存储 ",-1))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),e(_,{xs:24,sm:12,md:8},{default:t(()=>[e(c,{label:"默认抽帧间隔"},{default:t(()=>[e(N,{value:o.value.interval_ms,"onUpdate:value":a[2]||(a[2]=n=>o.value.interval_ms=n),min:200,step:100,size:"large",style:{width:"100%"}},{addonAfter:t(()=>[...a[19]||(a[19]=[d("毫秒",-1)])]),_:1},8,["value"])]),_:1})]),_:1}),e(_,{xs:24,sm:12,md:8},{default:t(()=>[e(c,{label:"启用状态"},{default:t(()=>[e(j,{checked:o.value.enable,"onUpdate:checked":a[3]||(a[3]=n=>o.value.enable=n),size:"large","checked-children":"已启用","un-checked-children":"已禁用"},null,8,["checked"])]),_:1})]),_:1})]),_:1}),o.value.store==="local"?(f(),g(c,{key:0,label:"本地输出目录"},{default:t(()=>[e(w,{value:o.value.output_dir,"onUpdate:value":a[4]||(a[4]=n=>o.value.output_dir=n),size:"large",placeholder:"./snapshots"},{prefix:t(()=>[e(i(Ee))]),_:1},8,["value"])]),_:1})):z("",!0),o.value.store==="minio"?(f(),A(at,{key:1},[e(de,{orientation:"left"},{default:t(()=>[e(i(H)),a[20]||(a[20]=d(" MinIO 配置 ",-1))]),_:1}),e(u,{message:"提示",description:"Bucket不存在时会自动创建，任务ID会作为子路径，删除任务时会同步删除MinIO对应路径下的所有文件",type:"info","show-icon":"",class:"mb-4"}),e(T,{gutter:24},{default:t(()=>[e(_,{xs:24,sm:12},{default:t(()=>[e(c,{label:"Endpoint"},{default:t(()=>[e(w,{value:o.value.minio.endpoint,"onUpdate:value":a[5]||(a[5]=n=>o.value.minio.endpoint=n),size:"large",placeholder:"minio.example.com:9000"},{prefix:t(()=>[e(i(Ke))]),_:1},8,["value"])]),_:1})]),_:1}),e(_,{xs:24,sm:12},{default:t(()=>[e(c,{label:"Bucket"},{default:t(()=>[e(w,{value:o.value.minio.bucket,"onUpdate:value":a[6]||(a[6]=n=>o.value.minio.bucket=n),size:"large",placeholder:"snapshots"},{prefix:t(()=>[e(i(je))]),suffix:t(()=>[e(O,{title:"不存在时会自动创建"},{default:t(()=>[e(i(W),{style:{color:"rgba(0,0,0,.45)"}})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(T,{gutter:24},{default:t(()=>[e(_,{xs:24,sm:12},{default:t(()=>[e(c,{label:"Access Key"},{default:t(()=>[e(w,{value:o.value.minio.access_key,"onUpdate:value":a[7]||(a[7]=n=>o.value.minio.access_key=n),size:"large",placeholder:"access key"},{prefix:t(()=>[e(i(Xe))]),_:1},8,["value"])]),_:1})]),_:1}),e(_,{xs:24,sm:12},{default:t(()=>[e(c,{label:"Secret Key"},{default:t(()=>[e(_e,{value:o.value.minio.secret_key,"onUpdate:value":a[8]||(a[8]=n=>o.value.minio.secret_key=n),size:"large",placeholder:"secret key"},{prefix:t(()=>[e(i(qe))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(T,{gutter:24},{default:t(()=>[e(_,{xs:24,sm:12},{default:t(()=>[e(c,{label:"Base Path (可选)"},{default:t(()=>[e(w,{value:o.value.minio.base_path,"onUpdate:value":a[9]||(a[9]=n=>o.value.minio.base_path=n),size:"large",placeholder:"camera-frames"},{prefix:t(()=>[e(i(L))]),_:1},8,["value"])]),_:1})]),_:1}),e(_,{xs:24,sm:12},{default:t(()=>[e(c,{label:"使用 SSL"},{default:t(()=>[e(j,{checked:o.value.minio.use_ssl,"onUpdate:checked":a[10]||(a[10]=n=>o.value.minio.use_ssl=n),size:"large","checked-children":"HTTPS","un-checked-children":"HTTP"},null,8,["checked"])]),_:1})]),_:1})]),_:1})],64)):z("",!0),e(c,null,{default:t(()=>[e(s,{type:"primary",size:"large",onClick:ee,loading:B.value},{icon:t(()=>[e(i(Ge))]),default:t(()=>[a[21]||(a[21]=d(" 保存配置 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(V,{bordered:!1,class:"task-card"},{title:t(()=>[h("span",st,[e(i(et),{class:"title-icon"}),d(" 抽帧任务 ("+x($.value.length)+") ",1)])]),extra:t(()=>[e(q,null,{default:t(()=>[e(P,{color:o.value.store==="minio"?"blue":"green"},{default:t(()=>[d(x(o.value.store==="minio"?"MinIO存储":"本地存储"),1)]),_:1},8,["color"]),e(s,{type:"primary",onClick:ne},{icon:t(()=>[e(i(Q))]),default:t(()=>[a[22]||(a[22]=d(" 查看抽帧结果 ",-1))]),_:1})]),_:1})]),default:t(()=>[e(V,{class:"add-task-card mb-4",bordered:!1},{default:t(()=>[e(X,{model:p.value,layout:"vertical"},{default:t(()=>[e(T,{gutter:16},{default:t(()=>[e(_,{xs:24,sm:12,md:6},{default:t(()=>[e(c,{label:"任务ID",required:!0},{default:t(()=>[e(w,{value:p.value.id,"onUpdate:value":a[11]||(a[11]=n=>p.value.id=n),size:"large",placeholder:"如 cam1"},{prefix:t(()=>[e(i(He))]),_:1},8,["value"])]),_:1})]),_:1}),e(_,{xs:24,sm:12,md:10},{default:t(()=>[e(c,null,{label:t(()=>[h("span",null,[a[24]||(a[24]=d(" RTSP地址 ",-1)),e(O,{title:"从直播列表选择或手动输入"},{default:t(()=>[e(i(W),{style:{"margin-left":"4px",color:"#8c8c8c"}})]),_:1}),e(s,{type:"link",size:"small",onClick:K,style:{"margin-left":"8px"}},{icon:t(()=>[e(i(J))]),default:t(()=>[a[23]||(a[23]=d(" 刷新列表 ",-1))]),_:1})])]),default:t(()=>[e(me,{value:p.value.rtsp_url,"onUpdate:value":a[12]||(a[12]=n=>p.value.rtsp_url=n),options:M.value,size:"large",placeholder:"选择直播流或输入RTSP地址","filter-option":te,onSelect:ae},{prefix:t(()=>[e(i(We))]),_:1},8,["value","options"])]),_:1})]),_:1}),e(_,{xs:24,sm:12,md:4},{default:t(()=>[e(c,{label:"间隔(ms)"},{default:t(()=>[e(N,{value:p.value.interval_ms,"onUpdate:value":a[13]||(a[13]=n=>p.value.interval_ms=n),min:200,step:100,size:"large",style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),e(_,{xs:24,sm:12,md:4},{default:t(()=>[e(c,{label:"输出路径"},{default:t(()=>[e(w,{value:p.value.output_path,"onUpdate:value":a[14]||(a[14]=n=>p.value.output_path=n),size:"large",placeholder:"cam1"},{prefix:t(()=>[e(i(L))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(c,null,{default:t(()=>[e(s,{type:"primary",size:"large",onClick:le,loading:R.value},{icon:t(()=>[e(i(Je))]),default:t(()=>[a[25]||(a[25]=d(" 添加任务 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(ve,{"data-source":$.value,columns:Y,"row-key":"id",pagination:{pageSize:10,showTotal:n=>`共 ${n} 条`},scroll:{x:1200}},{bodyCell:t(({column:n,record:r})=>[n.key==="id"?(f(),g(P,{key:0,color:"blue"},{default:t(()=>[d(x(r.id),1)]),_:2},1024)):n.key==="status"?(f(),g(P,{key:1,color:r.enabled?"green":"default"},{default:t(()=>[d(x(r.enabled?"运行中":"已停止"),1)]),_:2},1032,["color"])):n.key==="rtsp_url"?(f(),g(O,{key:2,title:r.rtsp_url},{default:t(()=>[h("span",nt,x(r.rtsp_url),1)]),_:2},1032,["title"])):n.key==="interval_ms"?(f(),g(ce,{key:3,trigger:"click",placement:"bottom"},{content:t(()=>[h("div",it,[e(N,{value:U.value[r.id],"onUpdate:value":ye=>U.value[r.id]=ye,min:200,step:100,style:{width:"100%","margin-bottom":"8px"},placeholder:"新间隔(ms)"},null,8,["value","onUpdate:value"]),e(s,{type:"primary",size:"small",block:"",onClick:()=>pe(r)},{default:t(()=>[...a[26]||(a[26]=[d(" 确认修改 ",-1)])]),_:1},8,["onClick"])])]),default:t(()=>[e(P,{color:"green",style:{cursor:"pointer"}},{default:t(()=>[d(x(r.interval_ms)+"ms ",1),e(i(Z),{style:{"font-size":"10px"}})]),_:2},1024)]),_:2},1024)):n.key==="output_path"?(f(),A("span",ut,[e(i(L)),d(" "+x(r.output_path),1)])):n.key==="action"?(f(),g(q,{key:5},{default:t(()=>[e(O,{title:r.enabled?"停止抽帧":"启动抽帧"},{default:t(()=>[e(s,{type:r.enabled?"default":"primary",size:"small",onClick:()=>r.enabled?re(r.id):ue(r.id),loading:S.value[r.id]},{icon:t(()=>[r.enabled?(f(),g(i(Ze),{key:0})):(f(),g(i(Qe),{key:1}))]),_:2},1032,["type","onClick","loading"])]),_:2},1032,["title"]),e(O,{title:"查看快照"},{default:t(()=>[e(s,{type:"default",size:"small",onClick:()=>ie(r.id)},{icon:t(()=>[e(i(Q))]),_:1},8,["onClick"])]),_:2},1024),e(O,{title:"编辑"},{default:t(()=>[e(s,{type:"primary",size:"small",onClick:()=>oe(r)},{icon:t(()=>[e(i(Z))]),_:1},8,["onClick"])]),_:2},1024),e(fe,{title:"确认删除?","ok-text":"删除","cancel-text":"取消",onConfirm:()=>se(r.id)},{description:t(()=>[h("div",rt,[o.value.store==="minio"?(f(),g(u,{key:0,message:"将同时删除MinIO中的所有文件",type:"warning","show-icon":"",banner:!0,style:{"margin-bottom":"8px"}})):z("",!0),a[27]||(a[27]=d(" 此操作不可恢复，确认删除任务 ",-1)),h("strong",null,x(r.id),1),a[28]||(a[28]=d(" 吗？ ",-1))])]),default:t(()=>[e(s,{danger:"",size:"small"},{icon:t(()=>[e(i(Ye))]),_:1})]),_:2},1032,["onConfirm"])]),_:2},1024)):z("",!0)]),_:1},8,["data-source","pagination"])]),_:1})])}}},Xt=ke(pt,[["__scopeId","data-v-75dc65e0"]]);export{Xt as default};
