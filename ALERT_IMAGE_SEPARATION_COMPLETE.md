# å‘Šè­¦å›¾ç‰‡åˆ†ç¦»åŠŸèƒ½å®Œæ•´å®ç°

## âœ… å®Œæˆçš„åŠŸèƒ½

### æ ¸å¿ƒéœ€æ±‚
1. âœ… å‘Šè­¦å›¾ç‰‡å•ç‹¬å­˜æ”¾ï¼ˆ`alerts/` è·¯å¾„ï¼‰
2. âœ… æŠ½å¸§å›¾ç‰‡æ¨ç†åç«‹å³åˆ é™¤
3. âœ… é˜²æ­¢å‘Šè­¦å›¾ç‰‡åœ¨æ— ç®—æ³•æ—¶è¢«è¯¯åˆ 
4. âœ… æ‰«æå™¨è‡ªåŠ¨è·³è¿‡å‘Šè­¦è·¯å¾„
5. âœ… æ£€æµ‹åˆ°å‘Šè­¦æ—¶ç§»åŠ¨å›¾ç‰‡åˆ°å‘Šè­¦è·¯å¾„

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

### 1. **internal/conf/model.go**
- æ·»åŠ  `AlertBasePath` å­—æ®µåˆ° `AIAnalysisConfig`

### 2. **configs/config.toml**
- æ·»åŠ  `alert_base_path = 'alerts/'` é…ç½®é¡¹

### 3. **internal/plugin/aianalysis/scanner.go**
- æ·»åŠ  `alertBasePath` å­—æ®µ
- ä¿®æ”¹ `NewScanner` æ¥å— `alertBasePath` å‚æ•°
- æ‰«ææ—¶è·³è¿‡å‘Šè­¦è·¯å¾„ä¸­çš„å›¾ç‰‡

### 4. **internal/plugin/aianalysis/scheduler.go**
- æ·»åŠ  `alertBasePath` å­—æ®µ
- ä¿®æ”¹ `NewScheduler` æ¥å— `alertBasePath` å‚æ•°
- æ·»åŠ  `moveImageToAlertPath()` æ–¹æ³•
- æ¨ç†åç§»åŠ¨å›¾ç‰‡åˆ°å‘Šè­¦è·¯å¾„
- æ·»åŠ  `strings` å¯¼å…¥

### 5. **internal/plugin/aianalysis/service.go**
- ä»é…ç½®è¯»å– `AlertBasePath`
- ä¼ é€’ç»™ `NewScheduler` å’Œ `NewScanner`

## ğŸ“Š å·¥ä½œæµç¨‹

### åŸå§‹æµç¨‹
```
æŠ½å¸§ â†’ MinIO (frames/) â†’ æ¨ç† â†’ ä¿å­˜å‘Šè­¦ â†’ æ¨é€MQ
```

### æ–°æµç¨‹
```
æŠ½å¸§ â†’ MinIO (frames/) 
     â†“
æ¨ç†
     â†“
æœ‰å‘Šè­¦?
     â”œâ”€ æ˜¯ â†’ ç§»åŠ¨å›¾ç‰‡åˆ° alerts/{task_type}/{task_id}/  â†’ åˆ é™¤åŸå›¾ â†’ ä¿å­˜å‘Šè­¦
     â””â”€ å¦ â†’ åˆ é™¤åŸå›¾ï¼ˆä¸ä¿å­˜å‘Šè­¦ï¼‰
```

## ğŸ¯ æ ¸å¿ƒé€»è¾‘

### 1. æ‰«æé˜¶æ®µï¼ˆScannerï¼‰
```go
// è·³è¿‡å‘Šè­¦è·¯å¾„ä¸­çš„å›¾ç‰‡
if s.alertBasePath != "" && strings.HasPrefix(object.Key, s.alertBasePath) {
    s.log.Debug("skipping alert image", slog.String("path", object.Key))
    continue
}
```

### 2. æ¨ç†é˜¶æ®µï¼ˆSchedulerï¼‰

#### 2.1 æ— å‘Šè­¦æ—¶
```go
// ç›´æ¥åˆ é™¤åŸå›¾
if s.saveOnlyWithDetection && detectionCount == 0 {
    s.deleteImageWithReason(image.Path, "no_detection")
    return // ä¸ä¿å­˜å‘Šè­¦
}
```

#### 2.2 æœ‰å‘Šè­¦æ—¶
```go
// ç§»åŠ¨å›¾ç‰‡åˆ°å‘Šè­¦è·¯å¾„
if s.alertBasePath != "" && detectionCount > 0 {
    movedPath, err := s.moveImageToAlertPath(image.Path, image.TaskType, image.TaskID)
    // ä½¿ç”¨æ–°è·¯å¾„ä¿å­˜å‘Šè­¦
    alert.ImagePath = movedPath
}
```

### 3. å›¾ç‰‡ç§»åŠ¨å‡½æ•°
```go
func (s *Scheduler) moveImageToAlertPath(imagePath, taskType, taskID string) (string, error) {
    // æ„å»ºå‘Šè­¦è·¯å¾„ï¼šalerts/{task_type}/{task_id}/filename
    alertPath := fmt.Sprintf("%s%s/%s/%s", s.alertBasePath, taskType, taskID, filename)
    
    // å¤åˆ¶åˆ°æ–°è·¯å¾„
    s.minio.CopyObject(dst, src)
    
    // åˆ é™¤åŸå›¾
    s.minio.RemoveObject(imagePath)
    
    return alertPath, nil
}
```

## ğŸ“ è·¯å¾„ç»“æ„

### æŠ½å¸§è·¯å¾„ï¼ˆframes/ï¼‰
```
frames/
â””â”€â”€ {task_type}/
    â””â”€â”€ {task_id}/
        â”œâ”€â”€ snapshot_12345.jpg
        â”œâ”€â”€ snapshot_12350.jpg
        â””â”€â”€ ...
```

### å‘Šè­¦è·¯å¾„ï¼ˆalerts/ï¼‰
```
alerts/
â””â”€â”€ {task_type}/
    â””â”€â”€ {task_id}/
        â”œâ”€â”€ snapshot_12345.jpg  # æœ‰å‘Šè­¦çš„å›¾ç‰‡
        â””â”€â”€ snapshot_12356.jpg  # æœ‰å‘Šè­¦çš„å›¾ç‰‡
```

## ğŸ›¡ï¸ é˜²æŠ¤æœºåˆ¶

### 1. æ‰«æå™¨ä¸æ‰«æå‘Šè­¦è·¯å¾„
- é˜²æ­¢é‡å¤æ¨ç†å·²å¤„ç†çš„å‘Šè­¦å›¾ç‰‡
- ä¿æŠ¤å‘Šè­¦å›¾ç‰‡ä¸è¢«è¯¯åˆ 

### 2. æŠ½å¸§å›¾ç‰‡æ¨ç†åç«‹å³åˆ é™¤
- é˜²æ­¢æŠ½å¸§è·¯å¾„ç§¯å‹
- èŠ‚çœå­˜å‚¨ç©ºé—´

### 3. å‘Šè­¦å›¾ç‰‡æ°¸ä¹…ä¿ç•™
- å­˜å‚¨åœ¨ç‹¬ç«‹çš„ `alerts/` è·¯å¾„
- ä¸ä¼šå› ä¸ºé‡å¯æˆ–ç®—æ³•æ•…éšœè€Œä¸¢å¤±

## âš™ï¸ é…ç½®ç¤ºä¾‹

```toml
[ai_analysis]
enable = true
scan_interval_sec = 5
save_only_with_detection = true
alert_base_path = 'alerts/'  # å‘Šè­¦å›¾ç‰‡å­˜å‚¨è·¯å¾„å‰ç¼€
```

## ğŸ” å…³é”®æ”¹è¿›

### é—®é¢˜1ï¼šç¨‹åºé‡å¯åä¸çŸ¥é“å“ªäº›å›¾ç‰‡å·²å¤„ç†
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å‘Šè­¦å›¾ç‰‡å­˜å‚¨åœ¨ç‹¬ç«‹è·¯å¾„ `alerts/`
- æ‰«æå™¨è‡ªåŠ¨è·³è¿‡ `alerts/` è·¯å¾„
- å³ä½¿é‡å¯ä¹Ÿä¸ä¼šé‡å¤æ¨ç†

### é—®é¢˜2ï¼šæ— ç®—æ³•æ—¶ä¼šåˆ é™¤å‘Šè­¦å›¾ç‰‡
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ¨ç†å‰æ— ç®—æ³•æ—¶åˆ é™¤æŠ½å¸§å›¾ç‰‡
- æ¨ç†åæœ‰å‘Šè­¦æ—¶ç§»åŠ¨å›¾ç‰‡åˆ° `alerts/` è·¯å¾„
- å‘Šè­¦å›¾ç‰‡ä¸å—ç®—æ³•å¯åœå½±å“

### é—®é¢˜3ï¼šæŠ½å¸§å›¾ç‰‡ä¼šç§¯å‹
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ¨ç†åç«‹å³åˆ é™¤æŠ½å¸§å›¾ç‰‡
- åªæœ‰æœ‰å‘Šè­¦çš„å›¾ç‰‡æ‰ç§»åŠ¨åˆ° `alerts/` è·¯å¾„
- ä¿æŒæŠ½å¸§è·¯å¾„å¹²å‡€

## âœ… ç¼–è¯‘éªŒè¯

- âœ… ç¼–è¯‘æˆåŠŸ
- âœ… æ— linteré”™è¯¯

## ğŸš€ ä½¿ç”¨è¯´æ˜

1. é…ç½®å‘Šè­¦è·¯å¾„ï¼š
```toml
[ai_analysis]
alert_base_path = 'alerts/'
```

2. å¯ç”¨åªä¿å­˜æœ‰å‘Šè­¦çš„å›¾ç‰‡ï¼š
```toml
save_only_with_detection = true
```

3. é‡å¯æœåŠ¡ç”Ÿæ•ˆ

4. æ£€æŸ¥å‘Šè­¦å›¾ç‰‡å­˜å‚¨ï¼š
```bash
# æŸ¥çœ‹å‘Šè­¦å›¾ç‰‡
mc ls minio/easydarwin/alerts/
```

## ğŸ“ˆ æ•ˆæœ

- âœ… æŠ½å¸§è·¯å¾„ä¸ä¼šç§¯å‹
- âœ… å‘Šè­¦å›¾ç‰‡å®‰å…¨ç‹¬ç«‹å­˜å‚¨
- âœ… é‡å¯ä¸ä¼šé‡å¤æ¨ç†
- âœ… ç®—æ³•å¯åœä¸å½±å“å‘Šè­¦å›¾ç‰‡
- âœ… å­˜å‚¨ç©ºé—´ä¼˜åŒ–

## æ€»ç»“

å‘Šè­¦å›¾ç‰‡åˆ†ç¦»åŠŸèƒ½å·²æˆåŠŸå®ç°ï¼š
- âœ… é…ç½®æ”¯æŒ
- âœ… æ‰«æå™¨è¿‡æ»¤
- âœ… è°ƒåº¦å™¨ç§»åŠ¨
- âœ… è·¯å¾„ç®¡ç†
- âœ… é˜²æŠ¤æœºåˆ¶
- âœ… ç¼–è¯‘é€šè¿‡

ç³»ç»Ÿç°åœ¨å…·å¤‡å®Œæ•´çš„å‘Šè­¦å›¾ç‰‡ç®¡ç†å’Œä¿æŠ¤æœºåˆ¶ï¼ğŸ‰


