# EasyDarwin å¹³å°åŠŸèƒ½è¯´æ˜

## âœ… ç®—æ³•æœåŠ¡è‡ªåŠ¨æ³¨å†Œå’Œç®¡ç†

### æ ¸å¿ƒæœºåˆ¶

EasyDarwinå¹³å°æä¾›å®Œå…¨è‡ªåŠ¨åŒ–çš„ç®—æ³•æœåŠ¡ç®¡ç†ï¼š

#### 1. **è‡ªåŠ¨æ³¨å†Œ**
- ç®—æ³•æœåŠ¡å¯åŠ¨åè°ƒç”¨æ³¨å†ŒAPI
- å¹³å°è‡ªåŠ¨éªŒè¯å¹¶å­˜å‚¨ï¼ˆçº¯å†…å­˜ï¼‰
- æŒ‰ä»»åŠ¡ç±»å‹è‡ªåŠ¨åˆ†ç±»

#### 2. **è‡ªåŠ¨æ¸…ç†**
- å¿ƒè·³æ£€æµ‹ï¼šæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
- è¶…æ—¶æ¸…ç†ï¼š90ç§’æ— å¿ƒè·³è‡ªåŠ¨æ³¨é”€
- æœåŠ¡ä¸‹çº¿ï¼šè‡ªåŠ¨è§¦å‘å›è°ƒé€šçŸ¥

#### 3. **è´Ÿè½½å‡è¡¡**
- è‡ªé€‚åº”ç­–ç•¥ï¼šRound-Robin + æœ€å°‘è¿æ¥
- è‡ªåŠ¨åœ¨å¤šä¸ªæœåŠ¡é—´åˆ†é…è¯·æ±‚
- è°ƒç”¨æ¬¡æ•°ç»Ÿè®¡å’Œç›‘æ§

#### 4. **å¥åº·ç›‘æ§**
- æ¯5åˆ†é’Ÿè¾“å‡ºå¥åº·æŠ¥å‘Š
- è¯¦ç»†çš„æ³¨å†Œ/æ³¨é”€æ—¥å¿—
- è´Ÿè½½å‡è¡¡é€‰æ‹©æ—¥å¿—

---

## ğŸ“¡ APIæ¥å£

### ç®—æ³•æœåŠ¡æ³¨å†Œï¼ˆç”±ç®—æ³•æœåŠ¡è°ƒç”¨ï¼‰
```
POST /api/v1/ai_analysis/register
{
  "service_id": "unique_id",
  "name": "æœåŠ¡åç§°",
  "task_types": ["äººæ•°ç»Ÿè®¡", "å®¢æµåˆ†æ"],
  "endpoint": "http://æœåŠ¡IP:ç«¯å£/infer",
  "version": "1.0.0"
}
```

### å¿ƒè·³ç»´æŒï¼ˆç”±ç®—æ³•æœåŠ¡è°ƒç”¨ï¼Œæ¯30ç§’ï¼‰
```
POST /api/v1/ai_analysis/heartbeat/:service_id
```

### æŸ¥è¯¢æœåŠ¡ï¼ˆç®¡ç†æŸ¥çœ‹ï¼‰
```
GET /api/v1/ai_analysis/services
GET /api/v1/ai_analysis/services/debug
GET /api/v1/ai_analysis/load_balance/analysis
```

### ç®¡ç†æ¥å£
```
DELETE /api/v1/ai_analysis/unregister/:id  # æ³¨é”€å•ä¸ªæœåŠ¡
POST /api/v1/ai_analysis/clear_all         # æ¸…ç©ºæ‰€æœ‰æ³¨å†Œ
```

---

## âš™ï¸ é…ç½®

### EasyDarwiné…ç½® (`configs/config.toml`)

```toml
[ai_analysis]
enable = true
heartbeat_timeout_sec = 90     # å¿ƒè·³è¶…æ—¶æ—¶é—´
scan_interval_sec = 5
max_concurrent_infer = 100
```

---

## ğŸ“Š æ—¥å¿—ç›‘æ§

### å…³é”®æ—¥å¿—

**æ³¨å†Œæ—¥å¿—**ï¼š
```
algorithm service registered successfully
  service_id=xxx
  endpoint=http://...:7901/infer
  total_services=14
  all_endpoints=[æ‰€æœ‰14ä¸ªendpoint]
```

**è´Ÿè½½å‡è¡¡æ—¥å¿—**ï¼š
```
load balance: round-robin selected
  task_type=äººæ•°ç»Ÿè®¡
  selected_endpoint=http://...:7905/infer
  current_index=4
  total_services=14
```

**æ¸…ç†æ—¥å¿—**ï¼š
```
algorithm service expired - auto removing
  service_id=xxx
  heartbeat_age_sec=95
```

**å¥åº·æŠ¥å‘Šï¼ˆæ¯5åˆ†é’Ÿï¼‰**ï¼š
```
algorithm services health report
  total_services=14
  task_type_distribution={...}
```

---

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### å¹³å°ç«¯ï¼ˆEasyDarwinï¼‰

**å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€ä»»ä½•æ“ä½œ**ï¼š
1. å¯åŠ¨å¹³å°ï¼š`./easydarwin.com`
2. å¹³å°è‡ªåŠ¨å¯åŠ¨å¿ƒè·³æ£€æµ‹å™¨
3. ç­‰å¾…ç®—æ³•æœåŠ¡æ³¨å†Œ
4. è‡ªåŠ¨æ¸…ç†æ–­å¼€çš„æœåŠ¡

### ç®—æ³•æœåŠ¡ç«¯

**éœ€è¦å®ç°çš„åŠŸèƒ½**ï¼ˆå‚è€ƒ `/code/predict/algorithm_service.py`ï¼‰ï¼š
1. å¯åŠ¨æ—¶è°ƒç”¨æ³¨å†ŒAPI
2. æ¯30ç§’å‘é€å¿ƒè·³
3. é€€å‡ºæ—¶è°ƒç”¨æ³¨é”€APIï¼ˆå¯é€‰ï¼‰

---

## ğŸ“ˆ è´Ÿè½½å‡è¡¡ç­–ç•¥

### ç®—æ³•

```
if æ‰€æœ‰æœåŠ¡è°ƒç”¨æ¬¡æ•°ç›¸åŒ:
    ä½¿ç”¨ Round-Robin è½®è¯¢
    æŒ‰ç´¢å¼•é¡ºåº: 0 â†’ 1 â†’ 2 â†’ ... â†’ 13 â†’ 0 â†’ ...
else:
    ä½¿ç”¨æœ€å°‘è¿æ¥ç­–ç•¥
    é€‰æ‹©è°ƒç”¨æ¬¡æ•°æœ€å°‘çš„æœåŠ¡
```

### æ•ˆæœ

14ä¸ªæœåŠ¡ä¼šå‡åŒ€åˆ†é…è¯·æ±‚ï¼š
- åˆå§‹é˜¶æ®µï¼šRound-Robinè½®è¯¢
- ç¨³å®šåï¼šè°ƒç”¨æ¬¡æ•°åŸºæœ¬ç›¸ç­‰ï¼ˆÂ±1-2æ¬¡ï¼‰

---

## ğŸš€ éªŒè¯æ–¹æ³•

### 1. æŸ¥çœ‹æ³¨å†Œæ•°é‡
```bash
curl http://localhost:5066/api/v1/ai_analysis/services
```

### 2. æŸ¥çœ‹è´Ÿè½½å‡è¡¡
```bash
curl http://localhost:5066/api/v1/ai_analysis/load_balance/analysis
```

### 3. æŸ¥çœ‹æ—¥å¿—
```bash
tail -f logs/sugar.log | grep -E "registered|load balance"
```

---

## âœ… è®¾è®¡åŸåˆ™

1. **çº¯å†…å­˜å­˜å‚¨** - ä¸æŒä¹…åŒ–ï¼Œé‡å¯æ¸…ç©º
2. **è‡ªåŠ¨æ³¨å†Œ** - ç®—æ³•æœåŠ¡ä¸»åŠ¨æ³¨å†Œï¼Œå¹³å°è¢«åŠ¨æ¥æ”¶
3. **è‡ªåŠ¨æ¸…ç†** - æ— å¿ƒè·³è‡ªåŠ¨æ³¨é”€ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
4. **è´Ÿè½½å‡è¡¡** - è‡ªåŠ¨åˆ†é…ï¼Œæ— éœ€é…ç½®

---

**ç¼–è¯‘å‘½ä»¤**ï¼š
```bash
cd /code/EasyDarwin
make build/arm64  # ARM64æ¶æ„
```

**æ–‡æ¡£**ï¼š`/code/EasyDarwin/å¹³å°åŠŸèƒ½ä¼˜åŒ–æ€»ç»“.md`

