import{u as ve}from"./vue-router-BbiEtAQe.1760513058000.js";import"./request-DV9Er79-.1760513058000.js";import{l as ye}from"./live-CNJ9gkKh.1760513058000.js";import{f as g}from"./frameextractor-D3lHJ0aH.1760513058000.js";import{_ as ge}from"./_plugin-vue_export-helper-DlAUqK2U.1760513058000.js";import{m as ke,k as _,a2 as be,F as xe,V as we,X as Ce,v as Oe,S as he,h as ze,g as Te,f as Ie,I as Se,z as Ue,c as Le,w as Pe,B as Be,a3 as Me,a1 as $e,T as Ae,$ as De,t as Ve,K as Fe}from"./ant-design-vue-D4X_OFnw.1760513058000.js";import{y as L,aa as Re,x as Ee,ab as q,ac as Ne,I as G,ad as Ke,ae as je,X as Xe,af as qe,N as H,ag as Ge,ah as He,P as Je,a4 as J,ai as We,a3 as Ze,aj as W,A as Qe,ak as Ye}from"./@ant-design-DL4o3edF.1760513058000.js";import{r as v,j as et,Z as F,c as e,X as t,W as f,V as y,a1 as T,J as r,u as i,F as tt,$ as x,a3 as k}from"./vue-DcFgi5qX.1760513058000.js";import"./axios-ngrFHoWO.1760513058000.js";import"./qs-BvEd9Jvc.1760513058000.js";import"./clipboard-DnI0MzOy.1760513058000.js";import"./side-channel-mEQ6TbVv.1760513058000.js";import"./crypto-js-CZzF-CvB.1760513058000.js";import"./index-DsIAnTEz.1760513058000.js";import"./vue-i18n-BNrCvsAB.1760513058000.js";import"./@intlify-C7-MzqOv.1760513058000.js";import"./nprogress-CSOxmL3r.1760513058000.js";/* empty css                                  */import"./dayjs-CVn405A7.1760513058000.js";import"./pinia-Cbzpzs84.1760513058000.js";import"./pinia-plugin-persistedstate-n2tMOXAx.1760513058000.js";import"./lodash-es-C9rdhAyu.1760513058000.js";import"./@iconify-BibQqVe9.1760513058000.js";import"./@babel-Bq4_u9L9.1760513058000.js";import"./@ctrl-DOFZgDuz.1760513058000.js";import"./resize-observer-polyfill-B1PUzC5B.1760513058000.js";import"./dom-align-CRCehRfe.1760513058000.js";import"./async-validator-9PlIezaS.1760513058000.js";import"./scroll-into-view-if-needed-B3z4cY-J.1760513058000.js";import"./throttle-debounce-CUWDS_la.1760513058000.js";import"./vue-types-CF28atMM.1760513058000.js";import"./@emotion-BtrR-yrm.1760513058000.js";import"./stylis-D5iaQeiq.1760513058000.js";const at={class:"p-4 frame-extractor-container"},lt={class:"card-title"},ot={class:"card-title"},st={class:"rtsp-url"},nt={style:{width:"200px"}},it={key:4},ut={style:{"max-width":"250px"}},rt={__name:"index",setup(pt){const R=ve(),o=v({enable:!0,interval_ms:1e3,output_dir:"./snapshots",store:"local",minio:{endpoint:"",bucket:"",access_key:"",secret_key:"",use_ssl:!1,base_path:""}}),m=v({id:"",rtsp_url:"",interval_ms:1e3,output_path:""}),P=v(!1),B=v(!1),I=v(!1),M=v([]),h=v({}),S=v({}),E=v([]),$=v([]),Z=[{title:"任务ID",key:"id",width:120},{title:"状态",key:"status",width:100},{title:"RTSP地址",key:"rtsp_url",ellipsis:!0},{title:"间隔",key:"interval_ms",width:150},{title:"输出路径",key:"output_path",width:150},{title:"操作",key:"action",width:280,fixed:"right"}],A=async()=>{try{const{data:l}=await g.getConfig();console.log("fetched config from server:",l),l&&((!l.minio||typeof l.minio!="object")&&(l.minio={endpoint:"",bucket:"",access_key:"",secret_key:"",use_ssl:!1,base_path:""}),o.value={enable:l.enable!==void 0?l.enable:o.value.enable,interval_ms:l.interval_ms||o.value.interval_ms,output_dir:l.output_dir||o.value.output_dir,store:l.store||o.value.store,minio:{endpoint:l.minio.endpoint||"",bucket:l.minio.bucket||"",access_key:l.minio.access_key||"",secret_key:l.minio.secret_key||"",use_ssl:l.minio.use_ssl||!1,base_path:l.minio.base_path||""}},console.log("config after merge:",o.value),I.value=!0,setTimeout(()=>{I.value=!1},3e3))}catch(l){console.error("fetch config failed",l),_.error("加载配置失败")}},Q=async()=>{var l,a;if(o.value.store==="minio"&&(!o.value.minio.endpoint||!o.value.minio.bucket)){_.error("请填写MinIO Endpoint和Bucket");return}B.value=!0;try{console.log("saving config:",o.value),await g.updateConfig(o.value),_.success("配置保存成功，已持久化到config.toml"),await A()}catch(n){console.error("save config error:",n),_.error(((a=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:a.error)||"配置保存失败")}finally{B.value=!1}},N=async()=>{try{const{data:l}=await ye.getLiveList({});E.value=(l==null?void 0:l.items)||[],$.value=E.value.map(a=>{const n=a.rtsp_url||a.url||"";return{value:n,label:`${a.stream_id||a.id||""} - ${n}`}}).filter(a=>a.value),console.log("loaded live streams:",$.value.length)}catch(l){console.error("fetch live streams failed",l)}},Y=(l,a)=>a.label.toLowerCase().includes(l.toLowerCase()),w=async()=>{const{data:l}=await g.listTasks();M.value=(l==null?void 0:l.items)||[]},ee=async()=>{var l,a;if(!m.value.id||!m.value.rtsp_url){_.error("请填写任务ID与RTSP地址");return}P.value=!0;try{await g.addTask(m.value),_.success("任务添加成功"+(o.value.store==="minio"?"，MinIO路径已创建":"")),m.value={id:"",rtsp_url:"",interval_ms:1e3,output_path:""},await w()}catch(n){_.error(((a=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:a.error)||"添加失败")}finally{P.value=!1}},te=l=>{m.value={...l},window.scrollTo({top:0,behavior:"smooth"})},ae=async l=>{var a,n;try{await g.delTask(l),_.success("任务删除成功"+(o.value.store==="minio"?"，MinIO路径已清理":"")),await w()}catch(p){_.error(((n=(a=p==null?void 0:p.response)==null?void 0:a.data)==null?void 0:n.error)||"删除失败")}},le=()=>{R.push("/frame-extractor/gallery")},oe=l=>{R.push({path:"/frame-extractor/gallery",query:{task:l}})},se=async l=>{var a,n;h.value[l]=!0;try{await g.startTask(l),_.success("任务已启动"),await w()}catch(p){_.error(((n=(a=p==null?void 0:p.response)==null?void 0:a.data)==null?void 0:n.error)||"启动失败")}finally{h.value[l]=!1}},ne=async l=>{var a,n;h.value[l]=!0;try{await g.stopTask(l),_.success("任务已停止"),await w()}catch(p){_.error(((n=(a=p==null?void 0:p.response)==null?void 0:a.data)==null?void 0:n.error)||"停止失败")}finally{h.value[l]=!1}},ie=async l=>{var n,p;const a=S.value[l.id]||l.interval_ms;if(a<200){_.error("间隔不能小于200ms");return}try{await g.updateInterval(l.id,a),_.success("间隔已更新"+(l.enabled?"，任务已重启":"")),await w(),delete S.value[l.id]}catch(C){_.error(((p=(n=C==null?void 0:C.response)==null?void 0:n.data)==null?void 0:p.error)||"更新失败")}};return et(()=>{A(),w(),N()}),(l,a)=>{const n=Be,p=be,C=ze,ue=he,d=Oe,c=Ce,D=Te,K=Ie,z=we,b=Se,re=Ue,O=Le,pe=Pe,j=xe,V=ke,U=Ae,X=Ve,de=Me,_e=De,me=Fe,ce=$e;return f(),F("div",at,[e(V,{bordered:!1,class:"config-card mb-4"},{title:t(()=>[x("span",lt,[e(i(q),{class:"title-icon"}),a[15]||(a[15]=r(" 存储配置 ",-1))])]),extra:t(()=>[e(n,{onClick:A,size:"small"},{icon:t(()=>[e(i(H))]),default:t(()=>[a[16]||(a[16]=r(" 重新加载 ",-1))]),_:1})]),default:t(()=>[I.value?(f(),y(p,{key:0,message:"配置已从服务器加载",type:"success","show-icon":"",closable:"",class:"mb-3",onClose:a[0]||(a[0]=s=>I.value=!1)})):T("",!0),e(j,{model:o.value,layout:"vertical"},{default:t(()=>[e(z,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12,md:8},{default:t(()=>[e(d,{label:"存储类型"},{default:t(()=>[e(ue,{value:o.value.store,"onUpdate:value":a[1]||(a[1]=s=>o.value.store=s),size:"large"},{default:t(()=>[e(C,{value:"local"},{default:t(()=>[e(i(L)),a[17]||(a[17]=r(" 本地文件系统 ",-1))]),_:1}),e(C,{value:"minio"},{default:t(()=>[e(i(Re)),a[18]||(a[18]=r(" MinIO对象存储 ",-1))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:8},{default:t(()=>[e(d,{label:"默认抽帧间隔"},{default:t(()=>[e(D,{value:o.value.interval_ms,"onUpdate:value":a[2]||(a[2]=s=>o.value.interval_ms=s),min:200,step:100,size:"large",style:{width:"100%"}},{addonAfter:t(()=>[...a[19]||(a[19]=[r("毫秒",-1)])]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:8},{default:t(()=>[e(d,{label:"启用状态"},{default:t(()=>[e(K,{checked:o.value.enable,"onUpdate:checked":a[3]||(a[3]=s=>o.value.enable=s),size:"large","checked-children":"已启用","un-checked-children":"已禁用"},null,8,["checked"])]),_:1})]),_:1})]),_:1}),o.value.store==="local"?(f(),y(d,{key:0,label:"本地输出目录"},{default:t(()=>[e(b,{value:o.value.output_dir,"onUpdate:value":a[4]||(a[4]=s=>o.value.output_dir=s),size:"large",placeholder:"./snapshots"},{prefix:t(()=>[e(i(Ee))]),_:1},8,["value"])]),_:1})):T("",!0),o.value.store==="minio"?(f(),F(tt,{key:1},[e(re,{orientation:"left"},{default:t(()=>[e(i(q)),a[20]||(a[20]=r(" MinIO 配置 ",-1))]),_:1}),e(p,{message:"提示",description:"Bucket不存在时会自动创建，任务ID会作为子路径，删除任务时会同步删除MinIO对应路径下的所有文件",type:"info","show-icon":"",class:"mb-4"}),e(z,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12},{default:t(()=>[e(d,{label:"Endpoint"},{default:t(()=>[e(b,{value:o.value.minio.endpoint,"onUpdate:value":a[5]||(a[5]=s=>o.value.minio.endpoint=s),size:"large",placeholder:"minio.example.com:9000"},{prefix:t(()=>[e(i(Ne))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12},{default:t(()=>[e(d,{label:"Bucket"},{default:t(()=>[e(b,{value:o.value.minio.bucket,"onUpdate:value":a[6]||(a[6]=s=>o.value.minio.bucket=s),size:"large",placeholder:"snapshots"},{prefix:t(()=>[e(i(Ke))]),suffix:t(()=>[e(O,{title:"不存在时会自动创建"},{default:t(()=>[e(i(G),{style:{color:"rgba(0,0,0,.45)"}})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(z,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12},{default:t(()=>[e(d,{label:"Access Key"},{default:t(()=>[e(b,{value:o.value.minio.access_key,"onUpdate:value":a[7]||(a[7]=s=>o.value.minio.access_key=s),size:"large",placeholder:"access key"},{prefix:t(()=>[e(i(je))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12},{default:t(()=>[e(d,{label:"Secret Key"},{default:t(()=>[e(pe,{value:o.value.minio.secret_key,"onUpdate:value":a[8]||(a[8]=s=>o.value.minio.secret_key=s),size:"large",placeholder:"secret key"},{prefix:t(()=>[e(i(Xe))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(z,{gutter:24},{default:t(()=>[e(c,{xs:24,sm:12},{default:t(()=>[e(d,{label:"Base Path (可选)"},{default:t(()=>[e(b,{value:o.value.minio.base_path,"onUpdate:value":a[9]||(a[9]=s=>o.value.minio.base_path=s),size:"large",placeholder:"camera-frames"},{prefix:t(()=>[e(i(L))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12},{default:t(()=>[e(d,{label:"使用 SSL"},{default:t(()=>[e(K,{checked:o.value.minio.use_ssl,"onUpdate:checked":a[10]||(a[10]=s=>o.value.minio.use_ssl=s),size:"large","checked-children":"HTTPS","un-checked-children":"HTTP"},null,8,["checked"])]),_:1})]),_:1})]),_:1})],64)):T("",!0),e(d,null,{default:t(()=>[e(n,{type:"primary",size:"large",onClick:Q,loading:B.value},{icon:t(()=>[e(i(qe))]),default:t(()=>[a[21]||(a[21]=r(" 保存配置 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(V,{bordered:!1,class:"task-card"},{title:t(()=>[x("span",ot,[e(i(Ye),{class:"title-icon"}),r(" 抽帧任务 ("+k(M.value.length)+") ",1)])]),extra:t(()=>[e(X,null,{default:t(()=>[e(U,{color:o.value.store==="minio"?"blue":"green"},{default:t(()=>[r(k(o.value.store==="minio"?"MinIO存储":"本地存储"),1)]),_:1},8,["color"]),e(n,{type:"primary",onClick:le},{icon:t(()=>[e(i(W))]),default:t(()=>[a[22]||(a[22]=r(" 查看抽帧结果 ",-1))]),_:1})]),_:1})]),default:t(()=>[e(V,{class:"add-task-card mb-4",bordered:!1},{default:t(()=>[e(j,{model:m.value,layout:"vertical"},{default:t(()=>[e(z,{gutter:16},{default:t(()=>[e(c,{xs:24,sm:12,md:6},{default:t(()=>[e(d,{label:"任务ID",required:!0},{default:t(()=>[e(b,{value:m.value.id,"onUpdate:value":a[11]||(a[11]=s=>m.value.id=s),size:"large",placeholder:"如 cam1"},{prefix:t(()=>[e(i(Ge))]),_:1},8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:10},{default:t(()=>[e(d,null,{label:t(()=>[x("span",null,[a[24]||(a[24]=r(" RTSP地址 ",-1)),e(O,{title:"从直播列表选择或手动输入"},{default:t(()=>[e(i(G),{style:{"margin-left":"4px",color:"#8c8c8c"}})]),_:1}),e(n,{type:"link",size:"small",onClick:N,style:{"margin-left":"8px"}},{icon:t(()=>[e(i(H))]),default:t(()=>[a[23]||(a[23]=r(" 刷新列表 ",-1))]),_:1})])]),default:t(()=>[e(de,{value:m.value.rtsp_url,"onUpdate:value":a[12]||(a[12]=s=>m.value.rtsp_url=s),options:$.value,size:"large",placeholder:"输入或从直播流列表选择","filter-option":Y},{prefix:t(()=>[e(i(He))]),_:1},8,["value","options"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:4},{default:t(()=>[e(d,{label:"间隔(ms)"},{default:t(()=>[e(D,{value:m.value.interval_ms,"onUpdate:value":a[13]||(a[13]=s=>m.value.interval_ms=s),min:200,step:100,size:"large",style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),e(c,{xs:24,sm:12,md:4},{default:t(()=>[e(d,{label:"输出路径"},{default:t(()=>[e(b,{value:m.value.output_path,"onUpdate:value":a[14]||(a[14]=s=>m.value.output_path=s),size:"large",placeholder:"cam1"},{prefix:t(()=>[e(i(L))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(d,null,{default:t(()=>[e(n,{type:"primary",size:"large",onClick:ee,loading:P.value},{icon:t(()=>[e(i(Je))]),default:t(()=>[a[25]||(a[25]=r(" 添加任务 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(ce,{"data-source":M.value,columns:Z,"row-key":"id",pagination:{pageSize:10,showTotal:s=>`共 ${s} 条`},scroll:{x:1200}},{bodyCell:t(({column:s,record:u})=>[s.key==="id"?(f(),y(U,{key:0,color:"blue"},{default:t(()=>[r(k(u.id),1)]),_:2},1024)):s.key==="status"?(f(),y(U,{key:1,color:u.enabled?"green":"default"},{default:t(()=>[r(k(u.enabled?"运行中":"已停止"),1)]),_:2},1032,["color"])):s.key==="rtsp_url"?(f(),y(O,{key:2,title:u.rtsp_url},{default:t(()=>[x("span",st,k(u.rtsp_url),1)]),_:2},1032,["title"])):s.key==="interval_ms"?(f(),y(_e,{key:3,trigger:"click",placement:"bottom"},{content:t(()=>[x("div",nt,[e(D,{value:S.value[u.id],"onUpdate:value":fe=>S.value[u.id]=fe,min:200,step:100,style:{width:"100%","margin-bottom":"8px"},placeholder:"新间隔(ms)"},null,8,["value","onUpdate:value"]),e(n,{type:"primary",size:"small",block:"",onClick:()=>ie(u)},{default:t(()=>[...a[26]||(a[26]=[r(" 确认修改 ",-1)])]),_:1},8,["onClick"])])]),default:t(()=>[e(U,{color:"green",style:{cursor:"pointer"}},{default:t(()=>[r(k(u.interval_ms)+"ms ",1),e(i(J),{style:{"font-size":"10px"}})]),_:2},1024)]),_:2},1024)):s.key==="output_path"?(f(),F("span",it,[e(i(L)),r(" "+k(u.output_path),1)])):s.key==="action"?(f(),y(X,{key:5},{default:t(()=>[e(O,{title:u.enabled?"停止抽帧":"启动抽帧"},{default:t(()=>[e(n,{type:u.enabled?"default":"primary",size:"small",onClick:()=>u.enabled?ne(u.id):se(u.id),loading:h.value[u.id]},{icon:t(()=>[u.enabled?(f(),y(i(We),{key:0})):(f(),y(i(Ze),{key:1}))]),_:2},1032,["type","onClick","loading"])]),_:2},1032,["title"]),e(O,{title:"查看快照"},{default:t(()=>[e(n,{type:"default",size:"small",onClick:()=>oe(u.id)},{icon:t(()=>[e(i(W))]),_:1},8,["onClick"])]),_:2},1024),e(O,{title:"编辑"},{default:t(()=>[e(n,{type:"primary",size:"small",onClick:()=>te(u)},{icon:t(()=>[e(i(J))]),_:1},8,["onClick"])]),_:2},1024),e(me,{title:"确认删除?","ok-text":"删除","cancel-text":"取消",onConfirm:()=>ae(u.id)},{description:t(()=>[x("div",ut,[o.value.store==="minio"?(f(),y(p,{key:0,message:"将同时删除MinIO中的所有文件",type:"warning","show-icon":"",banner:!0,style:{"margin-bottom":"8px"}})):T("",!0),a[27]||(a[27]=r(" 此操作不可恢复，确认删除任务 ",-1)),x("strong",null,k(u.id),1),a[28]||(a[28]=r(" 吗？ ",-1))])]),default:t(()=>[e(n,{danger:"",size:"small"},{icon:t(()=>[e(i(Qe))]),_:1})]),_:2},1032,["onConfirm"])]),_:2},1024)):T("",!0)]),_:1},8,["data-source","pagination"])]),_:1})])}}},jt=ge(rt,[["__scopeId","data-v-428e07f4"]]);export{jt as default};
