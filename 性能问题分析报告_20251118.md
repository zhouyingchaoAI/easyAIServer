# 性能问题分析报告 - 2025年11月18日

## 📋 问题概述

**时间范围**：2025年11月18日 17:30开始  
**主要问题**：
1. 程序运行越来越慢
2. 图片越积越多
3. 可能存在资源泄漏

---

## 🔍 详细分析

### 1. 图片积压问题 ⚠️ **严重**

#### 问题根源
**图片清理机制未启用** - 这是导致图片无限积累的主要原因！

**证据**：
- 配置文件中没有配置 `max_frame_count` 参数
- 从代码逻辑看，`max_frame_count = 0` 表示不限制图片数量
- 清理函数 `cleanupOldFrames()` 在 `maxCount <= 0` 时会直接返回，不执行清理

**影响**：
- 图片持续积累，占用MinIO存储空间
- 随着图片数量增长，MinIO的ListObjects操作会越来越慢
- 最终可能导致存储空间耗尽

#### 抽帧与推理速度不匹配

**性能统计数据**（17:17:59）：
```
请求速率（抽帧速率）: 106.29 张/秒
响应速率（推理完成）: 3.21 张/秒  
推理速率: 7.78 张/秒
```

**分析**：
- 抽帧速度（106.29/秒）远大于推理速度（7.78/秒）
- 速度比约为 **13.7:1**，意味着每产生13.7张图片，只能处理1张
- 即使推理队列为空（queue_size=0），但图片在MinIO中持续积累

**计算**：
- 假设有14个任务，每个任务200ms抽帧一次（5张/秒）
- 总抽帧速率：14 × 5 = 70张/秒（实际106.29张/秒，可能某些任务更快）
- 推理速率：7.78张/秒
- **每小时积累**：(106.29 - 7.78) × 3600 = **354,636张图片**
- **每天积累**：354,636 × 24 = **8,511,264张图片**

假设每张图片50KB：
- 每小时：354,636 × 50KB = **16.9 GB**
- 每天：8,511,264 × 50KB = **405.6 GB**

### 2. 性能下降问题 ⚠️

#### 推理队列状态
```
queue_size: 0（推理队列为空，正常）
max_size: 50000（最大队列大小，非常大）
processed_total: 30382（已处理总数）
dropped_total: 0（丢弃总数，说明队列未满）
```

**分析**：
- 推理队列本身没有积压（queue_size=0）
- 但batch_queue_size（告警批量写入队列）在增长，从4增长到39
- 说明告警写入速度可能跟不上生成速度

#### 性能指标
```
平均推理时间: 128.58ms（正常）
最大推理时间: 237ms（正常）
失败次数: 18（很少）
成功率: 99.94%（30364/30382）
```

**结论**：推理性能本身正常，但处理速度跟不上抽帧速度。

### 3. 资源泄漏检查 ⚠️

#### Goroutine泄漏风险
从代码分析：
1. **Frame Extractor**：
   - 每个任务有多个goroutine（读取、超时检测、进程等待）
   - 如果任务停止时goroutine没有正确退出，可能导致泄漏
   - 代码中有stop channel机制，但需要确认是否正确清理

2. **AI Analysis**：
   - 推理调度器使用semaphore限制并发（max_concurrent_infer = 300）
   - 有pending标记清理机制（3分钟超时）
   - 有移动锁清理机制

3. **HTTP连接**：
   - HTTP客户端配置了 `DisableKeepAlives: true`，每次使用新连接
   - 这可能导致连接数增长，但Go的GC应该会回收

#### 内存泄漏风险
- 图片在MinIO中积累，但程序内存中应该不会积累（图片已上传）
- 但MinIO客户端可能有缓存或连接池

#### 建议检查项
1. 监控goroutine数量是否持续增长
2. 监控内存使用是否持续增长
3. 监控MinIO连接数
4. 检查是否有未关闭的context、timer、ticker

---

## 🎯 根本原因总结

### 主要原因（按严重程度）

1. **图片清理机制未启用** ⚠️⚠️⚠️
   - 配置缺失：`max_frame_count` 未配置
   - 导致图片无限积累
   - 随着图片数量增长，MinIO操作变慢

2. **抽帧速度远大于推理速度** ⚠️⚠️
   - 抽帧：106.29张/秒
   - 推理：7.78张/秒
   - 速度比：13.7:1
   - 导致图片持续积累

3. **推理并发数可能不足** ⚠️
   - 当前配置：`max_concurrent_infer = 300`
   - 但实际推理速度只有7.78张/秒
   - 可能需要增加算法服务数量或优化推理性能

---

## 💡 解决方案

### 方案1：启用图片清理机制（**立即执行**）

在 `config.toml` 中添加：

```toml
[frame_extractor]
enable = true
interval_ms = 100
output_dir = './snapshots'
store = 'minio'
task_types = ['人数统计', '绊线人数统计', '人员跌倒', '人员离岗', '吸烟检测', '区域入侵', '徘徊检测', '物品遗留', '安全帽检测']

# 全局默认最大抽帧图片数量（0表示不限制）
max_frame_count = 1000  # 建议值：根据实际需求调整
```

**说明**：
- `max_frame_count = 1000` 表示每个任务最多保留1000张图片
- 当超过限制时，会自动删除最旧的图片
- 清理触发条件：每上传50张图片或每5分钟

**任务级配置**（可选）：
```toml
[[frame_extractor.tasks]]
id = '测试1'
task_type = '人数统计'
rtsp_url = 'rtsp://...'
interval_ms = 200
output_path = '测试1'
enabled = true
max_frame_count = 500  # 此任务最多保留500张
```

### 方案2：降低抽帧频率或增加推理能力

#### 选项A：降低抽帧频率
```toml
[[frame_extractor.tasks]]
interval_ms = 500  # 从200ms改为500ms，降低抽帧频率
```

#### 选项B：增加推理并发数
```toml
[ai_analysis]
max_concurrent_infer = 500  # 从300增加到500
```

#### 选项C：增加算法服务数量
- 当前推理速度：7.78张/秒
- 目标：至少达到50张/秒（抽帧速度的一半）
- 需要增加算法服务实例

### 方案3：优化推理队列策略

当前配置：
```toml
[ai_analysis]
max_queue_size = 50000  # 队列最大容量
```

**建议**：
- 如果推理速度跟不上，队列会持续增长
- 考虑降低 `max_queue_size` 并启用丢弃策略
- 或者增加推理能力

### 方案4：监控和告警

添加监控指标：
1. MinIO存储使用量
2. 图片数量统计
3. Goroutine数量
4. 内存使用量
5. 推理队列大小
6. 抽帧速率 vs 推理速率

---

## 📊 预期效果

### 启用图片清理后
- **图片数量**：从无限增长 → 稳定在配置的上限
- **存储空间**：从持续增长 → 稳定
- **MinIO性能**：从逐渐变慢 → 保持稳定

### 优化推理速度后
- **积压速度**：从每小时35万张 → 显著降低
- **处理延迟**：从持续增长 → 稳定

---

## 🔧 立即行动项

### 优先级1（立即执行）
1. ✅ 在配置文件中添加 `max_frame_count = 1000`
2. ✅ 重启服务使配置生效
3. ✅ 监控图片数量是否开始下降

### 优先级2（尽快执行）
1. 评估是否需要降低抽帧频率
2. 评估是否需要增加算法服务
3. 添加监控指标

### 优先级3（持续优化）
1. 定期检查goroutine数量
2. 定期检查内存使用
3. 优化推理性能

---

## 📝 配置示例

完整的 `config.toml` 配置示例：

```toml
[frame_extractor]
enable = true
interval_ms = 100
output_dir = './snapshots'
store = 'minio'
task_types = ['人数统计', '绊线人数统计', '人员跌倒', '人员离岗', '吸烟检测', '区域入侵', '徘徊检测', '物品遗留', '安全帽检测']

# 全局默认最大抽帧图片数量（0表示不限制）
max_frame_count = 1000  # 每个任务最多保留1000张图片

[frame_extractor.minio]
endpoint = '172.16.5.207:9000'
bucket = 'images'
access_key = 'admin'
secret_key = 'admin123'
use_ssl = false
base_path = ''

[ai_analysis]
enable = true
scan_interval_sec = 1
mq_type = 'kafka'
mq_address = '172.16.5.207:9092'
mq_topic = 'easyai.alerts'
heartbeat_timeout_sec = 60
max_concurrent_infer = 300  # 可根据实际情况调整
max_queue_size = 50000
save_only_with_detection = true
alert_base_path = 'alerts/'

# 批量写入优化配置
alert_batch_enabled = true
alert_batch_size = 100
alert_batch_interval_sec = 2
```

---

## 🔍 后续监控

建议监控以下指标：
1. **图片数量**：每个任务的图片数量趋势
2. **存储使用**：MinIO存储使用量
3. **处理速度**：抽帧速率 vs 推理速率
4. **队列大小**：推理队列和批量写入队列大小
5. **系统资源**：CPU、内存、goroutine数量

---

**报告生成时间**：2025年11月18日  
**分析时间范围**：2025年11月18日 17:30之后  
**日志来源**：`build/EasyDarwin-aarch64-v8.3.3-202511181708/logs/20251118_16_00_00.log`

