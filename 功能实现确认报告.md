# 任务级告警图片保存配置功能实现确认报告

## ✅ 功能实现检查清单

### 1. 后端配置模型 ✅

**文件**: `internal/conf/model.go`

```go
type FrameExtractTask struct {
    // ... 其他字段
    SaveAlertImage *bool `json:"save_alert_image" mapstructure:"save_alert_image"`
}
```

**状态**: ✅ 已实现
- 字段类型：`*bool`（支持nil、true、false三种状态）
- JSON标签：`save_alert_image`
- MapStructure标签：`save_alert_image`

### 2. AI分析服务判断逻辑 ✅

**文件**: `internal/plugin/aianalysis/scheduler.go`

**函数**: `shouldSaveAlertImage(taskID string, algoConfig map[string]interface{}) bool`

**实现逻辑**:
1. ✅ 优先从任务配置读取（`task.SaveAlertImage`）
2. ✅ 其次从算法配置读取（兼容旧逻辑）
3. ✅ 默认返回true（保存告警图片）

**调用位置**: 
- ✅ `scheduler.go:608` - 在推理完成后判断是否保存告警图片

**状态**: ✅ 已实现

### 3. 服务方法 ✅

**文件**: `internal/plugin/frameextractor/service.go`

**方法1**: `GetTaskByID(id string) *conf.FrameExtractTask`
- ✅ 根据任务ID获取任务配置
- ✅ 返回任务副本，避免外部修改

**方法2**: `UpdateTaskSaveAlertImage(id string, saveAlertImage *bool) error`
- ✅ 更新任务的保存告警图片设置
- ✅ 自动持久化到配置文件
- ✅ 记录日志

**状态**: ✅ 已实现

### 4. API接口 ✅

**文件**: `internal/web/api/api.go`

**接口1**: `POST /api/v1/frame_extractor/tasks`
- ✅ 创建任务时支持`save_alert_image`字段
- ✅ 通过`ShouldBindJSON`自动绑定

**接口2**: `GET /api/v1/frame_extractor/tasks`
- ✅ 任务列表自动返回`save_alert_image`字段（通过JSON序列化）

**接口3**: `PUT /api/v1/frame_extractor/tasks/:id/save_alert_image`
- ✅ 更新任务的保存告警图片设置
- ✅ 支持`nil`、`true`、`false`三种值

**状态**: ✅ 已实现

### 5. 配置持久化 ✅

**文件**: `internal/plugin/frameextractor/persist.go`

**函数**: `buildTaskLines()`

**实现**:
```go
// 保存save_alert_image（如果设置了）
if t.SaveAlertImage != nil {
    lines = append(lines, fmt.Sprintf("save_alert_image = %t", *t.SaveAlertImage))
}
```

**状态**: ✅ 已实现
- ✅ 自动保存到`config.toml`
- ✅ 只在设置了值时才保存（nil时不保存）

### 6. 前端API接口 ✅

**文件**: `web-src/src/api/frameextractor.js`

**方法**: `updateSaveAlertImage(id, saveAlertImage)`
- ✅ 调用后端API更新设置
- ✅ 传递正确的参数格式

**状态**: ✅ 已实现

### 7. 前端UI实现 ✅

**文件**: `web-src/src/views/frame-extractor/index.vue`

**功能1**: 创建任务表单
- ✅ 添加了"保存告警图片"下拉选择框
- ✅ 选项：使用全局配置、保存、不保存
- ✅ 表单数据包含`save_alert_image`字段

**功能2**: 任务列表显示
- ✅ 添加了"保存告警图片"列
- ✅ 使用Popover + RadioGroup实现三态选择
- ✅ 颜色标签：绿色=保存，红色=不保存，灰色=全局

**功能3**: 快速修改
- ✅ 点击状态标签弹出选择框
- ✅ 选择后自动调用API更新
- ✅ 更新后自动刷新列表

**功能4**: 编辑任务
- ✅ 编辑时自动填充`save_alert_image`字段

**状态**: ✅ 已实现

## 🔍 代码流程验证

### 创建任务流程

1. **前端提交** → `POST /api/v1/frame_extractor/tasks`
   - ✅ 包含`save_alert_image`字段

2. **后端接收** → `AddTask(t conf.FrameExtractTask)`
   - ✅ 自动绑定到`FrameExtractTask`结构体
   - ✅ 保存到`cfg.Tasks`

3. **配置持久化** → `saveConfigToFile()`
   - ✅ 调用`buildTaskLines()`
   - ✅ 保存`save_alert_image`到`config.toml`

### 推理时判断流程

1. **推理完成** → `inferAndSave()`
   - ✅ 调用`shouldSaveAlertImage(image.TaskID, algoConfig)`

2. **读取任务配置** → `GetTaskByID(taskID)`
   - ✅ 获取任务配置
   - ✅ 检查`SaveAlertImage`字段

3. **判断是否保存**
   - ✅ 如果`SaveAlertImage != nil`，使用任务配置
   - ✅ 否则使用算法配置或全局配置

4. **执行操作**
   - ✅ 如果`shouldSaveAlertImage`返回`false`，删除图片，不保存告警
   - ✅ 如果返回`true`，保存告警图片

### 更新设置流程

1. **前端调用** → `updateSaveAlertImage(id, saveAlertImage)`
   - ✅ 调用`PUT /api/v1/frame_extractor/tasks/:id/save_alert_image`

2. **后端处理** → `UpdateTaskSaveAlertImage(id, saveAlertImage)`
   - ✅ 查找任务
   - ✅ 更新`SaveAlertImage`字段
   - ✅ 持久化到配置文件

3. **立即生效**
   - ✅ 下次推理时使用新配置

## 📊 功能完整性检查

| 功能点 | 后端 | 前端 | 状态 |
|--------|------|------|------|
| 配置模型定义 | ✅ | - | ✅ |
| 创建任务时配置 | ✅ | ✅ | ✅ |
| 任务列表显示 | ✅ | ✅ | ✅ |
| 更新保存设置 | ✅ | ✅ | ✅ |
| 配置持久化 | ✅ | - | ✅ |
| AI分析时判断 | ✅ | - | ✅ |
| 编辑任务时填充 | ✅ | ✅ | ✅ |

## ✅ 结论

**功能实现状态**: ✅ **已完整实现**

所有功能点都已实现：
1. ✅ 后端配置模型、服务方法、API接口、配置持久化
2. ✅ AI分析服务正确读取和使用任务配置
3. ✅ 前端UI完整支持创建、查看、修改功能
4. ✅ 配置优先级正确（任务级 > 算法配置 > 全局配置）

**可以正常使用！**

---

**检查时间**: 2025年11月19日  
**检查结果**: ✅ 功能已完整实现

