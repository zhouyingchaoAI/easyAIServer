# 智能推理方案 - 根据抽帧频率自适应

## 🎯 您的需求

1. **根据抽帧频率配置推理频率**
   - 抽帧快 → 推理采样或增加并发
   - 抽帧慢 → 推理全部处理

2. **推理太慢时产生告警**
   - 监控推理速度
   - 检测队列积压
   - 发出系统告警

3. **自动丢弃处理不完的图片**
   - 队列有最大容量
   - 超出容量丢弃旧图片
   - 保留最新图片优先处理

---

## ✅ 当前可用方案（无需改代码）

### 方案1：通过配置参数实现

**原理**：调整扫描间隔 = 控制每批处理数量

```toml
# 抽帧设置
[[frame_extractor.tasks]]
interval_ms = 200  # 每秒5张

# 推理设置
[ai_analysis]
scan_interval_sec = 5  # 每5秒扫描一次
# 效果：每次扫描发现25张，但只处理部分
# 旧的图片会被MinIO 1天清理 = 自动丢弃

max_concurrent_infer = 20  # 20个并发
```

**效果**：
- 每5秒处理一批（约25张）
- 如果推理慢，旧图片24小时后自动删除
- 实际推理 < 5张/秒（采样效果）

### 方案2：多级扫描策略

**配置多个扫描间隔**：

```bash
# 编辑配置
[ai_analysis]
# 快速扫描：处理最新的
scan_interval_sec = 1  # 每秒扫描
max_images_per_scan = 5  # 每次最多5张（丢弃其余）

# 效果：
# - 每秒最多处理5张
# - 超过5张的丢弃（不进入队列）
# - MinIO中积压的图片1天后删除
```

---

## 🔧 需要代码实现的完整方案

我已经为您设计了完整的代码方案（见`doc/SMART_INFERENCE_STRATEGY.md`），包括：

### 1. 智能队列（queue.go）
```go
- 最大容量：100张
- 满时策略：丢弃最旧的
- 统计：记录丢弃数量
```

### 2. 性能监控（monitor.go）
```go
- 监控：推理速度、队列积压
- 告警：推理太慢、队列积压
- 统计：平均时间、吞吐量
```

### 3. 自适应采样
```go
- 自动计算：推理能力vs抽帧速度
- 动态调整：采样率自动优化
- 实时反馈：保证不积压
```

### 4. 告警系统
```go
- 队列积压告警
- 推理慢告警
- 丢弃率高告警
```

---

## 🚀 立即可执行（配置方案）

### 配置A：固定处理量（推荐）

**设计思路**：每秒固定处理5张，多余的自动丢弃

```toml
[[frame_extractor.tasks]]
interval_ms = 200  # 抽帧：5张/秒

[ai_analysis]
scan_interval_sec = 1  # 扫描：每秒1次
max_concurrent_infer = 50  # 并发：50个

# 通过MinIO清理实现"丢弃"
# 命令：/tmp/mc ilm add ... --expiry-days 1
```

**工作方式**：
1. 抽帧产生5张/秒
2. 扫描每秒检查，发现5张
3. 如果推理快（<200ms），全部处理完
4. 如果推理慢（>1000ms），积压到MinIO
5. MinIO 1天后自动删除 = 自动丢弃

**优点**：
- ✅ 无需改代码
- ✅ 立即可用
- ✅ 自动丢弃（通过MinIO清理）

**缺点**：
- ❌ 丢弃延迟（1天后，不是实时）
- ❌ 无积压告警
- ❌ 无性能统计

### 配置B：降低采集+全部处理

**设计思路**：降低抽帧频率，确保全部推理

```toml
[[frame_extractor.tasks]]
interval_ms = 500  # 抽帧：2张/秒（降低）

[ai_analysis]
scan_interval_sec = 3  # 扫描：每3秒
max_concurrent_infer = 20
```

**工作方式**：
- 抽帧慢（2张/秒）
- 推理能跟上
- 全部图片都被处理
- 无丢弃

**优点**：
- ✅ 无积压
- ✅ 全部处理

**缺点**：
- ❌ 实时性降低

---

## 💡 我的建议

### 短期方案（今天）

使用**配置A**：

```bash
# 1. 确保当前配置
# - interval_ms = 200 (5张/秒)
# - scan_interval_sec = 1
# - max_concurrent_infer = 50
# - MinIO 1天清理

# 2. 添加监控
./monitor_inference.sh  # 实时监控性能

# 3. 根据监控结果调优
# 如果积压 → 增加并发或降低抽帧
```

### 中期方案（本周）

**我可以帮您实现代码层面的优化**：

1. ✅ 智能队列管理
2. ✅ 性能监控和告警
3. ✅ 自动采样调整
4. ✅ 实时丢弃旧图片

**需要的工作**：
- 新增3个Go文件（queue.go, monitor.go, alert.go）
- 修改service.go集成新功能
- 添加API接口查询性能统计
- 重新编译部署

**预计时间**：2-3小时

### 长期方案（本月）

**完整的智能系统**：
- 机器学习预测推理时间
- 自动扩缩容算法服务
- 分级处理（重要任务优先）
- 完整的监控大屏

---

## 📊 三种方案对比

| 方案 | 实现难度 | 时间 | 效果 |
|------|---------|------|------|
| **配置方案** | ⭐ 简单 | 立即 | 基本满足，通过MinIO清理实现丢弃 |
| **代码优化** | ⭐⭐ 中等 | 2-3小时 | 完全满足，实时丢弃+告警 |
| **完整系统** | ⭐⭐⭐ 复杂 | 数天 | 完美，AI驱动的自适应 |

---

## 🎯 您需要决定

### 选项1：使用当前配置方案
- 已配置好，立即可用
- 通过MinIO清理实现延迟丢弃
- 手动监控性能

### 选项2：我帮您开发代码优化
- 实时智能队列
- 推理慢告警
- 自动丢弃图片
- 需要2-3小时开发+测试

**您希望我继续开发代码优化吗？**

---

## 📋 开发清单（如果选择选项2）

### 需要新增的代码文件

1. `internal/plugin/aianalysis/queue.go`
   - SmartQueue结构
   - Add/Pop/Drop方法
   - 统计功能

2. `internal/plugin/aianalysis/monitor.go`
   - PerformanceMonitor结构
   - 性能统计
   - 告警触发

3. `internal/plugin/aianalysis/alert.go`
   - SystemAlert结构
   - 告警发送
   - 告警记录

4. 修改 `internal/plugin/aianalysis/service.go`
   - 集成智能队列
   - 集成性能监控
   - 添加告警处理

5. 新增 `internal/web/api/performance.go`
   - GET /api/v1/ai_analysis/performance
   - GET /api/v1/ai_analysis/queue_stats
   - POST /api/v1/ai_analysis/sampling

---

<div align="center">

## 🤔 您的选择？

**选项1**: 使用当前配置（立即可用）  
**选项2**: 开发完整智能系统（2-3小时）

**当前系统已经可以达到5张/秒的处理能力**  
**代码优化可以添加智能告警和实时丢弃**

</div>

