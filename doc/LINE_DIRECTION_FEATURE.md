# 线条方向检测功能说明

## 功能概述

在算法配置模块中绘制检测线时，现在支持配置线条的检测方向，并在画布上显示直观的箭头标识，帮助用户清晰地理解检测方向。

## 功能特性

### 1. 三种检测方向

- **← 左到右 →**: 只检测从左边穿过线条到右边的目标
- **→ 右到左 ←**: 只检测从右边穿过线条到左边的目标  
- **↔ 双向统计 ↔**: 检测双向穿越线条的所有目标

### 2. 可视化箭头指示器

系统会根据配置的方向自动在线条上绘制箭头：

- **左到右方向**: 在线段 3/4 处显示一个向右的箭头 →
- **右到左方向**: 在线段 1/4 处显示一个向左的箭头 ←
- **双向统计**: 在线段 1/4 和 3/4 处各显示一个箭头 ↔

### 3. 动态更新

- 修改线条颜色时，箭头颜色会自动同步更新
- 切换检测方向时，箭头会立即重新绘制并更新位置和方向
- 删除线条时，关联的箭头会自动清除

## 使用方法

### 步骤 1: 绘制线条

1. 打开算法配置弹窗
2. 点击"绘制线"按钮
3. 在画布上点击起点
4. 再点击终点完成线条绘制
5. 默认会创建一条"左到右"方向的检测线，并显示箭头

### 步骤 2: 配置方向

1. 在右侧配置面板找到绘制的线条
2. 展开对应的配置项
3. 在"检测方向"下拉框中选择需要的方向：
   - ← 左到右 →
   - → 右到左 ←
   - ↔ 双向统计 ↔
4. 画布上的箭头会立即更新

### 步骤 3: 自定义样式

您还可以调整：
- **颜色**: 修改线条和箭头的颜色
- **透明度**: 调整显示透明度（仅影响线条）
- **区域名称**: 设置有意义的名称以便识别

### 步骤 4: 保存配置

1. 检查所有线条的方向和样式
2. 点击右上角"保存配置"按钮
3. 配置会保存到后端，供算法使用

## 技术实现

### 箭头绘制算法

```javascript
// 计算线段角度
const angle = Math.atan2(p2[1] - p1[1], p2[0] - p1[0])

// 根据方向确定箭头位置
- 左到右: 位置 = 起点 + (终点-起点) * 0.75，角度 = angle
- 右到左: 位置 = 起点 + (终点-起点) * 0.25，角度 = angle + π
- 双向: 两个位置 (0.25 和 0.75)，相反的角度
```

### 箭头形状

箭头使用三角形多边形 (Polygon) 实现：
- 尖端指向检测方向
- 大小: 12 像素
- 角度: ±30° (π/6)
- 不可选中、不响应事件（selectable: false, evented: false）

### 数据结构

线条区域的配置数据结构：

```json
{
  "id": "region_1234567890",
  "name": "线_1",
  "type": "line",
  "enabled": true,
  "points": [[100, 200], [400, 300]],
  "properties": {
    "color": "#FF0000",
    "thickness": 3,
    "direction": "left_to_right"  // 或 "right_to_left", "bidirectional"
  }
}
```

## 应用场景

### 1. 人流统计

- 设置入口线为"左到右"
- 设置出口线为"右到左"
- 分别统计进入和离开的人数

### 2. 车流监控

- 在道路上画线
- 根据车道方向设置检测方向
- 统计单向或双向车流量

### 3. 禁行区域监测

- 在禁行区边界画线
- 设置为单向检测
- 监测是否有目标非法进入

### 4. 客流分析

- 在商场通道画线
- 使用双向统计
- 分析顾客流动模式

## 注意事项

1. **方向定义**: "左到右"和"右到左"是相对于线条绘制方向的
   - 绘制时第一个点为起点（左），第二个点为终点（右）
   - 建议从画面左侧向右侧绘制，保持一致性

2. **箭头位置**: 箭头不在线条端点，而是在线段内部
   - 避免与其他UI元素重叠
   - 更清晰地表示中间穿越的概念

3. **性能考虑**: 
   - 箭头是独立的图形对象，不影响线条本身
   - 修改方向时会重新绘制箭头
   - 大量线条时可能影响渲染性能

4. **配置保存**: 
   - 方向配置保存在 `properties.direction` 字段中
   - 后端算法需要解析此字段来执行相应的检测逻辑

## 兼容性

- ✅ 与现有的矩形、多边形绘制功能完全兼容
- ✅ 支持加载历史配置（未设置方向的旧配置会默认为"左到右"）
- ✅ 支持撤销、重置等操作
- ✅ 箭头会随线条一起删除

## 更新日志

### v1.0 (2025-10-20)

- ✨ 新增线条方向配置功能
- ✨ 新增箭头可视化指示器
- ✨ 支持三种检测方向：左到右、右到左、双向
- 🎨 箭头颜色与线条颜色自动同步
- 🐛 修复删除线条时箭头残留的问题
- 📝 完善提示信息，引导用户配置方向

## 文件修改

主要修改文件：
- `/web-src/src/components/AlgoConfigModal/index.vue`

新增函数：
- `drawArrowsForLine()` - 绘制箭头
- `createArrow()` - 创建单个箭头
- `removeArrowsForLine()` - 移除箭头
- `updateRegionArrow()` - 更新箭头

修改函数：
- `drawLine()` - 添加箭头绘制
- `drawRegionOnCanvas()` - 加载时绘制箭头
- `updateRegionStyle()` - 更新时同步箭头
- `deleteRegion()` - 删除时清理箭头
- `clearAll()` - 清空时包含箭头
- `deleteSelected()` - 批量删除时处理箭头

## 未来扩展

可能的改进方向：

1. **自定义箭头样式**
   - 可配置箭头大小
   - 可选择不同箭头形状（三角形、箭头线等）

2. **方向提示动画**
   - 箭头闪烁效果
   - 流动动画表示方向

3. **智能方向建议**
   - 根据线条绘制方向自动推荐检测方向
   - 根据场景自动建议最佳配置

4. **更多方向选项**
   - 上到下、下到上（用于垂直线）
   - 自定义角度方向

5. **方向检测结果展示**
   - 实时显示各方向的检测计数
   - 可视化统计图表

