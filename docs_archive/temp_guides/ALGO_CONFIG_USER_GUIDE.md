# 算法配置功能使用指南

## 📚 yanying智能视频分析平台 - 算法配置使用手册

**版本**: v1.0  
**更新日期**: 2024-10-17

---

## 🎯 功能概述

本功能允许您在Web界面上为每个抽帧任务配置算法参数：
- ✅ 绘制检测区域（线、矩形、多边形）
- ✅ 配置多个分析区域
- ✅ 设置算法参数（置信度、IOU等）
- ✅ 配置保存到MinIO，自动传递给算法服务

---

## 🚀 快速开始

### 步骤1: 添加抽帧任务

1. 访问 `http://localhost:5066`
2. 进入【抽帧管理】页面
3. 填写任务信息：
   - 任务ID: `cam_entrance_001`
   - 任务类型: `人数统计`
   - RTSP地址: `rtsp://...`
   - 抽帧间隔: `1000ms`
4. 点击"添加任务"

**结果**:
- ✅ 任务创建成功
- ✅ 系统自动抽取1张预览图
- ✅ 任务状态：待配置（unconfigured）
- ✅ 任务自动停止，等待配置

### 步骤2: 配置算法参数

1. 在任务列表中找到刚创建的任务
2. 等待预览图生成（约3-5秒）
3. 点击"算法配置"按钮（齿轮图标）
4. 在弹出的配置界面中：
   - **左侧**：预览图 + 绘图画布
   - **右侧**：区域配置面板

### 步骤3: 绘制检测区域

#### 绘制多边形
1. 点击"绘制多边形"按钮
2. 在画布上依次点击添加顶点
3. 双击或右键完成绘制
4. 右侧面板会出现区域配置

#### 绘制矩形
1. 点击"绘制矩形"按钮
2. 在画布上点击第一个角
3. 点击对角即可完成

#### 绘制线
1. 点击"绘制线"按钮
2. 点击起点
3. 点击终点完成

### 步骤4: 配置区域属性

在右侧配置面板中，可以为每个区域设置：
- **区域名称**: 如"入口区域"
- **颜色**: 点击颜色选择器
- **透明度**: 拖动滑块调整
- **检测阈值**: 0-1之间的数值
- **方向**（仅线）: 进入/离开/双向
- **启用/禁用**: 开关按钮

### 步骤5: 设置算法参数

在配置面板底部：
- **置信度阈值**: 默认0.7
- **IOU阈值**: 默认0.5

### 步骤6: 保存配置

点击右上角"保存配置"按钮：
- ✅ 配置保存到MinIO (`algo_config.json`)
- ✅ 任务状态变为"已配置"（configured）
- ✅ 弹窗自动关闭

### 步骤7: 启动抽帧

**方式1 - 手动启动**:
- 点击任务的"启动"按钮（播放图标）
- 开始正常抽帧和AI推理

**方式2 - 自动启动**:
- 当对应task_type的算法服务上线时
- 系统自动启动已配置的任务

---

## 📐 配置示例

### 场景1: 人数统计（多边形区域）

**需求**: 统计大厅入口处的人数

**配置**:
1. 绘制一个多边形覆盖入口区域
2. 设置：
   - 区域名称：`入口区域`
   - 颜色：红色 `#FF0000`
   - 透明度：0.3
   - 检测阈值：0.7

**效果**: 只统计在多边形区域内的人数

---

### 场景2: 越线检测（线）

**需求**: 检测人员跨越警戒线

**配置**:
1. 绘制一条横线作为警戒线
2. 设置：
   - 区域名称：`警戒线`
   - 颜色：黄色 `#FFFF00`
   - 方向：双向
   - 线宽：5

**效果**: 检测人员越过该线的行为

---

### 场景3: 区域入侵（多区域）

**需求**: 监控多个禁止区域

**配置**:
1. 绘制第一个矩形：
   - 区域名称：`禁区1`
   - 颜色：红色
2. 绘制第二个矩形：
   - 区域名称：`禁区2`
   - 颜色：红色
3. 绘制第三个多边形：
   - 区域名称：`禁区3`
   - 颜色：红色

**效果**: 检测在任意禁止区域内的入侵行为

---

## 🔧 高级功能

### 编辑已有配置

1. 点击"算法配置"按钮
2. 会自动加载已有配置
3. 可以修改区域属性
4. 可以添加/删除区域
5. 保存即可更新

### 禁用某个区域

在右侧配置面板中，关闭该区域的开关即可。
- 禁用的区域不会参与检测
- 但配置仍然保留

### 删除区域

**方式1**: 在画布上选中区域，点击"删除选中"  
**方式2**: 在右侧面板展开该区域，点击"删除此区域"

### 清空所有区域

点击工具栏的"清空全部"按钮

### 重置配置

点击"重置"按钮，恢复到上次保存的状态

---

## 📊 配置查看

### 查看JSON配置

配置保存在MinIO中：
```
路径：frames/{task_type}/{task_id}/algo_config.json
```

访问MinIO控制台可以查看和下载配置文件。

### API查询

```bash
curl http://localhost:5066/api/v1/frame_extractor/tasks/cam_entrance_001/config
```

---

## 🎨 绘图技巧

### 多边形绘制

1. 点击"绘制多边形"
2. 沿着目标区域边缘依次点击
3. 最后双击或右键完成
4. 系统会自动闭合多边形

**提示**: 至少需要3个顶点

### 精确绘制

1. 使用鼠标滚轮可以缩放画布（如果实现）
2. 可以拖动已绘制的图形调整位置
3. 可以拖动角点调整大小

### 颜色选择

建议为不同功能的区域使用不同颜色：
- 红色 `#FF0000` - 禁止区域
- 黄色 `#FFFF00` - 警告区域
- 绿色 `#00FF00` - 正常区域
- 蓝色 `#0000FF` - 统计区域

---

## ⚙️ 算法参数说明

### 置信度阈值 (confidence_threshold)

- **范围**: 0.0 - 1.0
- **默认**: 0.7
- **说明**: 低于此值的检测结果会被过滤
- **建议**:
  - 要求高准确率：0.8-0.9
  - 平衡准确率和召回率：0.6-0.7
  - 要求高召回率：0.4-0.5

### IOU阈值 (iou_threshold)

- **范围**: 0.0 - 1.0
- **默认**: 0.5
- **说明**: NMS（非极大值抑制）的IOU阈值
- **建议**:
  - 密集场景：0.3-0.4
  - 正常场景：0.5
  - 稀疏场景：0.6-0.7

---

## 🔄 工作流程

```
添加任务
    ↓
自动抽取1张预览图（3-5秒）
    ↓
任务状态：待配置 🟠
    ↓
点击"算法配置"
    ↓
绘制区域 + 设置参数
    ↓
保存配置
    ↓
任务状态：已配置 🟢
    ↓
启动任务（手动或自动）
    ↓
正常抽帧 + AI推理（使用配置）
```

---

## ⚠️ 注意事项

### 1. 预览图生成时间

- 添加任务后需要3-5秒生成预览图
- 预览图未生成时，"算法配置"按钮为禁用状态
- 刷新任务列表可以查看是否生成完成

### 2. 配置保存要求

- 至少绘制一个区域才能保存
- 所有区域都会被保存，包括禁用的

### 3. 任务启动条件

**手动启动**: 任意时候都可以点击启动  
**自动启动**: 需要满足：
- 任务状态为"已配置"
- 任务当前未运行
- 对应task_type的算法服务在线

### 4. 配置更新

- 更新配置后需要重启任务才生效
- 建议：停止任务 → 更新配置 → 启动任务

### 5. 坐标系统

- 所有坐标基于预览图的原始分辨率
- 算法服务收到的也是原始坐标
- 如果视频分辨率不同，算法需要自行处理

---

## 🧪 测试验证

### 1. 验证预览图生成

```bash
# 查看日志
tail -f logs/sugar.log | grep "preview frame"

# 应该看到：
# [INFO] extracting preview frame task=cam_entrance_001
# [INFO] preview frame uploaded to minio task=cam_entrance_001 path=frames/...
```

### 2. 验证配置保存

```bash
# 查看MinIO
# 访问 http://minio-host:9000
# 查看 images/frames/{task_type}/{task_id}/algo_config.json
```

### 3. 验证推理请求

```bash
# 查看算法服务日志
# 应该看到包含algo_config的推理请求
```

---

## 📞 技术支持

### 文档

- **算法配置规范**: `doc/ALGORITHM_CONFIG_SPEC.md`
- **算法对接指南**: `doc/ALGORITHM_INTEGRATION_GUIDE.md`
- **API文档**: `doc/EasyDarwin.api.html`

### 示例

- **算法服务示例**: `examples/algorithm_service.py`
- **YOLO服务示例**: `examples/yolo_algorithm_service.py`

### 联系

- **项目地址**: https://github.com/zhouyingchaoAI/easyAIServer
- **提交Issue**: 提交问题和建议

---

## ❓ 常见问题

### Q1: 预览图一直不生成？

**原因**: RTSP地址可能无法访问

**解决**:
1. 检查RTSP地址是否正确
2. 测试RTSP连接：`ffmpeg -i rtsp://... -frames:v 1 test.jpg`
3. 查看日志：`tail -f logs/sugar.log | grep "preview"`

### Q2: 配置保存失败？

**原因**: MinIO未正确配置

**解决**:
1. 检查 `config.toml` 中的MinIO配置
2. 运行测试：`python3 test_minio_connection.py`
3. 确保bucket存在

### Q3: 算法服务没有收到配置？

**原因**: 可能未正确加载

**解决**:
1. 检查算法服务日志，确认收到 `algo_config` 字段
2. 后端日志查看：`grep "algo config" logs/sugar.log`

### Q4: 任务不会自动启动？

**原因**: 配置或算法服务状态问题

**检查**:
1. 任务配置状态是否为"已配置"
2. 算法服务是否在线：`curl http://localhost:5066/api/v1/ai_analysis/services`
3. task_type是否匹配

### Q5: 如何导出/导入配置？

**导出**:
```bash
curl http://localhost:5066/api/v1/frame_extractor/tasks/cam_001/config > config.json
```

**导入**:
```bash
curl -X POST http://localhost:5066/api/v1/frame_extractor/tasks/cam_001/config \
  -H "Content-Type: application/json" \
  -d @config.json
```

---

## 🎓 最佳实践

### 1. 区域设计

- **精确性**: 区域边界应紧贴目标区域
- **数量**: 一般1-5个区域即可，过多影响性能
- **命名**: 使用有意义的名称，如"入口"、"禁区1"

### 2. 参数调优

- **开发阶段**: 使用较低阈值（0.5-0.6），便于测试
- **生产环境**: 根据实际效果调整到0.7-0.8
- **A/B测试**: 对比不同参数的效果

### 3. 配置管理

- **备份配置**: 定期导出JSON配置
- **版本管理**: 重大调整前先备份
- **文档记录**: 记录配置变更原因

---

## 📋 完整示例

### 人数统计 - 多区域配置

**场景**: 统计商场三个入口的人数

**配置**:
```json
{
  "task_id": "mall_entrance",
  "task_type": "人数统计",
  "regions": [
    {
      "id": "region_001",
      "name": "东门",
      "type": "polygon",
      "enabled": true,
      "points": [[100, 150], [400, 150], [400, 450], [100, 450]],
      "properties": {"color": "#FF0000", "opacity": 0.3}
    },
    {
      "id": "region_002",
      "name": "西门",
      "type": "polygon",
      "enabled": true,
      "points": [[500, 150], [800, 150], [800, 450], [500, 450]],
      "properties": {"color": "#00FF00", "opacity": 0.3}
    },
    {
      "id": "region_003",
      "name": "南门",
      "type": "rectangle",
      "enabled": true,
      "points": [[900, 150], [1200, 450]],
      "properties": {"color": "#0000FF", "opacity": 0.3}
    }
  ],
  "algorithm_params": {
    "confidence_threshold": 0.75
  }
}
```

### 越线检测 - 双向监控

**场景**: 监控进出通道

**配置**:
```json
{
  "task_id": "gate_monitor",
  "task_type": "区域入侵",
  "regions": [
    {
      "id": "region_001",
      "name": "入口线",
      "type": "line",
      "enabled": true,
      "points": [[300, 200], [600, 200]],
      "properties": {
        "color": "#4ECDC4",
        "thickness": 5,
        "direction": "in"
      }
    },
    {
      "id": "region_002",
      "name": "出口线",
      "type": "line",
      "enabled": true,
      "points": [[300, 400], [600, 400]],
      "properties": {
        "color": "#FFE66D",
        "thickness": 5,
        "direction": "out"
      }
    }
  ],
  "algorithm_params": {
    "confidence_threshold": 0.8
  }
}
```

---

## 🔍 故障排查

### 问题：配置按钮一直禁用

**检查**:
```bash
# 1. 查看任务列表，确认preview_image字段
curl http://localhost:5066/api/v1/frame_extractor/tasks

# 2. 查看预览图生成日志
grep "preview frame" logs/sugar.log

# 3. 手动触发预览图生成（如需要）
# 目前是自动触发，如果失败可能需要重新添加任务
```

### 问题：配置保存后推理仍无效

**检查**:
```bash
# 1. 确认配置已保存
curl http://localhost:5066/api/v1/frame_extractor/tasks/cam_001/config

# 2. 查看推理请求日志
grep "algo_config" logs/sugar.log

# 3. 查看算法服务接收的请求
# 在算法服务端查看日志
```

---

## ✅ 检查清单

使用前检查：

- [ ] MinIO配置正确
- [ ] 抽帧任务已创建
- [ ] 预览图已生成
- [ ] 可以打开配置界面
- [ ] 可以绘制区域
- [ ] 可以保存配置
- [ ] 算法服务已注册
- [ ] 算法服务支持对应task_type

---

**祝您使用愉快！** 🎉

如有问题，请查阅相关文档或提交Issue。

