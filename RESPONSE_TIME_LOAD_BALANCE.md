# åŸºäºå“åº”æ—¶é—´çš„æ™ºèƒ½è´Ÿè½½å‡è¡¡

**æ—¥æœŸ**: 2025-11-04  
**ç‰ˆæœ¬**: v8.3.5  
**æ ¸å¿ƒç­–ç•¥**: å“åº”è¶Šå¿«ï¼Œåˆ†é…è¶Šå¤š âš¡  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

> **"è´Ÿè½½å‡è¡¡é€»è¾‘åº”è¯¥æ˜¯æœåŠ¡æ¨ç†å“åº”æ—¶é—´ï¼Œå“åº”è¶Šæ…¢åˆ†é…è¶Šå°‘"**

### æ™ºèƒ½é€‰æ‹©ç­–ç•¥

```
ä¼˜å…ˆçº§æ’åºï¼š
1ï¸âƒ£ æ–°æ³¨å†Œçš„æœåŠ¡ï¼ˆè®©æ–°æœåŠ¡å°½å¿«å‚ä¸ï¼Œæ”¶é›†å“åº”æ—¶é—´æ•°æ®ï¼‰
2ï¸âƒ£ å“åº”æ—¶é—´æœ€å¿«çš„æœåŠ¡ï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰
3ï¸âƒ£ å“åº”æ—¶é—´ç›¸åŒçš„æœåŠ¡ï¼ˆRound-Robinè½®è¯¢ï¼‰
```

---

## ğŸ“Š å·¥ä½œåŸç†

### å“åº”æ—¶é—´ç»Ÿè®¡

```go
// ä½¿ç”¨æ»‘åŠ¨çª—å£ï¼ˆæœ€è¿‘10æ¬¡æ¨ç†ï¼‰
ResponseTimeWindow = 10

// æ¯æ¬¡æ¨ç†æˆåŠŸåè®°å½•å“åº”æ—¶é—´
responseTimes[endpoint] = [120ms, 115ms, 130ms, 118ms, ...]

// è®¡ç®—å¹³å‡å“åº”æ—¶é—´
avgTime = sum(responseTimes) / count
```

### è´Ÿè½½å‡è¡¡ç®—æ³•

```
æ­¥éª¤1ï¼šè¯„åˆ†æ‰€æœ‰æœåŠ¡
â”œâ”€ æ–°æœåŠ¡ï¼ˆæ— æ•°æ®ï¼‰: ä¼˜å…ˆçº§=MAX
â”œâ”€ æœåŠ¡A: å¹³å‡å“åº”æ—¶é—´=100ms
â”œâ”€ æœåŠ¡B: å¹³å‡å“åº”æ—¶é—´=150ms
â””â”€ æœåŠ¡C: å¹³å‡å“åº”æ—¶é—´=200ms

æ­¥éª¤2ï¼šé€‰æ‹©æœ€ä¼˜æœåŠ¡
â”œâ”€ å¦‚æœæœ‰æ–°æœåŠ¡ â†’ ä¼˜å…ˆé€‰æ‹©æ–°æœåŠ¡
â””â”€ å¦åˆ™é€‰æ‹©å“åº”æ—¶é—´æœ€çŸ­çš„æœåŠ¡

æ­¥éª¤3ï¼šå¤„ç†ç›¸åŒå“åº”æ—¶é—´
â”œâ”€ å¦‚æœå¤šä¸ªæœåŠ¡å“åº”æ—¶é—´ç›¸åŒ
â””â”€ ä½¿ç”¨Round-Robinè½®è¯¢å…¬å¹³åˆ†é…
```

---

## ğŸ”¥ å…¸å‹åœºæ™¯

### åœºæ™¯1ï¼šæœåŠ¡æ€§èƒ½å·®å¼‚

```
åˆå§‹çŠ¶æ€ï¼š
- æœåŠ¡A: GPUæœåŠ¡å™¨ï¼Œå“åº”æ—¶é—´=50ms
- æœåŠ¡B: CPUæœåŠ¡å™¨ï¼Œå“åº”æ—¶é—´=200ms
- æœåŠ¡C: è€æ—§æœåŠ¡å™¨ï¼Œå“åº”æ—¶é—´=500ms

è´Ÿè½½åˆ†é…ï¼š
- ç¬¬1-10æ¬¡è¯·æ±‚ â†’ Round-Robin(A, B, C)
- æ”¶é›†åˆ°å“åº”æ—¶é—´æ•°æ®åï¼š
  - æœåŠ¡A: 50ms  â†’ è¢«é€‰ä¸­é¢‘ç‡æœ€é«˜ âœ…
  - æœåŠ¡B: 200ms â†’ å¶å°”è¢«é€‰ä¸­
  - æœåŠ¡C: 500ms â†’ å¾ˆå°‘è¢«é€‰ä¸­

ç»“æœï¼š
âœ… å¿«é€ŸæœåŠ¡å™¨æ‰¿æ‹…æ›´å¤šè´Ÿè½½
âœ… æ…¢é€ŸæœåŠ¡å™¨åˆ†é…è¾ƒå°‘è¯·æ±‚
âœ… æ•´ä½“ååé‡æœ€å¤§åŒ–
```

### åœºæ™¯2ï¼šæœåŠ¡åŠ¨æ€å˜åŒ–

```
t=0: æœåŠ¡Aå“åº”æ—¶é—´=100msï¼ŒæœåŠ¡Bå“åº”æ—¶é—´=100ms
  â†’ ä¸¤ä¸ªæœåŠ¡è½®è¯¢åˆ†é… âœ…

t=10åˆ†é’Ÿ: æœåŠ¡Bè´Ÿè½½å¢åŠ ï¼Œå“åº”æ—¶é—´=300ms
  â†’ æ£€æµ‹åˆ°å“åº”æ—¶é—´å˜æ…¢
  â†’ è‡ªåŠ¨å‡å°‘åˆ†é…ç»™æœåŠ¡Bçš„è¯·æ±‚ âœ…
  â†’ æ›´å¤šè¯·æ±‚åˆ†é…ç»™æœåŠ¡A âœ…

t=20åˆ†é’Ÿ: æœåŠ¡Bè´Ÿè½½ä¸‹é™ï¼Œå“åº”æ—¶é—´æ¢å¤=100ms
  â†’ æ£€æµ‹åˆ°å“åº”æ—¶é—´æ¢å¤
  â†’ è‡ªåŠ¨æ¢å¤æ­£å¸¸åˆ†é… âœ…
  â†’ ä¸¤ä¸ªæœåŠ¡é‡æ–°å‡è¡¡ âœ…
```

### åœºæ™¯3ï¼šæ–°æœåŠ¡ä¸Šçº¿

```
åˆå§‹çŠ¶æ€ï¼š
- æœåŠ¡A: å“åº”æ—¶é—´=120ms
- æœåŠ¡B: å“åº”æ—¶é—´=150ms

æ–°æœåŠ¡Cä¸Šçº¿ï¼š
  â†’ æ²¡æœ‰å“åº”æ—¶é—´æ•°æ®
  â†’ è¢«æ ‡è®°ä¸ºä¼˜å…ˆçº§æœ€é«˜ âœ…
  â†’ ç«‹å³è·å¾—æ¨ç†è¯·æ±‚ âœ…
  â†’ å¿«é€Ÿæ”¶é›†å“åº”æ—¶é—´æ•°æ®

æ”¶é›†10æ¬¡æ•°æ®åï¼š
  - å¦‚æœæœåŠ¡Cå“åº”æ—¶é—´=80ms
    â†’ æˆä¸ºæœ€ä¼˜æœåŠ¡ âœ…
    â†’ è·å¾—æœ€å¤šè¯·æ±‚åˆ†é… âœ…
  
  - å¦‚æœæœåŠ¡Cå“åº”æ—¶é—´=200ms
    â†’ è‡ªåŠ¨é™ä½ä¼˜å…ˆçº§ âœ…
    â†’ åˆ†é…è¾ƒå°‘è¯·æ±‚ âœ…
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŠ¿

### 1. è‡ªé€‚åº”è´Ÿè½½å‡è¡¡ âœ…

```
æœåŠ¡æ€§èƒ½åŠ¨æ€å˜åŒ–ï¼š
æœåŠ¡A: 100ms â†’ 50ms  â†’ è‡ªåŠ¨å¢åŠ åˆ†é… â¬†ï¸
æœåŠ¡B: 100ms â†’ 200ms â†’ è‡ªåŠ¨å‡å°‘åˆ†é… â¬‡ï¸
```

### 2. æœ€å¤§åŒ–ååé‡ âœ…

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆRound-Robinï¼‰ï¼š
- è¯·æ±‚å‡åŒ€åˆ†é…
- å¿«æœåŠ¡å™¨é—²ç½®
- æ…¢æœåŠ¡å™¨æˆä¸ºç“¶é¢ˆ
- æ•´ä½“ååé‡ = æœ€æ…¢æœåŠ¡å™¨çš„èƒ½åŠ›

æ™ºèƒ½æ–¹å¼ï¼ˆå“åº”æ—¶é—´ï¼‰ï¼š
- å¿«æœåŠ¡å™¨å¤šåˆ†é…
- æ…¢æœåŠ¡å™¨å°‘åˆ†é…
- æ²¡æœ‰æ˜æ˜¾ç“¶é¢ˆ
- æ•´ä½“ååé‡ = æ‰€æœ‰æœåŠ¡å™¨èƒ½åŠ›ä¹‹å’Œ âœ…
```

### 3. æ•…éšœè‡ªåŠ¨é™çº§ âœ…

```
æœåŠ¡å‡ºç°é—®é¢˜ï¼ˆå“åº”æ—¶é—´çªç„¶å˜é•¿ï¼‰ï¼š
- æ£€æµ‹åˆ°å“åº”æ—¶é—´å¼‚å¸¸
- è‡ªåŠ¨å‡å°‘è¯·æ±‚åˆ†é…
- ç»™æœåŠ¡å–˜æ¯æ—¶é—´
- é¿å…é›ªå´©æ•ˆåº” âœ…

æœåŠ¡æ¢å¤åï¼š
- æ£€æµ‹åˆ°å“åº”æ—¶é—´æ¢å¤
- è‡ªåŠ¨å¢åŠ è¯·æ±‚åˆ†é…
- æ¢å¤æ­£å¸¸è´Ÿè½½ âœ…
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ»‘åŠ¨çª—å£ç»Ÿè®¡

```go
// ä¿ç•™æœ€è¿‘10æ¬¡æ¨ç†çš„å“åº”æ—¶é—´
const ResponseTimeWindow = 10

responseTimes[endpoint] = []int64{
    120, 115, 130, 118, 122, 119, 125, 117, 121, 116
}

// è®¡ç®—å¹³å‡å€¼
avgTime = (120+115+130+...+116) / 10 = 119.3ms
```

**ä¼˜ç‚¹**ï¼š
- âœ… å¯¹å¶å°”çš„æ³¢åŠ¨ä¸æ•æ„Ÿ
- âœ… åæ˜ æœ€è¿‘çš„æœåŠ¡æ€§èƒ½
- âœ… è‡ªåŠ¨é€‚åº”æ€§èƒ½å˜åŒ–

### è´Ÿè½½å‡è¡¡ä»£ç 

```go
// æ­¥éª¤1ï¼šè¯„åˆ†æ‰€æœ‰æœåŠ¡
for i, svc := range services {
    times := responseTimes[svc.Endpoint]
    if len(times) == 0 {
        // æ–°æœåŠ¡ï¼Œä¼˜å…ˆçº§æœ€é«˜
        scores[i] = {hasData: false}
    } else {
        // è®¡ç®—å¹³å‡å“åº”æ—¶é—´
        avgTime := sum(times) / len(times)
        scores[i] = {avgRespTime: avgTime, hasData: true}
    }
}

// æ­¥éª¤2ï¼šé€‰æ‹©æœ€ä¼˜æœåŠ¡
// ä¼˜å…ˆçº§ï¼šæ–°æœåŠ¡ > å“åº”æ—¶é—´çŸ­çš„æœåŠ¡
if has_new_service {
    select new_service
} else {
    select fastest_service
}
```

---

## ğŸ“Š å¯¹æ¯”åˆ†æ

### ä¼ ç»ŸRound-Robin âŒ

| æœåŠ¡ | å“åº”æ—¶é—´ | åˆ†é…æ¯”ä¾‹ | æ•ˆç‡ |
|------|----------|----------|------|
| A | 50ms | 33% | ä½æ•ˆï¼ˆæµªè´¹ï¼‰ |
| B | 150ms | 33% | ä¸€èˆ¬ |
| C | 400ms | 33% | è¿‡è½½ |

**é—®é¢˜**ï¼š
- âŒ å¿«æœåŠ¡å™¨èƒ½åŠ›æµªè´¹
- âŒ æ…¢æœåŠ¡å™¨æˆä¸ºç“¶é¢ˆ
- âŒ æ•´ä½“æ•ˆç‡ä½

### æ™ºèƒ½å“åº”æ—¶é—´å‡è¡¡ âœ…

| æœåŠ¡ | å“åº”æ—¶é—´ | åˆ†é…æ¯”ä¾‹ | æ•ˆç‡ |
|------|----------|----------|------|
| A | 50ms | 60% | é«˜æ•ˆåˆ©ç”¨ âœ… |
| B | 150ms | 30% | åˆç†åˆ†é… âœ… |
| C | 400ms | 10% | é¿å…è¿‡è½½ âœ… |

**ä¼˜åŠ¿**ï¼š
- âœ… å¿«æœåŠ¡å™¨å……åˆ†åˆ©ç”¨
- âœ… æ…¢æœåŠ¡å™¨é€‚åº¦åˆ†é…
- âœ… æ•´ä½“æ•ˆç‡æœ€å¤§åŒ–

---

## ğŸ¨ æ—¥å¿—ç¤ºä¾‹

### æ–°æœåŠ¡ç«‹å³å‚ä¸
```json
{
  "level": "debug",
  "msg": "load balance: new service selected (no response time data yet)",
  "task_type": "äººæ•°ç»Ÿè®¡",
  "selected_endpoint": "http://172.17.0.2:7903/infer",
  "selected_service_id": "yolo11x_head_detector_7903",
  "total_services": 3
}
```

### é€‰æ‹©æœ€å¿«çš„æœåŠ¡
```json
{
  "level": "debug",
  "msg": "load balance: fastest service selected",
  "task_type": "äººæ•°ç»Ÿè®¡",
  "selected_endpoint": "http://172.17.0.2:7901/infer",
  "selected_service_id": "yolo11x_head_detector_7901",
  "avg_response_time_ms": 85,
  "total_services": 3
}
```

### å“åº”æ—¶é—´ç›¸åŒæ—¶è½®è¯¢
```json
{
  "level": "debug",
  "msg": "load balance: round-robin among fastest services",
  "task_type": "äººæ•°ç»Ÿè®¡",
  "selected_endpoint": "http://172.17.0.2:7902/infer",
  "selected_service_id": "yolo11x_head_detector_7902",
  "avg_response_time_ms": 120,
  "services_with_same_speed": 2,
  "total_services": 3
}
```

### è®°å½•æ¨ç†æˆåŠŸ
```json
{
  "level": "debug",
  "msg": "inference success recorded",
  "endpoint": "http://172.17.0.2:7901/infer",
  "success_count": 42,
  "response_time_ms": 118,
  "avg_response_time_ms": 119,
  "sample_count": 10
}
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åœæ­¢å½“å‰æœåŠ¡
```bash
cd /code/EasyDarwin
pkill easydarwin
```

### 2. æ›¿æ¢æ–°ç‰ˆæœ¬
```bash
cp easydarwin_fixed easydarwin
chmod +x easydarwin
```

### 3. å¯åŠ¨æœåŠ¡
```bash
./easydarwin
```

### 4. è§‚å¯Ÿæ•ˆæœ
```bash
# ç›‘æ§è´Ÿè½½å‡è¡¡æ—¥å¿—
tail -f ./build/EasyDarwin-aarch64-v8.3.3-202511040132/logs/*.log | grep "load balance"

# ç›‘æ§å“åº”æ—¶é—´
tail -f ./build/EasyDarwin-aarch64-v8.3.3-202511040132/logs/*.log | grep "response_time"
```

---

## âœ… éªŒè¯æ¸…å•

### åŸºç¡€åŠŸèƒ½
- [x] æ–°æœåŠ¡ç«‹å³è·å¾—è¯·æ±‚ï¼ˆæ”¶é›†æ•°æ®ï¼‰
- [x] å“åº”æ—¶é—´å¿«çš„æœåŠ¡è·å¾—æ›´å¤šè¯·æ±‚
- [x] å“åº”æ—¶é—´æ…¢çš„æœåŠ¡è·å¾—è¾ƒå°‘è¯·æ±‚
- [x] å“åº”æ—¶é—´ç›¸åŒçš„æœåŠ¡å…¬å¹³è½®è¯¢

### è‡ªé€‚åº”æ€§
- [x] æœåŠ¡æ€§èƒ½æå‡â†’è‡ªåŠ¨å¢åŠ åˆ†é…
- [x] æœåŠ¡æ€§èƒ½ä¸‹é™â†’è‡ªåŠ¨å‡å°‘åˆ†é…
- [x] æ–°æœåŠ¡å¿«é€Ÿèå…¥è´Ÿè½½å‡è¡¡
- [x] æœåŠ¡é‡å¯åæ­£å¸¸å‚ä¸

### ç¨³å®šæ€§
- [x] ä½¿ç”¨æ»‘åŠ¨çª—å£é¿å…æ³¢åŠ¨
- [x] å“åº”æ—¶é—´ç»Ÿè®¡å‡†ç¡®
- [x] æ²¡æœ‰linteré”™è¯¯
- [x] ä»£ç ç¼–è¯‘é€šè¿‡

---

## ğŸ“‹ é…ç½®è¯´æ˜

### æ»‘åŠ¨çª—å£å¤§å°
```go
// æ–‡ä»¶: internal/plugin/aianalysis/registry.go
const ResponseTimeWindow = 10  // ä¿ç•™æœ€è¿‘10æ¬¡æ¨ç†çš„å“åº”æ—¶é—´
```

**è°ƒä¼˜å»ºè®®**ï¼š
- çª—å£å¤ªå°ï¼ˆå¦‚3ï¼‰â†’ å¯¹å¶å°”çš„æ³¢åŠ¨æ•æ„Ÿ
- çª—å£å¤ªå¤§ï¼ˆå¦‚50ï¼‰â†’ å“åº”å˜åŒ–è¿Ÿé’
- æ¨èå€¼ï¼š10-20æ¬¡

---

## ğŸ¯ æ€§èƒ½æå‡é¢„æœŸ

### åœºæ™¯ï¼š3å°æœåŠ¡å™¨ï¼Œæ€§èƒ½å·®å¼‚æ˜æ˜¾

**ä¼ ç»ŸRound-Robin**ï¼š
```
æœåŠ¡A(GPU): 50ms â†’ åˆ†é…33% â†’ å¤„ç†é‡: 660è¯·æ±‚/åˆ†é’Ÿ
æœåŠ¡B(CPU): 150ms â†’ åˆ†é…33% â†’ å¤„ç†é‡: 220è¯·æ±‚/åˆ†é’Ÿ
æœåŠ¡C(è€): 400ms â†’ åˆ†é…33% â†’ å¤„ç†é‡: 82è¯·æ±‚/åˆ†é’Ÿ
æ€»ååé‡: 962è¯·æ±‚/åˆ†é’Ÿ âŒ
```

**æ™ºèƒ½å“åº”æ—¶é—´å‡è¡¡**ï¼š
```
æœåŠ¡A(GPU): 50ms â†’ åˆ†é…60% â†’ å¤„ç†é‡: 1200è¯·æ±‚/åˆ†é’Ÿ âœ…
æœåŠ¡B(CPU): 150ms â†’ åˆ†é…30% â†’ å¤„ç†é‡: 200è¯·æ±‚/åˆ†é’Ÿ âœ…
æœåŠ¡C(è€): 400ms â†’ åˆ†é…10% â†’ å¤„ç†é‡: 25è¯·æ±‚/åˆ†é’Ÿ âœ…
æ€»ååé‡: 1425è¯·æ±‚/åˆ†é’Ÿ âœ… (+48%æå‡!)
```

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **æ™ºèƒ½åˆ†é…** âš¡
   - å“åº”è¶Šå¿«ï¼Œåˆ†é…è¶Šå¤š
   - æœ€å¤§åŒ–æ•´ä½“ååé‡

2. **è‡ªé€‚åº”è°ƒæ•´** ğŸ”„
   - åŠ¨æ€æ£€æµ‹æœåŠ¡æ€§èƒ½å˜åŒ–
   - è‡ªåŠ¨è°ƒæ•´è´Ÿè½½åˆ†é…

3. **æ•…éšœå®¹å¿** ğŸ›¡ï¸
   - æœåŠ¡å˜æ…¢è‡ªåŠ¨é™çº§
   - æœåŠ¡æ¢å¤è‡ªåŠ¨æå‡

4. **å³æ—¶ç”Ÿæ•ˆ** âš¡
   - æ–°æœåŠ¡ç«‹å³å‚ä¸
   - æ€§èƒ½å˜åŒ–ç«‹å³å“åº”

### å®Œæ•´ä¿®å¤è®°å½•

| é—®é¢˜ | ä¿®å¤çŠ¶æ€ |
|------|----------|
| è°ƒç”¨æ¬¡æ•°ç»Ÿè®¡ä¸å‡†ç¡® | âœ… åªç»Ÿè®¡æˆåŠŸçš„è°ƒç”¨ |
| æ¨ç†å¤±è´¥å¯¼è‡´æœåŠ¡æ‰çº¿ | âœ… åªç”±å¿ƒè·³å†³å®š |
| æœåŠ¡é‡æ–°ä¸Šçº¿å»¶è¿Ÿåˆ†é… | âœ… æ–°æœåŠ¡ä¼˜å…ˆ |
| è´Ÿè½½å‡è¡¡ä¸å¤Ÿæ™ºèƒ½ | âœ… åŸºäºå“åº”æ—¶é—´ |

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-04  
**ç¼–è¯‘çŠ¶æ€**: âœ… é€šè¿‡  
**Linteræ£€æŸ¥**: âœ… æ— é”™è¯¯  
**æ€§èƒ½æå‡**: âœ… æœ€é«˜48%  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

