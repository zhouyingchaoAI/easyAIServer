# 绊线人数统计算法注册失败原因分析

## 分析时间
2025-01-XX

## 问题描述
绊线人数统计算法服务无法成功注册到EasyDarwin系统。

## 代码分析

### 1. 注册API验证逻辑

根据 `internal/plugin/aianalysis/registry.go` 中的 `Register` 方法（第67-128行），注册时只进行以下验证：

```go
func (r *AlgorithmRegistry) Register(service conf.AlgorithmService) error {
	if service.ServiceID == "" || service.Endpoint == "" {
		return fmt.Errorf("service_id and endpoint required")
	}
	if len(service.TaskTypes) == 0 {
		return fmt.Errorf("task_types required")
	}
	// ... 注册逻辑
}
```

**关键发现**：
- ✅ 代码中**没有对任务类型进行白名单验证**
- ✅ 只要 `task_types` 数组不为空，就可以注册
- ✅ `"绊线人数统计"` 任务类型在 `configs/config.toml` 中已配置（第197行）

### 2. 配置检查

**配置文件位置**：`configs/config.toml`

```toml
task_types = ['人数统计', '绊线人数统计', '人员跌倒', '人员离岗', '吸烟检测', '区域入侵', '徘徊检测', '物品遗留', '安全帽检测']
```

**结论**：`绊线人数统计` 已在配置文件中，理论上应该可以注册。

## 可能的原因

### 原因1：HTTP路由未正确注册 ⚠️

**问题**：虽然注册逻辑存在，但可能HTTP路由处理函数未正确注册到Gin路由器。

**检查方法**：
```bash
# 查看日志中是否有路由注册信息
grep -i "router\|route\|register.*handler" /path/to/logs

# 或者直接测试API
curl -X POST http://localhost:5066/api/v1/ai_analysis/register \
  -H "Content-Type: application/json" \
  -d '{
    "service_id": "tripwire_test",
    "name": "绊线人数统计测试",
    "task_types": ["绊线人数统计"],
    "endpoint": "http://localhost:8000/infer",
    "version": "1.0.0"
  }'
```

### 原因2：服务未启动或插件未启用 ⚠️

**检查点**：
1. AI分析插件是否启用（`ai_analysis.enable = true`）
2. 服务是否正常启动（查看启动日志）
3. 注册中心是否初始化（`registry.StartHeartbeatChecker()`）

**检查方法**：
```bash
# 查看服务状态
curl http://localhost:5066/api/v1/ai_analysis/services

# 查看日志
grep -i "AI analysis\|algorithm.*service\|registry" /path/to/logs
```

### 原因3：网络连接问题 ⚠️

**问题**：算法服务无法连接到EasyDarwin的注册API。

**检查方法**：
```bash
# 从算法服务端测试连接
curl -v http://easydarwin-host:5066/api/v1/ai_analysis/register

# 检查防火墙和网络配置
netstat -tuln | grep 5066
```

### 原因4：请求格式错误 ⚠️

**问题**：注册请求的JSON格式不正确。

**正确的请求格式**：
```json
{
  "service_id": "tripwire_service_001",
  "name": "绊线人数统计服务",
  "task_types": ["绊线人数统计", "人数统计"],
  "endpoint": "http://192.168.1.100:8000/infer",
  "version": "1.0.0"
}
```

**常见错误**：
- ❌ `task_types` 为空数组
- ❌ `service_id` 或 `endpoint` 为空
- ❌ Content-Type 不是 `application/json`
- ❌ JSON格式错误（缺少引号、逗号等）

### 原因5：任务类型名称不匹配 ⚠️

**问题**：虽然代码不验证任务类型，但如果前端或其他组件有验证，可能导致问题。

**检查方法**：
```bash
# 确认配置中的任务类型名称
grep "绊线人数统计" configs/config.toml

# 确认注册请求中的任务类型名称完全一致（包括空格、大小写）
```

### 原因6：HTTP Handler未找到 ⚠️

**问题**：虽然注册逻辑存在，但HTTP handler可能未正确注册到路由。

**需要检查**：
- HTTP路由注册代码位置（可能在 `cmd/server/wire.go` 或其他路由注册文件中）
- 确认 `/api/v1/ai_analysis/register` 路由已注册

## 排查步骤

### 步骤1：检查服务状态

```bash
# 1. 检查AI分析服务是否启动
curl http://localhost:5066/api/v1/ai_analysis/services

# 2. 查看服务日志
tail -f /path/to/easydarwin.log | grep -i "ai_analysis\|register"
```

### 步骤2：测试注册API

```bash
# 使用curl直接测试注册API
curl -X POST http://localhost:5066/api/v1/ai_analysis/register \
  -H "Content-Type: application/json" \
  -d '{
    "service_id": "tripwire_test_001",
    "name": "绊线人数统计测试服务",
    "task_types": ["绊线人数统计"],
    "endpoint": "http://localhost:8000/infer",
    "version": "1.0.0"
  }' \
  -v
```

**预期响应**：
```json
{
  "ok": true,
  "service_id": "tripwire_test_001"
}
```

**如果返回404**：说明路由未注册
**如果返回400**：说明请求格式错误
**如果返回500**：说明服务器内部错误

### 步骤3：查看详细日志

```bash
# 查看注册相关的日志
grep -i "register\|algorithm.*service" /path/to/logs | tail -50

# 查看错误日志
grep -i "error\|fail\|注册失败" /path/to/logs | grep -i "绊线\|tripwire" | tail -50
```

### 步骤4：检查配置

```bash
# 检查AI分析插件配置
grep -A 10 "\[ai_analysis\]" configs/config.toml

# 检查任务类型配置
grep "task_types" configs/config.toml
```

## 日志分析要点

查看日志时，重点关注以下信息：

1. **注册成功日志**：
   ```
   algorithm service registered successfully
   service_id=xxx
   task_types=[绊线人数统计]
   ```

2. **注册失败日志**：
   ```
   service_id and endpoint required
   task_types required
   ```

3. **路由相关日志**：
   ```
   router registered
   handler registered
   ```

4. **服务启动日志**：
   ```
   AI analysis plugin started successfully
   algorithm service heartbeat checker started
   ```

## 解决方案

### 方案1：确认HTTP路由已注册

如果路由未注册，需要找到路由注册代码并添加：

```go
// 在路由注册文件中添加
router.POST("/api/v1/ai_analysis/register", HandleRegister)
router.POST("/api/v1/ai_analysis/heartbeat/:service_id", HandleHeartbeat)
router.GET("/api/v1/ai_analysis/services", HandleListServices)
```

### 方案2：检查服务启动顺序

确保AI分析服务在HTTP服务器启动之前初始化：

```go
// 1. 先启动AI分析服务
ai := aianalysis.NewService(...)
ai.Start()
aianalysis.SetGlobal(ai)

// 2. 再启动HTTP服务器
svcServer.Start()
```

### 方案3：验证请求格式

确保注册请求的JSON格式完全正确，特别是：
- `task_types` 必须是数组：`["绊线人数统计"]`
- 所有必填字段都存在
- Content-Type 设置为 `application/json`

### 方案4：检查网络连接

从算法服务端测试到EasyDarwin的连接：

```bash
# 测试连接
telnet easydarwin-host 5066

# 测试HTTP
curl -v http://easydarwin-host:5066/api/v1/ai_analysis/services
```

## 代码位置参考

- **注册逻辑**：`internal/plugin/aianalysis/registry.go:67`
- **服务启动**：`internal/plugin/aianalysis/service.go:49`
- **配置定义**：`configs/config.toml:197`
- **示例代码**：`examples/algorithm_service_example.py:36-41`

## 建议

1. **首先检查日志**：查看EasyDarwin服务日志，确认是否有注册请求到达
2. **测试API**：使用curl直接测试注册API，确认路由是否可用
3. **检查配置**：确认AI分析插件已启用，任务类型已配置
4. **验证网络**：确认算法服务可以访问EasyDarwin的HTTP端口
5. **查看错误响应**：如果API返回错误，根据错误信息定位问题

## 相关文件

- `internal/plugin/aianalysis/registry.go` - 注册中心实现
- `internal/plugin/aianalysis/service.go` - 服务启动逻辑
- `configs/config.toml` - 配置文件
- `examples/algorithm_service_example.py` - 示例代码

