# 🎯 EasyDarwin算法服务对接 - 完整文档包

**交付时间**: 2025-10-20  
**适用对象**: AI算法开发者、第三方服务提供商

---

## 📦 文档清单

为您准备了完整的对接文档，从快速上手到深入实现，应有尽有。

### 🚀 入门文档（必读）

#### 1. **ALGORITHM_INTEGRATION_README.md** ⭐⭐⭐
**总览文档，从这里开始！**

内容：
- 📚 文档导航
- 🎯 核心概念
- 📋 必须实现的接口
- 💻 快速开始
- ✅ 对接检查清单

**阅读时间**: 10分钟  
**适合**: 所有开发者

---

#### 2. **ALGORITHM_INTEGRATION_QUICK_REFERENCE.md** ⭐⭐⭐
**快速参考卡片，随时查阅！**

内容：
- 📋 API速查表
- 📥 请求格式
- 📤 响应格式
- 💻 最小实现
- 🐛 故障排查

**阅读时间**: 5分钟  
**适合**: 快速上手

---

### 📖 详细文档

#### 3. **ALGORITHM_SERVICE_INTEGRATION_GUIDE.md** ⭐⭐
**完整对接指南，深入学习！**

内容：
- 系统架构详解
- 完整的API说明
- 多语言示例（Python、Go）
- 配置文件格式详解
- 调试指南
- 性能优化建议

**阅读时间**: 30-60分钟  
**适合**: 深入对接

---

### 💻 代码示例

#### 4. **algorithm_service_example.py** ⭐⭐⭐
**可直接运行的Python示例！**

功能：
- ✅ 完整的服务注册
- ✅ 自动心跳保持
- ✅ 推理接口实现
- ✅ Mock算法示例
- ✅ 详细的注释说明

**使用方法**:
```bash
# 1. 安装依赖
pip install flask requests opencv-python numpy

# 2. 修改配置（文件中的配置区域）

# 3. 运行
python algorithm_service_example.py

# 4. 查看输出
# ✅ 服务注册成功!
# 🚀 算法服务已启动
```

---

### 📐 规范文档

#### 5. **API_SPECIFICATION.json**
**OpenAPI 3.0规范文件**

内容：
- 完整的API定义
- 请求/响应Schema
- 参数说明
- 示例数据

**用途**:
- 导入到Postman/Swagger测试
- 自动生成客户端代码
- API文档生成

---

### 🎓 功能说明文档

#### 6. **TRIPWIRE_COUNTING_ALGORITHM.md**
**绊线人数统计算法说明**

内容：
- 算法原理
- 应用场景
- 配置方法
- 数据格式

#### 7. **LINE_DIRECTION_PERPENDICULAR_ARROWS.md**
**线条方向配置说明**

内容：
- 方向概念（进入/离开/进出）
- 垂直箭头设计
- 配置示例
- 使用技巧

#### 8. **INFERENCE_CONFIG_URL_FEATURE.md**
**配置文件URL功能**

内容：
- 配置URL用途
- 获取方式
- 使用建议
- 安全考虑

---

## 🗺️ 阅读路线图

### 路线1: 快速对接（推荐）

```
开始
  ↓
ALGORITHM_INTEGRATION_README.md (10分钟)
  ↓
ALGORITHM_INTEGRATION_QUICK_REFERENCE.md (5分钟)
  ↓
algorithm_service_example.py (运行测试)
  ↓
根据需要查阅详细文档
  ↓
完成对接
```

### 路线2: 深入学习

```
开始
  ↓
ALGORITHM_INTEGRATION_README.md
  ↓
ALGORITHM_SERVICE_INTEGRATION_GUIDE.md (完整阅读)
  ↓
TRIPWIRE_COUNTING_ALGORITHM.md
  ↓
LINE_DIRECTION_PERPENDICULAR_ARROWS.md
  ↓
INFERENCE_CONFIG_URL_FEATURE.md
  ↓
algorithm_service_example.py (修改实现)
  ↓
完成对接并优化
```

### 路线3: 问题解决

```
遇到问题
  ↓
ALGORITHM_INTEGRATION_QUICK_REFERENCE.md (查故障排查)
  ↓
ALGORITHM_SERVICE_INTEGRATION_GUIDE.md (查调试指南)
  ↓
查看示例代码对比
  ↓
问题解决
```

---

## 🎯 核心要点提炼

### 1. 注册服务（启动时）

```http
POST http://10.1.6.230:5066/api/v1/ai_analysis/register

{
  "service_id": "your_unique_id",
  "name": "服务名称",
  "task_types": ["绊线人数统计"],
  "endpoint": "http://your-ip:8000/infer",
  "version": "1.0.0"
}
```

### 2. 实现推理接口

```python
@app.route('/infer', methods=['POST'])
def infer():
    data = request.json
    
    # 下载图片
    image = download_image(data['image_url'])
    
    # 获取配置
    config = data.get('algo_config', {})
    
    # 执行推理
    result = your_algorithm(image, config)
    
    # 返回结果
    return {
        "success": True,
        "result": result,
        "confidence": 0.9,
        "inference_time_ms": 100
    }
```

### 3. 发送心跳（每45秒）

```python
while True:
    time.sleep(45)
    requests.post(
        f"http://10.1.6.230:5066/api/v1/ai_analysis/heartbeat/{service_id}"
    )
```

---

## 📊 推理请求示例

### 您会收到的完整请求

```json
{
  "image_url": "http://10.1.6.230:9000/images/绊线人数统计/公司入口统计/20251020-094708.979.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=admin%2F20251020%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20251020T014708Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Signature=...",
  "task_id": "公司入口统计",
  "task_type": "绊线人数统计",
  "image_path": "绊线人数统计/公司入口统计/20251020-094708.979.jpg",
  "algo_config": {
    "task_id": "公司入口统计",
    "task_type": "绊线人数统计",
    "config_version": "1.0",
    "regions": [
      {
        "id": "region_1729411234567",
        "name": "入口检测线",
        "type": "line",
        "enabled": true,
        "points": [[100, 300], [700, 300]],
        "properties": {
          "direction": "in",
          "color": "#00FF00",
          "thickness": 3
        }
      }
    ],
    "algorithm_params": {
      "confidence_threshold": 0.7,
      "iou_threshold": 0.5
    }
  },
  "algo_config_url": "http://10.1.6.230:9000/images/绊线人数统计/公司入口统计/algo_config.json?X-Amz-Algorithm=AWS4-HMAC-SHA256&..."
}
```

### 关键信息提取

```python
# 图片URL（直接下载）
image_url = data['image_url']

# 检测线配置
regions = data['algo_config']['regions']
lines = [r for r in regions if r['type'] == 'line']

# 第一条线的配置
line = lines[0]
direction = line['properties']['direction']  # "in"|"out"|"in_out"
points = line['points']  # [[x1, y1], [x2, y2]]

# 算法参数
params = data['algo_config']['algorithm_params']
conf_threshold = params['confidence_threshold']  # 0.7
```

---

## ✅ 对接检查表

### 开发前检查

```
□ 已阅读 ALGORITHM_INTEGRATION_README.md
□ 已下载 algorithm_service_example.py
□ Python环境已准备（3.7+）
□ 依赖库已安装
□ 了解推理请求格式
```

### 开发中检查

```
□ 推理接口已实现
□ 能正确下载图片
□ 能解析algo_config
□ 返回格式正确
□ 本地测试通过
```

### 集成前检查

```
□ EasyDarwin已运行
□ 网络连通性测试
□ 端口未被占用
□ 配置信息正确
```

### 集成后验证

```
□ 服务注册成功
□ 心跳正常发送
□ 能收到推理请求
□ 图片能正常下载
□ 配置能正确解析
□ 推理结果正确
□ 告警正常生成
```

---

## 🔗 重要链接

### 核心文档（优先级从高到低）

1. **ALGORITHM_INTEGRATION_README.md** - 从这里开始
2. **ALGORITHM_INTEGRATION_QUICK_REFERENCE.md** - 速查手册
3. **algorithm_service_example.py** - 示例代码
4. **ALGORITHM_SERVICE_INTEGRATION_GUIDE.md** - 深入学习

### 功能文档

- TRIPWIRE_COUNTING_ALGORITHM.md - 绊线统计说明
- LINE_DIRECTION_PERPENDICULAR_ARROWS.md - 方向配置
- INFERENCE_CONFIG_URL_FEATURE.md - 配置URL

### 规范文档

- API_SPECIFICATION.json - OpenAPI规范

---

## 💡 快速测试

### 1分钟快速测试

```bash
# 测试EasyDarwin是否可访问
curl http://10.1.6.230:5066/api/v1/ai_analysis/services

# 预期：返回已注册服务列表（可能为空）
```

### 5分钟注册测试

```bash
# 1. 创建测试注册请求
cat > register.json << 'EOF'
{
  "service_id": "test_service_001",
  "name": "测试服务",
  "task_types": ["绊线人数统计"],
  "endpoint": "http://192.168.1.100:8000/infer",
  "version": "1.0.0"
}
EOF

# 2. 发送注册请求
curl -X POST http://10.1.6.230:5066/api/v1/ai_analysis/register \
  -H "Content-Type: application/json" \
  -d @register.json

# 3. 验证注册结果
curl http://10.1.6.230:5066/api/v1/ai_analysis/services | jq
```

### 10分钟完整测试

```bash
# 1. 运行示例代码
python algorithm_service_example.py

# 2. 在EasyDarwin前端创建任务
#    - 任务类型: 绊线人数统计
#    - 配置检测线
#    - 启动任务

# 3. 观察算法服务日志
#    应该看到推理请求
```

---

## 🎓 推荐学习顺序

### 第1天: 基础对接（2-4小时）

```
上午:
✅ 阅读 ALGORITHM_INTEGRATION_README.md
✅ 阅读 ALGORITHM_INTEGRATION_QUICK_REFERENCE.md
✅ 运行 algorithm_service_example.py

下午:
✅ 测试服务注册
✅ 测试心跳机制
✅ 验证能收到推理请求
```

### 第2天: 算法实现（4-8小时）

```
上午:
✅ 阅读 TRIPWIRE_COUNTING_ALGORITHM.md
✅ 阅读 LINE_DIRECTION_PERPENDICULAR_ARROWS.md
✅ 理解配置文件格式

下午:
✅ 实现人员检测
✅ 解析检测线配置
✅ 返回检测结果
```

### 第3天: 完善和优化（4-8小时）

```
上午:
✅ 实现轨迹跟踪
✅ 实现绊线判断
✅ 完整功能测试

下午:
✅ 性能优化
✅ 错误处理
✅ 日志完善
```

---

## 📞 技术支持

### 自助排查

```
1. 查看 ALGORITHM_INTEGRATION_QUICK_REFERENCE.md 的故障排查章节
2. 对照示例代码检查实现
3. 查看EasyDarwin日志和您的服务日志
4. 测试各个接口是否正常
```

### 获取帮助

```
GitHub Issues: 
  https://github.com/EasyDarwin/EasyDarwin/issues

提问时请提供:
  - 问题描述
  - 错误日志
  - 请求响应示例
  - 环境信息（OS、Python版本等）
```

---

## 🎉 开始对接

### 推荐流程

```
步骤1: 阅读 ALGORITHM_INTEGRATION_README.md
  ↓
步骤2: 运行 algorithm_service_example.py 验证环境
  ↓
步骤3: 在示例代码基础上实现您的算法
  ↓
步骤4: 测试和调试
  ↓
步骤5: 部署到生产环境
```

### 需要准备的信息

```
□ EasyDarwin访问地址（如: http://10.1.6.230:5066）
□ 您的服务器IP和端口（如: http://192.168.1.100:8000）
□ 支持的任务类型（如: ["绊线人数统计"]）
□ 服务版本号（如: "1.0.0"）
```

---

## 📋 文档对照表

| 需求 | 推荐文档 |
|------|---------|
| 快速了解对接流程 | ALGORITHM_INTEGRATION_README.md |
| 查询API格式 | ALGORITHM_INTEGRATION_QUICK_REFERENCE.md |
| 深入学习接口 | ALGORITHM_SERVICE_INTEGRATION_GUIDE.md |
| 运行测试代码 | algorithm_service_example.py |
| 了解绊线算法 | TRIPWIRE_COUNTING_ALGORITHM.md |
| 理解方向配置 | LINE_DIRECTION_PERPENDICULAR_ARROWS.md |
| 配置文件说明 | INFERENCE_CONFIG_URL_FEATURE.md |
| API规范查询 | API_SPECIFICATION.json |

---

## 🎯 核心API总结

### EasyDarwin提供的API（您需要调用）

| API | 方法 | 用途 | 频率 |
|-----|------|------|------|
| `/ai_analysis/register` | POST | 注册服务 | 启动时1次 |
| `/ai_analysis/heartbeat/{id}` | POST | 发送心跳 | 每45秒 |
| `/ai_analysis/unregister/{id}` | DELETE | 注销服务 | 停止时1次 |
| `/ai_analysis/services` | GET | 查询服务 | 按需 |

### 您需要实现的API

| API | 方法 | 用途 | 调用方 |
|-----|------|------|--------|
| `/infer` | POST | 推理接口 | EasyDarwin |
| `/health` | GET | 健康检查 | 可选 |

---

## 📦 交付内容检查

本文档包已为您准备：

✅ **入门文档** (2份)
- ALGORITHM_INTEGRATION_README.md
- ALGORITHM_INTEGRATION_QUICK_REFERENCE.md

✅ **详细指南** (1份)
- ALGORITHM_SERVICE_INTEGRATION_GUIDE.md

✅ **示例代码** (1份)
- algorithm_service_example.py（可直接运行）

✅ **规范文档** (1份)
- API_SPECIFICATION.json

✅ **功能说明** (3份)
- TRIPWIRE_COUNTING_ALGORITHM.md
- LINE_DIRECTION_PERPENDICULAR_ARROWS.md
- INFERENCE_CONFIG_URL_FEATURE.md

✅ **总览文档** (2份)
- 算法对接文档包.md（本文档）
- ALL_FEATURES_SUMMARY.md

**总计**: 11份文档 + 1份可运行代码

---

## 🚀 立即开始

**3步快速启动**:

```bash
# 步骤1: 安装依赖
pip install flask requests opencv-python numpy

# 步骤2: 运行示例
python algorithm_service_example.py

# 步骤3: 验证
# 看到 "✅ 服务注册成功!" 即完成基础对接
```

**接下来**:
- 在EasyDarwin创建测试任务
- 配置检测线
- 观察推理请求日志
- 逐步实现真实算法

---

## 📝 文档版本

| 文档 | 版本 | 状态 |
|------|------|------|
| 所有文档 | v1.0 | ✅ 完整 |
| 示例代码 | v1.0 | ✅ 可运行 |
| API规范 | v1.0 | ✅ 完整 |

---

## 💬 反馈与建议

### 文档改进

如果您在使用过程中发现：
- 文档不清晰的地方
- 缺失的内容
- 错误或过时的信息

欢迎提出反馈，帮助我们改进文档！

### 功能建议

对系统功能有建议？欢迎提出：
- 新的算法类型需求
- API接口改进
- 性能优化建议
- 易用性改进

---

**祝您对接顺利！** 🎉

有任何问题，请查阅相应文档或联系技术支持。

---

**文档包版本**: v1.0  
**发布日期**: 2025-10-20  
**维护团队**: EasyDarwin Team  
**状态**: ✅ 完整可用



